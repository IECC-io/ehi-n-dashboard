<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHRAM: System for Heat Risk Assessment for Manual labor</title>

    <!-- Google Analytics (supports multiple accounts) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZRLEJEW2N"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        // Primary Google Analytics account
        gtag('config', 'G-FZRLEJEW2N');
        // Secondary Google Analytics account
        gtag('config', 'G-3J6EVWWDBX');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Intro.js for onboarding tour -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/minified/introjs.min.css">
    <script src="https://cdn.jsdelivr.net/npm/intro.js@7.2.0/intro.min.js"></script>

    <!-- Montserrat Font from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">

    <style>
        :root {
            --iecc-blue: #2d637f;
            --iecc-green: #9DAD33;
            --iecc-light-blue: #4a8dad;
            --iecc-dark-blue: #1a3d4f;
            --iecc-brown: #8B5A2B;
            --shram-teal: #006D77;
            --danger-red: #d32f2f;
            --warning-orange: #e65100;
            --caution-yellow: #c79100;
            --gray-light: #f5f5f5;
            --gray-medium: #e0e0e0;
            --gray-dark: #333;
            --shram-dark-orange: #C54B26;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--gray-dark);
            background: var(--gray-light);
        }

        .logo-strip {
            background: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .logo-strip-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-strip img {
            height: 50px;
            width: auto;
        }

        .logo-strip-text {
            font-size: 0.9rem;
            color: var(--gray-dark);
        }

        .logo-strip-text strong {
            color: var(--shram-teal);
            font-size: 1.1rem;
        }

        .header {
            background: var(--shram-dark-orange);
            color: white;
            padding: 1rem 0 0.5rem 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 200px;
            right: 0;
            bottom: 0;
            background-image: url('shram-map-dot.svg');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: auto 140%;
            opacity: 0.25;
            filter: brightness(2.5) saturate(0.2);
            pointer-events: none;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            position: relative;
            min-height: 200px;
        }

        .logo-container {
            position: absolute;
            left: 2rem;
            bottom: 0.25rem;
            height: 180px;
            overflow: hidden;
        }

        .logo-container img {
            height: 180px;
            width: auto;
        }

        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; font-weight: 700; }
        .header .credit { font-size: 0.95rem; opacity: 0.85; font-style: italic; margin-bottom: 2rem; }

        .tabs {
            display: flex;
            gap: 0;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
            margin-left: auto;
            margin-right: 0;
            align-self: flex-end;
            margin-bottom: -0.5rem;
        }

        .tab {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            color: rgba(255, 255, 255, 0.9);
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            position: relative;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.25);
            color: white;
        }

        .tab.active {
            background: white;
            color: var(--shram-teal);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            height: 10px;
            background: var(--shram-teal);
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; box-sizing: border-box; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .section {
            background: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--shram-teal);
            width: 100%;
            box-sizing: border-box;
        }

        h2 {
            color: var(--shram-teal);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-light);
            font-size: 1.4rem;
        }

        h3 {
            color: var(--shram-teal);
            margin: 1.5rem 0 1rem 0;
            font-size: 1.3rem;
        }

        /* Stacked Dashboard Layout - Current Status first, then Forecast */
        .dashboard-grid {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            margin-bottom: 2rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .dashboard-grid > .section {
            margin-bottom: 0;
            width: 100%;
        }

        /* Calculator */
        .calculator-container {
            background: var(--shram-teal);
            color: white;
            padding: 2.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(45, 99, 127, 0.3);
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .input-wrapper {
            display: flex;
            gap: 0.5rem;
        }

        .input-wrapper input {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.95);
            color: var(--gray-dark);
        }

        .input-wrapper select {
            padding: 0.75rem;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.95);
            color: var(--gray-dark);
            font-size: 1rem;
            cursor: pointer;
        }

        .input-group input:focus,
        .input-wrapper select:focus {
            outline: 2px solid var(--shram-teal);
        }

        .met-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .met-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .met-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: white;
        }

        .met-option.active {
            background: white;
            color: var(--shram-teal);
            border-color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .met-option i { font-size: 2rem; margin-bottom: 0.5rem; display: block; }
        .met-option .met-label { font-weight: 600; font-size: 0.95rem; }
        .met-option .met-desc { font-size: 0.8rem; opacity: 0.8; margin-top: 0.25rem; }

        .solar-option:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            border-color: white !important;
        }
        .solar-option.active:hover {
            background: white !important;
            border-color: white !important;
        }

        /* Blue MET dropdown for dashboard sections */
        .met-select-green {
            background: var(--shram-teal);
            color: white;
            border: 2px solid var(--shram-teal);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            padding-right: 2rem;
            vertical-align: middle;
            box-sizing: border-box;
        }
        .met-select-green:hover {
            background-color: var(--iecc-dark-blue);
        }
        .met-select-green option {
            background: white;
            color: #333;
        }

        /* Info tooltip for MET and shade/sun controls */
        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 0.3rem;
            vertical-align: middle;
        }
        .info-tooltip i {
            color: var(--shram-teal);
            font-size: 0.85rem;
            opacity: 0.7;
        }
        .info-tooltip:hover i {
            opacity: 1;
        }
        .info-tooltip .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            top: 100%;
            right: 0;
            left: auto;
            transform: none;
            margin-top: 10px;
            background: var(--gray-dark);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 400;
            width: 280px;
            text-align: left;
            z-index: 1200;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: opacity 0.2s, visibility 0.2s;
            line-height: 1.4;
        }
        .info-tooltip .tooltip-text::after {
            content: '';
            position: absolute;
            bottom: 100%;
            right: 10px;
            left: auto;
            transform: none;
            border: 6px solid transparent;
            border-bottom-color: var(--gray-dark);
        }
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Mobile touch: show tooltip on focus/active */
        @media (hover: none) and (pointer: coarse) {
            .info-tooltip .tooltip-text {
                /* On touch devices, tooltip shows when parent has .tooltip-active class */
            }
            .info-tooltip.tooltip-active .tooltip-text {
                visibility: visible;
                opacity: 1;
            }
            /* Hoverable stat boxes - show zone-tooltip on tap */
            .stat-box.hoverable.tooltip-active .zone-tooltip {
                display: block;
            }
        }

        .calculate-btn {
            background: white;
            color: var(--shram-teal);
            border: 2px solid var(--shram-teal);
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin-top: 1rem;
        }

        .calculate-btn:hover {
            background: var(--shram-dark-orange);
            color: white;
            border-color: var(--shram-dark-orange);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(197, 75, 38, 0.4);
        }

        .result-display {
            background: rgba(255, 255, 255, 0.95);
            color: var(--gray-dark);
            padding: 2rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            display: none;
        }

        .result-display.show { display: block; }
        .result-zone { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .result-value { font-size: 1.5rem; font-weight: 600; color: var(--shram-teal); margin-bottom: 1rem; }

        .zone-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .zone-badge {
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
            font-size: 0.9rem;
        }

        .zone-4-badge { background: #fffde7; border-color: #c79100; }
        .zone-5-badge { background: #fff3e0; border-color: #e65100; }
        .zone-6-badge { background: #ffebee; border-color: #d32f2f; }
        .zone-badge strong { display: block; margin-bottom: 0.25rem; }

        .status-overview { margin-bottom: 2rem; }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .stat-box {
            background: var(--shram-teal);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(45, 99, 127, 0.2);
            position: relative;
        }

        .stat-box.hoverable:hover .zone-tooltip {
            display: block;
        }

        .zone-tooltip {
            display: none;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: #333;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 250px;
            max-width: 350px;
            text-align: left;
            border: 2px solid currentColor;
        }

        .zone-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: white;
        }

        /* Tooltip variant that appears below the element */
        .zone-tooltip.tooltip-down {
            bottom: auto;
            top: 100%;
            margin-top: -1px;
        }

        .zone-tooltip.tooltip-down::after {
            top: auto;
            bottom: 100%;
            border-top-color: transparent;
            border-bottom-color: white;
        }

        .zone-tooltip h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            color: inherit;
        }

        .zone-tooltip p {
            margin: 0.5rem 0 0 0;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .zone-tooltip .districts-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #ddd;
            font-size: 0.8rem;
        }

        .zone-tooltip .learn-more-link {
            display: block;
            margin-top: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            color: var(--shram-teal);
            text-decoration: none;
            cursor: pointer;
        }

        .zone-tooltip .learn-more-link:hover {
            text-decoration: underline;
        }

        .stat-number { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.95rem; opacity: 0.9; }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            min-height: 350px;
        }

        .chart-container canvas {
            max-height: 400px;
            min-height: 250px;
        }

        /* Floating Zone 6 Alert Banner */
        .zone6-alert-banner {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            color: white;
            padding: 1rem 2rem;
            margin: 0.5rem 0 1rem 0;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(211, 47, 47, 0.4);
            animation: pulse 2s ease-in-out infinite;
            display: none;
            position: sticky;
            top: 0.5rem;
            z-index: 1100;  /* Higher than Leaflet map controls (1000) */
            max-height: 300px;
            overflow-y: auto;
            width: 100%;
            box-sizing: border-box;
        }

        .zone6-alert-banner.show {
            display: block;
        }

        .zone6-alert-banner .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 2rem;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .zone6-alert-banner .close-btn:hover {
            opacity: 1;
        }

        .zone6-alert-banner.minimized {
            padding: 0.75rem 2rem;
            cursor: pointer;
        }

        .zone6-alert-banner.minimized .close-btn {
            top: 50%;
            right: 2rem;
            transform: translateY(-50%);
        }

        .zone6-alert-banner.minimized #zone6-banner-content strong {
            display: none;
        }

        .zone6-alert-banner.minimized #zone6-banner-content span {
            display: none;
        }

        .zone6-alert-banner.minimized #zone6-banner-content br {
            display: none;
        }

        .zone6-alert-banner.minimized #zone6-banner-content .banner-static-text {
            display: inline-block !important;
            font-size: 1.1rem;
            font-weight: 700;
            margin-right: 1rem;
            vertical-align: middle;
        }

        .zone6-alert-banner.minimized #zone6-banner-content .banner-marquee-container {
            display: inline-block !important;
            width: calc(100% - 280px);
            vertical-align: middle;
        }

        .zone6-alert-banner.minimized #zone6-banner-content marquee {
            display: inline-block !important;
            margin: 0 !important;
            vertical-align: middle;
        }

        .banner-static-text {
            display: none;
        }

        .banner-marquee-container {
            display: none;
        }

        .banner-marquee-container marquee {
            display: block;
        }

        /* States list for expanded banner */
        .banner-states-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
            max-height: 120px;
            overflow: visible;
            padding-right: 0.5rem;
        }

        .banner-states-list::-webkit-scrollbar {
            width: 6px;
        }

        .banner-states-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .banner-states-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.4);
            border-radius: 3px;
        }

        .banner-state-item {
            background: rgba(255,255,255,0.15);
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
        }

        .banner-state-item:hover {
            background: rgba(255,255,255,0.3);
        }

        .banner-state-item .district-count {
            background: rgba(255,255,255,0.25);
            padding: 0.1rem 0.4rem;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 0.3rem;
        }

        /* Tooltip showing districts on hover */
        .banner-state-item .districts-tooltip {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            background: white;
            color: #333;
            padding: 0.6rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: normal;
            min-width: 180px;
            max-width: 280px;
            max-height: 180px;
            overflow-y: auto;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: opacity 0.2s, visibility 0.2s;
            pointer-events: none;
        }

        .banner-state-item .districts-tooltip::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 20px;
            border: 8px solid transparent;
            border-bottom-color: white;
        }

        .banner-state-item:hover .districts-tooltip,
        .banner-state-item.tooltip-active .districts-tooltip {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }

        .districts-tooltip .tooltip-title {
            font-weight: 700;
            margin-bottom: 0.3rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            padding-bottom: 0.3rem;
        }

        .districts-tooltip .district-name {
            padding: 0.15rem 0;
            white-space: normal;
        }

        .districts-tooltip::-webkit-scrollbar {
            width: 4px;
        }

        .districts-tooltip::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.2);
            border-radius: 2px;
        }

        /* When minimized, hide list and show marquee */
        .zone6-alert-banner.minimized .banner-states-list {
            display: none;
        }

        .zone6-alert-banner.minimized .banner-marquee-container {
            display: inline-block !important;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(211, 47, 47, 0.4); }
            50% { box-shadow: 0 4px 30px rgba(211, 47, 47, 0.7); }
        }

        /* API Modal Styles */
        .api-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow: auto;
        }

        .api-modal.show {
            display: block;
        }

        .api-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .api-modal-header {
            background: var(--shram-teal);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-modal-close {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.8;
        }

        .api-modal-close:hover {
            opacity: 1;
        }

        .api-modal-body {
            padding: 2rem;
        }

        .endpoint-grid { display: grid; gap: 1.5rem; margin-top: 1.5rem; }

        .endpoint-card {
            background: var(--gray-light);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--shram-teal);
        }

        .endpoint-card h4 { color: var(--shram-teal); margin-bottom: 1rem; }

        .endpoint {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            word-break: break-all;
        }

        .method-badge {
            display: inline-block;
            background: var(--shram-teal);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code { font-family: 'Courier New', monospace; }

        .alert-box {
            background: #fff3e0;
            border-left: 4px solid var(--warning-orange);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .success-box {
            background: #e8f5e9;
            border-left: 4px solid var(--shram-teal);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        /* Dropdown option styles for data availability */
        /* Note: Most browsers don't support styling <option> elements */
        /* We use disabled attribute for unavailable options instead */
        select option.available {
            font-weight: bold;
        }

        select option.unavailable,
        select option:disabled {
            color: #999;
            font-style: italic;
        }

        .footer {
            background: var(--shram-dark-orange);
            color: white;
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
        }

        .footer a { color: var(--shram-teal); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        /* Intro.js Custom Styling - SHRAM Branding */
        /* Main overlay - covers entire screen */
        .introjs-overlay {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            z-index: 999999 !important;
            background-color: rgba(0,0,0,0.8) !important;
        }
        /* Helper layer - creates the spotlight cutout around highlighted element */
        .introjs-helperLayer {
            position: absolute !important;
            z-index: 9999999 !important;
            border-radius: 4px !important;
            /* Large shadow creates the dark overlay with a hole for the element */
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.8) !important;
            background: transparent !important;
            /* NO border - just the spotlight effect */
            border: none !important;
        }
        .introjs-tooltipReferenceLayer {
            position: absolute !important;
            z-index: 10000000 !important;
        }
        .introjs-tooltip {
            position: absolute !important;
            z-index: 10000001 !important;
            background: white !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4) !important;
            max-width: 360px !important;
            min-width: 280px !important;
            font-family: 'Montserrat', sans-serif !important;
            opacity: 1 !important;
            visibility: visible !important;
            display: block !important;
            transform: none !important;
            border: none !important;
        }
        .introjs-fixedTooltip {
            position: fixed !important;
        }
        /* Ensure tooltip content is visible */
        .introjs-tooltip * {
            opacity: 1 !important;
            visibility: visible !important;
        }
        /* Remove any highlight borders */
        .introjs-helperLayer,
        .shram-highlight {
            border: none !important;
            outline: none !important;
        }
        .introjs-tooltip-header {
            padding: 15px 20px 0 20px;
        }
        .introjs-tooltip-title {
            color: var(--shram-teal);
            font-weight: 700;
            font-size: 1.1rem;
        }
        .introjs-tooltiptext {
            padding: 15px 20px;
            color: #333;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        .introjs-tooltipbuttons {
            border-top: 1px solid #eee;
            padding: 12px 20px;
        }
        .introjs-button {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            font-size: 0.85rem;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            text-shadow: none !important;
        }
        .introjs-prevbutton {
            background: #f5f5f5;
            color: #666;
        }
        .introjs-prevbutton:hover {
            background: #e0e0e0;
        }
        .introjs-nextbutton,
        .introjs-donebutton {
            background: var(--shram-teal);
            color: white;
        }
        .introjs-nextbutton:hover,
        .introjs-donebutton:hover {
            background: #005a63;
            color: white;
        }
        .introjs-skipbutton {
            color: #999;
            font-size: 0.8rem;
        }
        .introjs-skipbutton:hover {
            color: #666;
        }
        .introjs-bullets ul li a {
            background: #ddd;
        }
        .introjs-bullets ul li a.active {
            background: var(--shram-teal);
        }
        .introjs-arrow {
            border: 6px solid transparent;
        }
        .introjs-arrow.top {
            border-bottom-color: white;
        }
        .introjs-arrow.bottom {
            border-top-color: white;
        }
        .introjs-arrow.left {
            border-right-color: white;
        }
        .introjs-arrow.right {
            border-left-color: white;
        }
        /* Progress bar */
        .introjs-progress {
            background: #eee;
            height: 4px;
            border-radius: 2px;
            margin: 10px 20px 0 20px;
        }
        .introjs-progressbar {
            background: var(--shram-teal);
            border-radius: 2px;
        }
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .introjs-tooltip {
                max-width: 85vw;
                min-width: 260px;
            }
            .introjs-tooltiptext {
                font-size: 0.85rem;
                padding: 12px 15px;
            }
            .introjs-button {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
        }

        /* Tabs wrapper - positions tour button alongside tabs */
        .tabs-wrapper {
            position: relative;
            display: flex;
            flex-direction: row;
            align-items: flex-end;
        }

        /* Guide button - question mark icon inline with tabs (desktop) */
        .take-tour-btn.desktop-tour-btn {
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.6);
            padding: 0.75rem 1rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .take-tour-btn.desktop-tour-btn i {
            font-size: 1rem;
        }
        .take-tour-btn:hover {
            color: white;
        }

        /* Mobile tour button - hidden on desktop */
        .take-tour-btn.mobile-tour-btn {
            display: none;
        }

        /* Mobile hamburger menu button - hidden on desktop */
        .hamburger-btn {
            display: none;
        }

        /* Mobile menu container - hidden on desktop */
        .mobile-menu {
            display: none;
        }

        @media (max-width: 768px) {
            /* Hide tour button on mobile - keep tabs */
            .take-tour-btn {
                display: none;
            }
        }

        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .forecast-table th,
        .forecast-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-medium);
        }

        .forecast-table th {
            background: var(--shram-teal);
            color: white;
            font-weight: 600;
        }

        .forecast-table tr:hover { background: var(--gray-light); }

        /* District map tooltip */
        .district-tooltip {
            background: white;
            border: 2px solid var(--shram-teal);
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: 600;
            color: var(--shram-teal);
        }

        #district-map {
            background: #f5f5f5;
        }

        /* Multi-select hints - show desktop by default, hide mobile */
        .multi-select-hint .mobile-hint {
            display: none;
        }

        @media (max-width: 768px) {
            /* Show mobile hint, hide desktop hint */
            .multi-select-hint .desktop-hint {
                display: none;
            }
            .multi-select-hint .mobile-hint {
                display: inline;
            }
            .header {
                padding: 0.5rem 0.5rem 0;
            }
            .header-content {
                flex-direction: column;
                align-items: stretch;
                min-height: auto;
                padding: 0;
                gap: 0;
            }

            /* Show India dot map on mobile - centered */
            .header::before {
                display: block;
                left: 0;
                right: 0;
                background-position: center center;
                background-size: auto 100%;
                opacity: 0.2;
            }

            /* Mobile SHRAM logo - left aligned, fixed height, no overlap */
            .logo-container {
                position: relative;
                left: 0;
                bottom: 0;
                height: auto;
                width: 100%;
                text-align: left;
                margin-bottom: 0.5rem;
                padding-left: 0;
                flex-shrink: 0;
            }
            .logo-container img {
                height: 120px;
                width: auto;
                display: block;
            }

            /* Mobile tabs - compact row, no overlap with logo */
            .tabs-wrapper {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
                flex-shrink: 0;
            }
            /* Hide desktop tour button on mobile */
            .take-tour-btn.desktop-tour-btn {
                display: none !important;
            }
            /* Mobile hamburger button - top right of orange banner */
            .hamburger-btn {
                display: flex !important;
                position: absolute;
                top: 8px;
                right: 8px;
                padding: 0.5rem;
                font-size: 1.5rem;
                background: transparent;
                border: none;
                color: rgba(255,255,255,0.9);
                cursor: pointer;
                z-index: 20;
                flex-direction: column;
                gap: 4px;
            }
            .hamburger-btn span {
                display: block;
                width: 22px;
                height: 2px;
                background: white;
                transition: all 0.3s ease;
            }
            .hamburger-btn.open span:nth-child(1) {
                transform: rotate(45deg) translate(4px, 4px);
            }
            .hamburger-btn.open span:nth-child(2) {
                opacity: 0;
            }
            .hamburger-btn.open span:nth-child(3) {
                transform: rotate(-45deg) translate(4px, -4px);
            }

            /* Mobile tour button - below hamburger */
            .take-tour-btn.mobile-tour-btn {
                display: flex !important;
                position: absolute;
                top: 44px;
                right: 8px;
                padding: 0.5rem;
                font-size: 1.1rem;
                background: transparent;
                border: none;
                color: rgba(255,255,255,0.8);
                cursor: pointer;
                z-index: 20;
            }
            .take-tour-btn.mobile-tour-btn:hover {
                color: white;
            }

            /* Mobile dropdown menu */
            .mobile-menu {
                display: none !important;
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--shram-dark-orange);
                z-index: 100;
                box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            }
            .mobile-menu.open {
                display: block !important;
            }
            .mobile-menu-item {
                display: block;
                width: 100%;
                padding: 1rem 1.5rem;
                background: transparent;
                border: none;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                color: rgba(255,255,255,0.9);
                font-size: 1rem;
                font-family: inherit;
                font-weight: 500;
                text-align: left;
                cursor: pointer;
                transition: background 0.2s ease;
            }
            .mobile-menu-item:hover {
                background: rgba(255,255,255,0.1);
            }
            .mobile-menu-item.active {
                background: rgba(255,255,255,0.15);
                color: white;
                font-weight: 600;
            }
            .mobile-menu-item i {
                margin-right: 0.75rem;
                width: 20px;
                text-align: center;
            }

            /* Hide desktop tabs on mobile */
            .tabs-wrapper {
                display: none !important;
            }

            .container { padding: 0.5rem; overflow-x: hidden; }

            /* Zone 6 Banner - compact */
            #zone6-banner {
                padding: 0.75rem !important;
                font-size: 0.8rem !important;
            }
            #zone6-banner strong { font-size: 0.9rem !important; }
            #zone6-banner span { font-size: 0.75rem !important; }

            /* Dashboard grid - stack on mobile */
            .dashboard-grid {
                grid-template-columns: 1fr !important;
                gap: 0.75rem;
            }

            /* Compact sections - prevent overflow */
            .section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
                overflow-x: hidden;
                max-width: 100%;
                box-sizing: border-box;
            }
            /* Mobile typography: body 16-20px (1-1.25rem), headlines 28-40px (1.75-2.5rem), UI 14-16px (0.875-1rem) */
            .section h2 { font-size: 1.25rem; margin-bottom: 0.5rem; flex-wrap: wrap; } /* 20px headline */
            .section h3 { font-size: 1.1rem; } /* 17.6px sub-headline */
            .section p { font-size: 1rem; } /* 16px body text */

            /* Dashboard section titles - larger for readability */
            .dashboard-grid .section h2 { font-size: 1.25rem; } /* 20px */

            /* MET/Sun toggle buttons - prevent overflow */
            .section h2 .met-toggle-group,
            .section h2 span[style*="display: flex"] {
                flex-wrap: wrap;
                gap: 0.25rem;
            }
            .section h2 button {
                padding: 0.35rem 0.5rem !important;
                font-size: 0.875rem !important; /* 14px UI element */
            }

            /* Stat boxes */
            .stat-box { padding: 0.5rem; }
            .stat-number { font-size: 1.5rem; } /* 24px - prominent number */
            .stat-label { font-size: 0.875rem; } /* 14px UI label */

            /* Status grid */
            .status-grid {
                flex-direction: column;
                gap: 0.4rem;
            }

            /* Status overview text */
            #live-status-summary p { font-size: 1rem !important; } /* 16px body */

            /* Forecast section */
            #forecast-content p { font-size: 1rem; } /* 16px body */
            #forecast-chart { height: 200px !important; }

            /* Last 24 hours - prevent overflow */
            #last24h-timestamp { font-size: 0.875rem; } /* 14px UI */

            /* Calculator */
            .calculator-container { padding: 0.75rem; }
            .calculator-grid { gap: 0.5rem; }

            /* MET selector */
            .met-selector { grid-template-columns: repeat(2, 1fr); gap: 0.4rem; }
            .met-option { padding: 0.4rem; font-size: 0.875rem; } /* 14px UI */

            /* Charts - prevent overflow */
            .chart-grid { grid-template-columns: 1fr; }

            /* Dropdowns and inputs - constrain width */
            select, input {
                font-size: 1rem; /* 16px - prevents iOS zoom */
                padding: 0.35rem;
                max-width: 100%;
            }
            label { font-size: 0.875rem; } /* 14px UI label */

            /* IECC logo strip - very small, left justified aligned with tiles */
            .logo-strip { padding: 0.15rem 0; }
            .logo-strip-content {
                padding: 0 0.5rem;
                justify-content: flex-start;
            }
            .logo-strip img {
                height: 12px !important;
                width: auto !important;
            }
            .logo-strip-text { display: none; }

            /* Filter dropdowns - prevent overflow */
            .dashboard-grid select {
                width: 100%;
                margin-bottom: 0.25rem;
                max-width: calc(100vw - 2rem);
            }

            /* About page - work intensity annotation */
            .section div[style*="margin-left: -17rem"] {
                margin-left: 0 !important;
                justify-content: center;
            }

            /* Mobile touch - show tooltip on tap before navigation */
            .zone6-alert-banner,
            .info-tooltip {
                cursor: pointer;
            }

            /* Zone 6 banner minimized - two lines: title+plus on line 1, marquee on line 2 */
            .zone6-alert-banner.minimized {
                display: block !important;
                padding: 0.5rem 0.75rem !important;
                position: relative !important;
            }
            .zone6-alert-banner.minimized .close-btn {
                position: absolute !important;
                top: 0.5rem !important;
                right: 0.75rem !important;
                transform: none !important;
                width: auto !important;
                height: auto !important;
                padding: 0.3rem 0.5rem !important;
                font-size: 0.9rem !important;
            }
            .zone6-alert-banner.minimized #zone6-banner-content .banner-static-text {
                display: inline !important;
                font-size: 0.85rem !important;
                margin-right: 2.5rem; /* Space for plus button */
            }
            .zone6-alert-banner.minimized #zone6-banner-content .banner-marquee-container {
                display: block !important;
                width: 100% !important;
                margin-top: 0.4rem !important;
            }
            .zone6-alert-banner.minimized #zone6-banner-content .banner-marquee-container marquee {
                font-size: 0.8rem !important;
            }

            /* Dashboard tile tooltips - position to the LEFT on mobile (white bg, black text) */
            .dashboard-grid .info-tooltip .tooltip-text {
                bottom: auto;
                top: 50%;
                left: auto;
                right: 100%;
                transform: translateY(-50%);
                margin-right: 8px;
                margin-top: 0;
                width: 200px;
                background: white !important;
                color: #333 !important;
                border: 1px solid #ddd;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }
            .dashboard-grid .info-tooltip .tooltip-text::after {
                top: 50%;
                bottom: auto;
                left: 100%;
                right: auto;
                transform: translateY(-50%);
                border-top-color: transparent;
                border-bottom-color: transparent;
                border-left-color: white;
                border-right-color: transparent;
            }

            /* EHI dropdown - wider and match conditions button height */
            .met-select-green {
                font-size: 0.85rem !important;
                padding: 0.5rem 1.5rem 0.5rem 0.75rem !important;
                min-width: 170px !important;
                max-width: none !important;
                height: auto !important;
            }

            /* ================================================
               MOBILE DASHBOARD TILE LAYOUT
               Line 1: Title only
               Line 2: EHI dropdown + Shade/Sun buttons
               Line 3: Timestamp
               Line 4: Separator
               Line 5: State/District dropdowns inline
               Line 6: Stats tiles inline
               ================================================ */

            /* Section headers - use block display, let content wrap naturally */
            .section h2 {
                display: block !important;
                line-height: 1.8;
                margin-bottom: 0.75rem;
            }

            /* EHI dropdown inline with buttons */
            .section h2 .met-select-green {
                display: inline-block !important;
                vertical-align: middle;
                margin: 0.25rem 0.25rem 0.25rem 0;
            }
            .section h2 > span[style*="margin-left"] {
                display: inline-flex !important;
                align-items: center;
                vertical-align: middle;
                margin-left: 0.25rem !important;
            }
            .section h2 .info-tooltip {
                display: inline-block !important;
                vertical-align: middle;
                margin-left: 0.25rem;
            }

            /* Shade/Sun buttons - match dropdown height */
            .section h2 span[style*="margin-left"] button {
                padding: 0.4rem 0.5rem !important;
                font-size: 0.75rem !important;
            }

            /* Timestamp - appears under controls, before separator */
            #global-timestamp,
            #last24h-timestamp {
                font-size: 0.8rem !important;
                margin-top: 0.25rem;
                margin-bottom: 0.75rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid var(--gray-light);
            }

            /* Forecast generated timestamp */
            #forecast-content p[style*="font-size: 0.9rem"] {
                font-size: 0.8rem !important;
                margin-bottom: 0.75rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid var(--gray-light);
            }

            /* State/District filters - inline on mobile */
            .section > div[style*="display: flex"][style*="gap: 1rem"] {
                flex-direction: row !important;
                gap: 0.5rem !important;
                margin-bottom: 1rem !important;
            }
            .section > div[style*="display: flex"][style*="gap: 1rem"] > div {
                flex: 1 !important;
                min-width: 0 !important;
            }
            .section > div[style*="display: flex"][style*="gap: 1rem"] label {
                display: none;
            }
            .section > div[style*="display: flex"][style*="gap: 1rem"] select {
                font-size: 0.8rem !important;
                padding: 0.4rem !important;
            }

            /* Status grid - 2x2 layout for stat tiles */
            .status-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 0.5rem !important;
            }

            /* Forecast grid - stack on mobile */
            .forecast-grid {
                display: grid !important;
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
                width: 100% !important;
                max-width: 100% !important;
                overflow: hidden !important;
            }
            /* Forecast map container - fit to screen width */
            .forecast-grid > div:first-child {
                width: 100% !important;
                max-width: 100% !important;
            }
            .forecast-grid > div {
                width: 100% !important;
                max-width: 100% !important;
                overflow: hidden !important;
            }
            #forecast-map {
                width: 100% !important;
                max-width: 100% !important;
            }
            #forecast-chart {
                width: 100% !important;
                max-width: 100% !important;
            }
            .status-grid .stat-box {
                padding: 0.5rem !important;
            }
            .status-grid .stat-box .stat-number {
                font-size: 1.25rem !important; /* 20px - readable number */
            }
            .status-grid .stat-box .stat-label {
                font-size: 0.875rem !important; /* 14px - minimum readable */
            }

            /* Mobile location summary - show under tiles */
            #current-location-summary {
                display: block !important;
            }

            /* Last 24 hours charts - fix distortion */
            .chart-grid {
                display: flex !important;
                flex-direction: column !important;
                gap: 0.75rem !important;
                width: 100% !important;
            }
            .chart-container {
                width: 100% !important;
                height: 280px !important;
                min-height: 260px !important;
                max-height: 320px !important;
                padding: 0.5rem !important;
                overflow: visible !important;
                position: relative !important;
                box-sizing: border-box !important;
            }
            .chart-container h3 {
                font-size: 0.75rem !important;
                margin-bottom: 0.25rem !important;
                margin-top: 0 !important;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            .chart-container canvas {
                width: 100% !important;
                height: calc(100% - 20px) !important;
                max-width: 100% !important;
                display: block !important;
            }

            /* Forecast peak conditions - compact on mobile */
            #forecast-content > div[style*="background: var(--gray-light)"] p {
                font-size: 0.8rem !important;
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 0.25rem !important;
            }
            #forecast-content > div[style*="background: var(--gray-light)"] span {
                font-size: 0.7rem !important;
                padding: 2px 5px !important;
                margin-left: 0 !important;
            }

            /* About EHI-N* section - reduce padding on mobile */
            #about-tab .section {
                padding-left: 0.75rem !important;
                padding-right: 0.75rem !important;
            }

            /* Summer 2025 Animation iframe - mobile height */
            #animation-tab iframe,
            .section iframe[src*="ehi-webapp"] {
                height: 450px !important;
                min-height: 400px !important;
            }

            /* Live map iframe - mobile height */
            #livemap-tab iframe {
                height: calc(100vh - 180px) !important;
                min-height: 400px !important;
            }

            /* EHI dropdown - auto width based on content */
            .met-select-green {
                min-width: auto !important;
                width: auto !important;
            }

            /* Forecast map - viewport-based on mobile */
            #forecast-map {
                height: 40vh !important;
                min-height: 200px !important;
            }

            /* Hide icons from conditions buttons on mobile for consistent height with MET */
            button[id*="shade-btn"] i,
            button[id*="sun-btn"] i {
                display: none !important;
            }

            /* Forecast map controls - smaller and better positioned */
            .leaflet-control-zoom {
                margin-top: 10px !important;
                margin-left: 10px !important;
            }
            .leaflet-control-zoom a {
                width: 28px !important;
                height: 28px !important;
                line-height: 28px !important;
                font-size: 14px !important;
            }

            /* Home button for forecast map - mobile positioning */
            #forecast-map + button,
            button[onclick="resetForecastMap()"] {
                top: 95px !important;
                width: 28px !important;
                height: 28px !important;
                font-size: 12px !important;
            }

            /* Footer - smaller text on mobile */
            .footer {
                padding: 1rem;
                margin-top: 1.5rem;
            }
            .footer p {
                font-size: 0.7rem !important;
                margin: 0.25rem 0;
                line-height: 1.3;
            }
            .footer p strong {
                font-size: 0.75rem !important;
            }
        }

        /* Small phones (iPhone 14/15 Pro Max/Plus ~430px, regular, most Androids) */
        @media (max-width: 480px) {
            .logo-container img {
                height: 100px;
            }
            .tab {
                padding: 6px 4px;
                font-size: 0.8rem;
            }
            .met-select-green {
                font-size: 0.75rem !important;
                padding: 0.4rem 1.2rem 0.4rem 0.5rem !important;
                min-width: 150px !important;
            }
            .section h2 span[style*="margin-left"] button {
                padding: 0.35rem 0.4rem !important;
                font-size: 0.7rem !important;
            }
            .status-grid .stat-box .stat-number {
                font-size: 1.1rem !important; /* 17.6px - readable */
            }
            .status-grid .stat-box .stat-label {
                font-size: 0.8rem !important; /* 12.8px - minimum for small phones */
            }

            /* Phone layout: Stack controls on separate lines */
            /* Center all h2 content on phones */
            .section h2 {
                text-align: center !important;
                justify-content: center !important;
            }

            /* Line 1: Title - full width block, centered, with clear break below */
            .section h2 > span[style*="margin-right: 0.75rem"] {
                display: block !important;
                width: 100%;
                margin-bottom: 0.75rem !important;
                margin-right: 0 !important;
                padding-bottom: 0.5rem !important;
                border-bottom: 1px solid #e0e0e0;
                font-size: 1.1rem; /* 17.6px title */
                text-align: center;
            }

            /* Line 2: MET + Conditions buttons inline, centered */
            .section h2 .met-toggle-group,
            .section h2 #sun-shade-toggle,
            .section h2 > span:has(button[id*="shade-btn"]),
            .section h2 > span:has(button[id*="sun-btn"]) {
                display: inline-flex !important;
                margin-right: 0.4rem;
                margin-bottom: 0.4rem;
            }
            .section h2 .met-toggle-group > span:first-child,
            .section h2 > span > span[style*="font-size: 0.7rem"] {
                font-size: 0.75rem !important; /* 12px small label */
                margin-bottom: 0.15rem !important;
            }
            .section h2 .met-toggle-group button,
            .section h2 button[id*="shade-btn"],
            .section h2 button[id*="sun-btn"] {
                padding: 0.35rem 0.5rem !important;
                font-size: 0.875rem !important; /* 14px UI element */
            }

            /* Line 3: State + District - force a line break before state */
            /* Hide STATE/DISTRICT labels on phones */
            .section h2 > span:has(#current-state-select) > span:first-child,
            .section h2 > span:has(#current-district-select) > span:first-child {
                display: none !important;
            }
            #current-state-select, #current-district-select {
                width: 130px !important;
                max-width: 140px !important;
                font-size: 0.8rem !important;
                padding: 0 0.3rem !important;
                height: 32px !important;
            }
            /* Force sun/shade toggle to take remaining width and push state to next line */
            .section h2 #sun-shade-toggle::after {
                content: "" !important;
                flex-basis: 100% !important;
                width: 0 !important;
                height: 0 !important;
            }
            /* Make the h2 have a wrapper-like behavior */
            .section h2 > span:has(#current-state-select) {
                flex-basis: calc(50% - 0.25rem) !important;
                margin-top: 0.5rem !important;
                order: 100 !important;
            }
            .section h2 > span:has(#current-district-select) {
                flex-basis: calc(50% - 0.25rem) !important;
                margin-top: 0.5rem !important;
                order: 101 !important;
            }
            /* Add a flex break after CONDITIONS */
            .section h2 #sun-shade-toggle {
                margin-right: auto !important;
            }
            /* Info tooltip last */
            .section h2 > .info-tooltip {
                order: 200 !important;
                flex-basis: 100% !important;
                margin-top: 0.5rem !important;
            }

            /* Hide FORECAST day buttons from header on mobile - they'll show after map */
            .section h2 > span:has(#forecast-1day-btn) {
                display: none !important;
            }

            /* Show forecast day buttons after map on mobile */
            .forecast-buttons-mobile {
                display: flex !important;
                justify-content: center;
                gap: 0;
                margin-top: 0.75rem;
                margin-bottom: 0.5rem;
            }
            .forecast-buttons-mobile button {
                padding: 0.4rem 0.75rem !important;
                font-size: 0.75rem !important;
            }

            /* ===== ZONE TRENDS SECTION - Phone Layout ===== */
            /* Line 2: Timeframe buttons under title */
            #last24h-section h2 > span:has(button[id*="trend-day"]),
            #last24h-section h2 > span:has(button[id*="trend-week"]) {
                display: block !important;
                width: 100%;
                margin-top: 0.3rem;
                margin-bottom: 0.3rem;
            }
            button[id*="trend-day-btn"],
            button[id*="trend-week-btn"],
            button[id*="trend-month-btn"] {
                padding: 0.25rem 0.5rem !important;
                font-size: 0.65rem !important;
            }

            /* Line 3: MET + Conditions inline */
            #last24h-section h2 #met-toggle-last24h,
            #last24h-section h2 > span:has(button[id*="last24h-shade"]) {
                display: inline-flex !important;
                margin-right: 0.4rem;
                margin-bottom: 0.3rem;
            }
            #last24h-section h2 #met-toggle-last24h button,
            button[id*="last24h-shade-btn"],
            button[id*="last24h-sun-btn"] {
                padding: 0.25rem 0.4rem !important;
                font-size: 0.65rem !important;
            }

            /* Line 4: State + District - force them to stay on same row */
            #last24h-section h2 > span:has(#charts-state-select) {
                display: inline !important;
                margin-top: 0.3rem;
                margin-right: 0.15rem;
            }
            #last24h-section h2 > span:has(#charts-district-select) {
                display: inline !important;
                margin-top: 0.3rem;
            }
            /* Hide STATE/DISTRICT labels on phones for Historical Zones */
            #last24h-section h2 > span:has(#charts-state-select) > span,
            #last24h-section h2 > span:has(#charts-district-select) > span {
                display: none !important;
            }
            #charts-state-select, #charts-district-select {
                width: 42% !important;
                max-width: 140px !important;
                font-size: 0.875rem !important; /* 14px UI element */
                padding: 0 0.3rem !important;
                height: 32px !important;
                display: inline-block !important;
            }

            /* Hide info tooltip on phones */
            .section h2 .info-tooltip {
                display: none !important;
            }

            /* Data sources and notes - smaller on phones */
            .section p[style*="font-size: 0.85rem"],
            .section p[style*="color: #999"] {
                font-size: 0.75rem !important; /* 12px - compact */
                margin-top: 0.5rem !important;
            }
        }

        /* Extra small phones (iPhone SE, small Androids ~360px) */
        @media (max-width: 375px) {
            .logo-container img {
                height: 80px;
            }
            .tab {
                padding: 5px 3px;
                font-size: 0.7rem;
            }
            .met-select-green {
                font-size: 0.7rem !important;
                padding: 0.35rem 1rem 0.35rem 0.4rem !important;
                min-width: 130px !important;
            }
            .section h2 span[style*="margin-left"] button {
                padding: 0.3rem 0.35rem !important;
                font-size: 0.65rem !important;
            }
            .section h2 {
                font-size: 0.9rem !important;
            }
            .dashboard-grid .section h2 {
                font-size: 1rem !important;
            }
            .stat-box {
                padding: 0.4rem !important;
            }
            .status-grid .stat-box .stat-number {
                font-size: 1rem !important; /* 16px - minimum readable */
            }
            .status-grid .stat-box .stat-label {
                font-size: 0.75rem !important; /* 12px - minimum for very small screens */
            }
        }

        /* Landscape phone mode - apply mobile styles when height is limited */
        @media (max-height: 500px) and (orientation: landscape) {
            .header {
                padding: 0.5rem;
                position: relative;
            }
            .header-content {
                flex-direction: row;
                align-items: center;
                flex-wrap: nowrap;
                gap: 1rem;
            }
            .logo-container {
                position: relative;
                left: 0;
                bottom: 0;
                height: auto;
                width: auto;
                margin-bottom: 0;
                flex-shrink: 0;
            }
            .logo-container img {
                height: 60px;
                width: auto;
            }
            .tabs {
                flex-wrap: nowrap;
                gap: 0.25rem;
                flex: 1;
                justify-content: flex-end;
            }
            .tab {
                padding: 0.35rem 0.5rem;
                font-size: 0.7rem;
                flex: 0 0 auto;
            }
            .tab i { display: none; }

            /* Container scrollable in landscape */
            .container {
                padding: 0.5rem;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
            }

            /* Section headers inline for landscape */
            .section h2 {
                display: block !important;
                line-height: 1.6;
                font-size: 0.9rem;
            }
            .section h2 .met-select-green {
                display: inline-block !important;
                vertical-align: middle;
                font-size: 0.75rem !important;
                padding: 0.3rem 0.8rem 0.3rem 0.4rem !important;
                min-width: auto !important;
            }
            .section h2 > span[style*="margin-left"] {
                display: inline-flex !important;
                align-items: center;
                vertical-align: middle;
            }
            .section h2 span[style*="margin-left"] button {
                padding: 0.3rem 0.4rem !important;
                font-size: 0.65rem !important;
            }

            /* Compact stats in landscape */
            .status-grid {
                display: flex !important;
                flex-direction: row !important;
                flex-wrap: wrap;
                gap: 0.5rem !important;
            }
            .status-grid .stat-box {
                flex: 1 1 45%;
                padding: 0.4rem !important;
            }
            .status-grid .stat-box .stat-number {
                font-size: 1rem !important; /* 16px - readable */
            }
            .status-grid .stat-box .stat-label {
                font-size: 0.75rem !important; /* 12px - minimum readable in landscape */
            }

            /* Dashboard grid - 2 columns in landscape */
            .dashboard-grid {
                grid-template-columns: 1fr 1fr !important;
                gap: 0.5rem;
            }
        }

        /* Very short landscape (older/smaller phones) */
        @media (max-height: 400px) and (orientation: landscape) {
            .logo-container img {
                height: 50px;
            }
            .tab {
                padding: 0.25rem 0.4rem;
                font-size: 0.65rem;
            }
            .container {
                max-height: calc(100vh - 60px);
            }
        }
    </style>
    <!-- Leaflet CSS and JS for district map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="logo-strip">
        <div class="logo-strip-content">
            <a href="https://iecc.gspp.berkeley.edu/impact-areas/resilience-climate-impacts/" target="_blank" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                <img src="iecc-logo.svg" alt="IECC Logo" style="height: 50px; width: auto;">
            </a>
        </div>
    </div>

    <div class="header">
        <!-- Mobile hamburger menu button -->
        <button class="hamburger-btn" onclick="toggleMobileMenu(event)" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <!-- Mobile tour button - below hamburger -->
        <button class="take-tour-btn mobile-tour-btn" onclick="startTour()" title="Learn how to use SHRAM">
            <i class="fas fa-question-circle"></i>
        </button>
        <!-- Mobile dropdown menu -->
        <div class="mobile-menu" id="mobile-menu">
            <button class="mobile-menu-item active" onclick="mobileMenuSelect(event, 'dashboard')">
                <i class="fas fa-dashboard"></i> Dashboard
            </button>
            <button class="mobile-menu-item" onclick="mobileMenuSelect(event, 'livemap')">
                <i class="fas fa-map-marked-alt"></i> Live Zone Map
            </button>
            <button class="mobile-menu-item" onclick="mobileMenuSelect(event, 'calculator')">
                <i class="fas fa-calculator"></i> EHI-N* Calculator
            </button>
            <button class="mobile-menu-item" onclick="mobileMenuSelect(event, 'about')">
                <i class="fas fa-info-circle"></i> About EHI-N*
            </button>
        </div>
        <div class="header-content">
            <div class="logo-container">
                <img src="shram_logo.svg" alt="SHRAM: System for Heat Risk Assessment for Manual labor">
            </div>

            <div class="tabs-wrapper">
                <button class="take-tour-btn desktop-tour-btn" onclick="startTour()" title="Learn how to use SHRAM">
                    <i class="fas fa-question-circle"></i>
                </button>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab(event, 'dashboard')">
                        <i class="fas fa-dashboard"></i> Dashboard
                    </button>
                    <button id="livemap-tab-btn" class="tab" onclick="switchTab(event, 'livemap')">
                        <i class="fas fa-map-marked-alt"></i> Live Zone Map
                    </button>
                    <button class="tab" onclick="switchTab(event, 'calculator')">
                        <i class="fas fa-calculator"></i> EHI-N* Calculator
                    </button>
                    <button id="about-tab-btn" class="tab" onclick="switchTab(event, 'about')">
                        <i class="fas fa-info-circle"></i> About EHI-N*
                    </button>
                </div>
            </div>

        </div>
    </div>

    <div class="container">
        <!-- Zone 6 Hazardous Alert Banner -->
        <div id="zone6-banner" class="zone6-alert-banner minimized" onclick="expandBannerIfMinimized(event)">
            <button class="close-btn" onclick="toggleBanner(event)" id="banner-toggle-btn"><i class="fas fa-plus"></i></button>
            <div id="zone6-banner-content"></div>
        </div>

        <!-- TAB 1: DASHBOARD -->
        <div id="dashboard-tab" class="tab-content active">
            <!-- Two-column layout: Current Status (left) | Forecast (right) -->
            <div class="dashboard-grid">
                <!-- LEFT: Current Status -->
                <div class="section">
                    <h2 style="display: flex; flex-wrap: wrap; align-items: flex-end; gap: 0.5rem;">
                        <span style="margin-right: 0.75rem; margin-bottom: 0.35rem;">Current Heat Stress Alerts</span>
                        <span id="met-toggle-current" class="met-toggle-group" style="display: inline-flex; flex-direction: column; align-items: center;">
                            <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">MET LEVEL</span>
                            <span style="display: inline-flex;">
                                <button id="current-met-3" onclick="selectMetCurrent(3)" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">3</button><button id="current-met-4" onclick="selectMetCurrent(4)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; font-weight: 700; cursor: pointer; font-size: 1rem;">4</button><button id="current-met-5" onclick="selectMetCurrent(5)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; font-weight: 700; cursor: pointer; font-size: 1rem;">5</button><button id="current-met-6" onclick="selectMetCurrent(6)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">6</button>
                            </span>
                        </span>
                        <span id="sun-shade-toggle" style="display: inline-flex; flex-direction: column; align-items: center;">
                            <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">CONDITIONS</span>
                            <span style="display: inline-flex;">
                                <button id="current-shade-btn" onclick="setShade('current', true)" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                    <i class="fas fa-cloud"></i> Shade
                                </button><button id="current-sun-btn" onclick="setShade('current', false)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                    <i class="fas fa-sun"></i> Sun
                                </button>
                            </span>
                        </span>
                        <span style="display: inline-flex; flex-direction: column; align-items: center;">
                            <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">STATE</span>
                            <select id="current-state-select" onchange="updateCurrentDistricts(); filterCurrentStatus();" style="padding: 0 0.75rem; border-radius: 6px; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); font-weight: 600; font-size: 1rem; width: 200px; height: 42px;">
                                <option value="all">All India</option>
                            </select>
                        </span>
                        <span style="display: inline-flex; flex-direction: column; align-items: center;">
                            <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">DISTRICT</span>
                            <select id="current-district-select" onchange="filterCurrentStatus()" style="padding: 0 0.75rem; border-radius: 6px; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); font-weight: 600; font-size: 1rem; width: 200px; height: 42px;">
                                <option value="all">All Districts</option>
                            </select>
                        </span>
                        <span class="info-tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text"><strong>MET Level:</strong> Select based on work intensity.<br> EHI-3: Light (walking, light housework)<br> EHI-4: Moderate (carrying loads, cleaning)<br> EHI-5: Heavy (construction, farming)<br> EHI-6: Very Heavy (agricultural labor, heavy lifting)<br><br><strong>Sun Exposure:</strong><br> <strong>Shade:</strong> Working under cover or indoors<br> <strong>Sun:</strong> Direct sunlight exposure</span>
                        </span>
                    </h2>
                    <!-- Hidden select for compatibility -->
                    <select id="met-select-current" style="display: none;">
                        <option value="3" selected>EHI-3</option>
                        <option value="4">EHI-4</option>
                        <option value="5">EHI-5</option>
                        <option value="6">EHI-6</option>
                    </select>

                    <!-- Last Updated Timestamp -->
                    <p id="global-timestamp" style="text-align: center; font-size: 1.2rem; color: #000; margin-bottom: 1rem; font-weight: 600;"></p>

                    <div class="status-overview">
                        <div id="live-status-summary">
                            <p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Loading current status...</p>
                        </div>
                        <div class="status-grid" id="status-grid"></div>
                        <p id="current-location-summary" class="location-summary" style="display: none; text-align: center; font-size: 0.85rem; color: #666; margin-top: 0.75rem; font-style: italic;"></p>
                    </div>

                    <p style="text-align: center; font-size: 0.85rem; color: #999; margin-top: 1.5rem; font-style: italic;">Data source: India Meteorological Department (IMD)</p>
                </div>

                <!-- RIGHT: Forecast -->
                <div class="section">
                    <h2 style="display: flex; flex-wrap: wrap; align-items: flex-end; gap: 0.5rem;">
                        <span style="margin-right: 0.75rem; margin-bottom: 0.35rem;">Heat Stress Forecast</span>
                        <span id="met-toggle-forecast" class="met-toggle-group" style="display: inline-flex; flex-direction: column; align-items: center;">
                            <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">MET LEVEL</span>
                            <span style="display: inline-flex;">
                                <button id="forecast-met-3" onclick="selectMetForecast(3)" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">3</button><button id="forecast-met-4" onclick="selectMetForecast(4)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; font-weight: 700; cursor: pointer; font-size: 1rem;">4</button><button id="forecast-met-5" onclick="selectMetForecast(5)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; font-weight: 700; cursor: pointer; font-size: 1rem;">5</button><button id="forecast-met-6" onclick="selectMetForecast(6)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">6</button>
                            </span>
                        </span>
                        <span style="display: inline-flex; flex-direction: column; align-items: center;">
                            <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">CONDITIONS</span>
                            <span style="display: inline-flex;">
                                <button id="forecast-shade-btn" onclick="setShade('forecast', true)" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                    <i class="fas fa-cloud"></i> Shade
                                </button><button id="forecast-sun-btn" onclick="setShade('forecast', false)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                    <i class="fas fa-sun"></i> Sun
                                </button>
                            </span>
                        </span>
                        <span style="display: inline-flex; flex-direction: column; align-items: center;">
                            <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">FORECAST</span>
                            <span style="display: inline-flex;">
                                <button id="forecast-1day-btn" onclick="setForecastDays(1)" style="padding: 0.5rem 0.75rem; font-size: 1rem; background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer;">1-Day</button><button id="forecast-3day-btn" onclick="setForecastDays(3)" style="padding: 0.5rem 0.75rem; font-size: 1rem; background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); border-left: none; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer;">3-Day</button>
                            </span>
                        </span>
                        <span class="info-tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text"><strong>MET Level:</strong> Select based on work intensity.<br> EHI-3: Light (walking, light housework)<br> EHI-4: Moderate (carrying loads, cleaning)<br> EHI-5: Heavy (construction, farming)<br> EHI-6: Very Heavy (agricultural labor, heavy lifting)<br><br><strong>Sun Exposure:</strong><br> <strong>Shade:</strong> Working under cover or indoors<br> <strong>Sun:</strong> Direct sunlight exposure</span>
                        </span>
                    </h2>
                    <!-- Hidden selects for compatibility -->
                    <select id="met-select-forecast" style="display: none;">
                        <option value="3" selected>EHI-3</option>
                        <option value="4">EHI-4</option>
                        <option value="5">EHI-5</option>
                        <option value="6">EHI-6</option>
                    </select>
                    <select id="forecast-state-select" style="display: none;">
                        <option value="all">-- Select a State --</option>
                    </select>
                    <select id="forecast-district-select" style="display: none;">
                        <option value="all">All Districts</option>
                    </select>

                    <!-- Two-column layout: Map (left) | Chart (right) -->
                    <div class="forecast-grid" style="display: grid; grid-template-columns: 400px 1fr; gap: 2rem; align-items: start;">
                        <!-- LEFT: Map and controls -->
                        <div>
                            <p id="map-instruction" style="font-weight: 600; color: var(--shram-teal); margin-bottom: 0.5rem;">
                                <i class="fas fa-hand-pointer"></i> Click on a state to select it:
                            </p>
                            <div style="position: relative;">
                                <div id="forecast-map" style="height: 420px; border-radius: 8px; border: 2px solid var(--shram-teal);"></div>
                                <button onclick="resetForecastMap()" title="Reset map view" style="position: absolute; top: 85px; left: 12px; width: 34px; height: 34px; background: white; border: 2px solid rgba(0,0,0,0.2); border-radius: 4px; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; z-index: 1000; box-sizing: border-box;">
                                    <i class="fas fa-home" style="color: #333;"></i>
                                </button>
                            </div>
                            <!-- Mobile forecast day buttons - shown after map on phones -->
                            <div class="forecast-buttons-mobile" style="display: none; justify-content: center; gap: 0; margin-top: 0.75rem;">
                                <button onclick="setForecastDays(1)" style="padding: 0.5rem 0.75rem; font-size: 0.85rem; background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer;" id="forecast-1day-btn-mobile">1-Day</button><button onclick="setForecastDays(3)" style="padding: 0.5rem 0.75rem; font-size: 0.85rem; background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); border-left: none; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer;" id="forecast-3day-btn-mobile">3-Day</button>
                            </div>
                            <div style="margin-top: 0.5rem;">
                                <p id="selected-location-label" style="font-weight: 600; color: var(--shram-teal); margin: 0;"></p>
                            </div>
                        </div>

                        <!-- RIGHT: Forecast content and chart -->
                        <div>
                            <div id="forecast-content">
                                <p style="text-align: center; color: #666;">Loading forecast...</p>
                            </div>
                            <div style="margin-top: 1.5rem;">
                                <canvas id="forecast-chart" style="height: 400px; min-height: 350px;"></canvas>
                            </div>
                            <p class="forecast-note" style="font-size: 0.85rem; color: #999; margin-top: 0.75rem; font-style: italic; word-wrap: break-word; overflow-wrap: break-word; text-align: center;">Note: Nighttime = EHI-N (no solar load).</p>
                        </div>
                    </div>

                    <p style="text-align: center; font-size: 0.85rem; color: #999; margin-top: 1.5rem; font-style: italic; word-wrap: break-word;">Data source: WeatherAPI.com</p>
                </div>
            </div>

            <!-- Historical Zones (full width) -->
            <div id="last24h-section" class="section">
                <h2 style="display: flex; flex-wrap: wrap; align-items: flex-end; gap: 0.5rem;">
                    <span style="margin-right: 0.75rem; margin-bottom: 0.35rem;">Historical Zones</span>
                    <span style="display: inline-flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">TIMEFRAME</span>
                        <span style="display: inline-flex;">
                            <button id="trend-day-btn" onclick="setTrendPeriod('day')" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">Day</button><button id="trend-week-btn" onclick="setTrendPeriod('week')" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; font-weight: 700; cursor: pointer; font-size: 1rem;">Week</button><button id="trend-month-btn" onclick="setTrendPeriod('month')" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">Month</button>
                        </span>
                    </span>
                    <span id="met-toggle-last24h" class="met-toggle-group" style="display: inline-flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">MET LEVEL</span>
                        <span style="display: inline-flex;">
                            <button id="last24h-met-3" onclick="selectMetLast24h(3)" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">3</button><button id="last24h-met-4" onclick="selectMetLast24h(4)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; font-weight: 700; cursor: pointer; font-size: 1rem;">4</button><button id="last24h-met-5" onclick="selectMetLast24h(5)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; font-weight: 700; cursor: pointer; font-size: 1rem;">5</button><button id="last24h-met-6" onclick="selectMetLast24h(6)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">6</button>
                        </span>
                    </span>
                    <span style="display: inline-flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">CONDITIONS</span>
                        <span style="display: inline-flex;">
                            <button id="last24h-shade-btn" onclick="setShade('last24h', true)" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                <i class="fas fa-cloud"></i> Shade
                            </button><button id="last24h-sun-btn" onclick="setShade('last24h', false)" style="background: #e8f4f8; color: var(--shram-teal); border: 2px solid #e8f4f8; border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                <i class="fas fa-sun"></i> Sun
                            </button>
                        </span>
                    </span>
                    <span style="display: inline-flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">STATE</span>
                        <select id="charts-state-select" onchange="updateChartsDistricts(); loadTrendData();" style="padding: 0 0.75rem; border-radius: 6px; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); font-weight: 600; font-size: 1rem; width: 200px; height: 42px;">
                            <option value="all">All India</option>
                        </select>
                    </span>
                    <span style="display: inline-flex; flex-direction: column; align-items: center;">
                        <span style="font-size: 0.7rem; color: #78909c; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.25rem;">DISTRICT</span>
                        <select id="charts-district-select" onchange="loadTrendData()" style="padding: 0 0.75rem; border-radius: 6px; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); font-weight: 600; font-size: 1rem; width: 200px; height: 42px;">
                            <option value="all">All Districts</option>
                        </select>
                    </span>
                    <span class="info-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text"><strong>MET Level:</strong> Select based on work intensity.<br> EHI-3: Light (walking, light housework)<br> EHI-4: Moderate (carrying loads, cleaning)<br> EHI-5: Heavy (construction, farming)<br> EHI-6: Very Heavy (agricultural labor, heavy lifting)<br><br><strong>Sun Exposure:</strong><br> <strong>Shade:</strong> Working under cover or indoors<br> <strong>Sun:</strong> Direct sunlight exposure</span>
                    </span>
                </h2>
                <!-- Hidden select for compatibility -->
                <select id="met-select-last24h" style="display: none;">
                    <option value="3" selected>EHI-3</option>
                    <option value="4">EHI-4</option>
                    <option value="5">EHI-5</option>
                    <option value="6">EHI-6</option>
                </select>
                <p id="last24h-timestamp" style="text-align: center; font-size: 1.2rem; color: #000; margin-bottom: 1rem; font-weight: 600;"></p>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Historical Zones</h3>
                        <canvas id="alertTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Dry-Bulb Temperature & Relative Humidity</h3>
                        <canvas id="tempHumidityChart"></canvas>
                    </div>
                </div>
                <p style="text-align: center; font-size: 0.85rem; color: #999; margin-top: 1.5rem; font-style: italic;">Data source: India Meteorological Department (IMD)</p>
            </div>

            <!-- Summer 2025 Zones Animation -->
            <div class="section">
                <h2>Summer 2025 Zones</h2>
                <p style="margin-bottom: 1rem; color: #666;">Hourly heat stress zones across India from May-June 2025. Use the controls to change MET level, sun/shade conditions, and scrub through time.</p>
                <iframe
                    src="https://ekilic-coder.github.io/ehi-webapp-frontend/"
                    style="width: 100%; height: 600px; border: none; border-radius: 8px;"
                    title="EHI Heat Stress Zones - India Summer 2025">
                </iframe>
                <p style="text-align: center; font-size: 0.85rem; color: #999; margin-top: 1.5rem; font-style: italic;">Data source: ERA5 Reanalysis (Copernicus Climate Data Store)</p>
            </div>
        </div>

        <!-- TAB 2: LIVE MAP -->
        <div id="livemap-tab" class="tab-content">
            <div class="section" style="padding: 0; overflow: hidden; position: relative;">
                <iframe src="map_deck.html" style="width: 100%; height: calc(100vh - 200px); min-height: 600px; border: none;"></iframe>
                <!-- Invisible overlay for tour highlighting (can't target iframe elements directly) -->
                <div id="livemap-controls-overlay" style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%); width: 640px; height: 45px; pointer-events: none; z-index: 1;"></div>
                <div id="livemap-sidebar-overlay" style="position: absolute; top: 0; right: 0; width: 340px; height: 100%; pointer-events: none; z-index: 1;"></div>
            </div>
        </div>

        <!-- TAB 3: EHI-N CALCULATOR -->
        <div id="calculator-tab" class="tab-content">
            <div class="calculator-container">
                <h2 style="color: white; border-bottom-color: rgba(255,255,255,0.3);">
                    Calculate EHI-N*
                </h2>

                <div class="calculator-grid">
                    <div class="input-group">
                        <label for="temp-input"><i class="fas fa-thermometer-half"></i> Temperature</label>
                        <div class="input-wrapper">
                            <input type="number" id="temp-input" placeholder="e.g., 35" min="-50" max="150">
                            <select id="temp-unit">
                                <option value="C">C</option>
                                <option value="F">F</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="rh-input"><i class="fas fa-tint"></i> Relative Humidity (%)</label>
                        <input type="number" id="rh-input" placeholder="e.g., 70" min="0" max="100" style="padding: 0.75rem; border: none; border-radius: 6px; background: rgba(255,255,255,0.95); font-size: 1rem;">
                    </div>

                    <div class="input-group">
                        <label style="display: block; margin-bottom: 0.5rem;"><i class="fas fa-sun"></i> Solar Exposure</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="solar-option active" data-solar="0" onclick="selectSolar(0)" style="flex: 1; padding: 0.75rem; border: 2px solid white; border-radius: 8px; background: white; color: var(--shram-teal); cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                <i class="fas fa-cloud" style="display: block; font-size: 1.5rem; margin-bottom: 0.25rem;"></i>
                                Shaded
                            </button>
                            <button type="button" class="solar-option" data-solar="1" onclick="selectSolar(1)" style="flex: 1; padding: 0.75rem; border: 2px solid rgba(255,255,255,0.5); border-radius: 8px; background: transparent; color: white; cursor: pointer; font-size: 0.9rem; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-sun" style="display: block; font-size: 1.5rem; margin-bottom: 0.25rem;"></i>
                                Full Sun
                            </button>
                        </div>
                    </div>
                </div>

                <h3 style="color: white; margin-top: 2rem;"><i class="fas fa-running"></i> Select Activity Level (METs)</h3>
                <div id="met-selector" class="met-selector">
                    <div class="met-option active" data-met="3">
                        <i class="fas fa-walking"></i>
                        <div class="met-label">3 METs</div>
                        <div class="met-desc">Light Work</div>
                    </div>
                    <div class="met-option" data-met="4">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 293.59 265.83" fill="currentColor" style="height: 2rem; width: auto; display: block; margin: 0 auto 0.5rem;"><circle cx="65.39" cy="61.84" r="22.49" transform="translate(-9.69 111.46) rotate(-76.86)"/><path d="M42.28,108.33l-.02-.15c-.46-5.59,3.64-10.43,9.14-10.88.28-.02.56-.03.83-.03,5.14,0,9.51,4.01,9.95,9.13.02.16.04.29.06.48.05.36.16,1.09.37,2.08.36,1.7,1.05,4.36,2.29,7.34.18.43.39.84.58,1.26.44-1.18.88-2.34,1.28-3.45,4.4-9.38,2.57-21.73-5.53-25.18-8.09-3.44-21.05-.81-28.32,12.85-9.9,18.85-13.4,31.59-14.35,53.94.24,7.18,2.42,11.86,5.55,14.96.14.74.34,1.48.63,2.21h0s0,.02.01.04c.04.1.16.44.34,1.03.66,2.2,2,7.61,2,15.15-.09,13.35-3.84,33.18-23.94,55.92-4.59,5.16-4.12,13.06,1.04,17.65,2.38,2.12,5.35,3.16,8.3,3.16,3.45,0,6.88-1.42,9.35-4.2,20.44-22.89,27.99-45.65,29.8-63.3.31.52.62,1.03.93,1.57,6.89,11.98,13.76,29.5,16.15,54.42.62,6.47,6.06,11.31,12.43,11.31.4,0,.8-.02,1.2-.06,6.87-.65,11.91-6.76,11.26-13.63-3.18-33.49-13.84-56.96-24.04-71.99-6.11-9.02-12-15-15.97-18.5.43-6.75,1.89-13.69,3.81-20.43-2.31-2.43-4.4-5.1-6.26-8.01-6.75-10.63-8.44-20.81-8.86-24.69Z"/><path d="M112.21,147.61c-.18-4.41-3.9-7.85-8.31-7.67-1.01.04-1.99.06-2.94.06-10.16-.01-17.38-2.24-22.8-5.31-8.09-4.61-12.55-11.52-15.1-17.61-1.26-3.02-1.99-5.77-2.4-7.7-.2-.96-.33-1.73-.39-2.21-.03-.24-.06-.42-.06-.51,0-.04,0-.06,0-.07h0s0,0,0,0c-.38-4.39-4.23-7.64-8.62-7.28-4.4.36-7.68,4.22-7.32,8.63h0c.1.72.97,12.02,8.58,24.02,3.81,5.97,9.42,12.1,17.4,16.64,7.95,4.55,18.15,7.42,30.65,7.42h.08c1.18,0,2.37-.03,3.58-.07,4.41-.18,7.85-3.9,7.67-8.32Z"/><path d="M247.58,232.6c0,1.53-.1,3.02-.28,4.5h14.61s0-99.48,0-99.48h-96.02v88.59c1.04,3.69,3.4,6.77,6.59,8.7-.05-.77-.08-1.54-.08-2.32,0-13.94,8.52-37.1,39.05-37.1,24.93,0,36.13,22.55,36.13,37.11Z"/><path d="M136.94,81.82h18.46c1.51,0,2.73-1.23,2.73-2.73v-7.38c0-4.65,3.78-8.43,8.43-8.43s8.43,3.78,8.43,8.43v7.38c0,1.51,1.23,2.73,2.73,2.73h25c1.51,0,2.73-1.23,2.73-2.73v-7.38c0-4.65,3.78-8.43,8.43-8.43s8.43,3.78,8.43,8.43v7.38c0,1.51,1.23,2.73,2.73,2.73h25c1.51,0,2.73-1.23,2.73-2.73v-7.38c0-4.65,3.78-8.43,8.43-8.43s8.43,3.78,8.43,8.43v7.38c0,1.51,1.23,2.73,2.73,2.73h18.46c1.51,0,2.73-1.23,2.73-2.73v-26.09h-159.38v26.07c0,1.52,1.23,2.74,2.73,2.74h0Z"/><path d="M226.05,6.23c0-3.44-2.79-6.23-6.23-6.23h-11.84c-3.44,0-6.23,2.79-6.23,6.23v2.83h24.3v-2.83Z"/><path d="M237.9,14.49c-1.03-.7-2.23-1.06-3.48-1.06h-41.02c-1.25,0-2.45.36-3.48,1.06l-50.76,34.17h149.47l-50.74-34.17Z"/><path d="M209.99,199.38c-18.33,0-33.23,14.91-33.23,33.23s14.9,33.23,33.23,33.23,33.23-14.91,33.23-33.23-14.9-33.23-33.23-33.23ZM234.9,234.79h-12.53c-.32,1.85-1.05,3.55-2.09,5.04l8.87,8.87c.85.85.85,2.23,0,3.08-.43.43-.99.63-1.54.63s-1.11-.22-1.54-.63l-8.87-8.87c-1.47,1.04-3.19,1.77-5.04,2.09v12.53c0,1.2-.98,2.18-2.18,2.18s-2.18-.98-2.18-2.18v-12.53c-1.85-.32-3.55-1.05-5.04-2.09l-8.87,8.87c-.43.43-.99.63-1.54.63s-1.11-.22-1.54-.63c-.85-.85-.85-2.23,0-3.08l8.87-8.87c-1.04-1.47-1.77-3.19-2.09-5.04h-12.53c-1.2,0-2.18-.98-2.18-2.18s.98-2.18,2.18-2.18h12.53c.32-1.85,1.05-3.55,2.09-5.04l-8.87-8.87c-.85-.85-.85-2.23,0-3.08.85-.85,2.23-.85,3.08,0l8.87,8.87c1.47-1.04,3.19-1.77,5.04-2.09v-12.53c0-1.2.98-2.18,2.18-2.18s2.18.98,2.18,2.18v12.53c1.85.32,3.55,1.05,5.04,2.09l8.87-8.87c.85-.85,2.23-.85,3.08,0,.85.85.85,2.23,0,3.08l-8.89,8.87c1.04,1.47,1.77,3.19,2.09,5.04h12.53c1.2,0,2.18.98,2.18,2.18s-.98,2.18-2.18,2.18Z"/><path d="M213.9,67.63c-2.24,0-4.07,1.83-4.07,4.07v7.38c0,3.15-2.07,5.83-4.91,6.74v56.36h17.97v-56.36c-2.85-.92-4.91-3.59-4.91-6.74v-7.38c0-2.24-1.84-4.07-4.08-4.07h0Z"/><path d="M267.74,242.97c-.98-.98-2.26-1.51-3.64-1.51h-17.57c-.89,3.68-2.33,7.14-4.21,10.31h21.79c2.85,0,5.16-2.32,5.16-5.16-.02-1.38-.55-2.68-1.53-3.64h0Z"/><path d="M161.6,227.08l-16.19-61.61c-1.99-7.6-7.92-13.73-15.45-15.98l-23.7-7.09c-2.72-.81-5.6.74-6.42,3.46-.39,1.32-.25,2.71.4,3.93.65,1.21,1.74,2.1,3.06,2.49l6.75,2.02,4.36,1.31,12.59,3.77c4.11,1.24,7.34,4.57,8.43,8.72l16.19,61.61c3.19,12.14,13.67,20.85,25.98,21.95-2.08-3.52-3.6-7.41-4.44-11.55-5.72-2.26-10-7.04-11.57-13.03h0Z"/></svg>
                        <div class="met-label">4 METs</div>
                        <div class="met-desc">Moderate Work</div>
                    </div>
                    <div class="met-option" data-met="5">
                        <i class="fas fa-person-carry-box"></i>
                        <div class="met-label">5 METs</div>
                        <div class="met-desc">Heavy Work</div>
                    </div>
                    <div class="met-option" data-met="6">
                        <i class="fas fa-person-digging"></i>
                        <div class="met-label">6 METs</div>
                        <div class="met-desc">Very Heavy</div>
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculateEHI()">
                    Calculate
                </button>

                <div class="result-display" id="result-display">
                    <div class="result-zone" id="result-zone">--</div>
                    <div class="result-value" id="result-value">--</div>
                    <p id="result-description">--</p>
                </div>
            </div>
        </div>

        <!-- TAB 3: ABOUT EHI-N -->
        <div id="about-tab" class="tab-content">
            <div id="about-ehi-section" class="section" style="padding-left: 2.5rem;">
                <h2>About EHI-N*</h2>

                <p>The <strong>Extended Heat Index for Laboring Populations (EHI-N*)</strong> is a physiologically-based heat stress metric designed to assess thermal stress in labor-intensive occupations.</p>

                <div style="display: flex; flex-direction: column; align-items: center; margin: 1.5rem 0;">
                    <svg viewBox="0 0 400 160" style="max-width: 400px; width: 100%; height: auto;">
                        <!-- Metabolic Rate label and arrow (shifted left) -->
                        <text x="70" y="18" font-size="11" fill="#006D77" font-weight="600" text-anchor="end">Metabolic Rate</text>
                        <text x="70" y="30" font-size="9" fill="#888" text-anchor="end">(3-6+ METs)</text>
                        <!-- Curved arrow pointing to N -->
                        <path d="M75 15 Q 115 15, 115 50" stroke="#006D77" stroke-width="2" fill="none"/>
                        <polygon points="110,47 115,57 120,47" fill="#006D77"/>

                        <!-- Main EHI-N* text -->
                        <text x="95" y="85" font-size="36" font-weight="700" fill="#666">EHI-</text>
                        <text x="185" y="85" font-size="36" font-weight="700" fill="#006D77">N</text>
                        <text x="215" y="85" font-size="36" font-weight="700" fill="#e65100">*</text>

                        <!-- Sun Exposure arrow and label (shifted up) -->
                        <text x="240" y="60" font-size="18" fill="#e65100"></text>
                        <text x="260" y="55" font-size="11" fill="#e65100" font-weight="600"> Sun Exposure</text>
                        <text x="260" y="67" font-size="9" fill="#888">Direct sunlight included</text>

                        <!-- Examples -->
                        <text x="115" y="120" font-size="12" fill="#78909c"></text>
                        <text x="130" y="120" font-size="11" fill="#666"><tspan font-weight="700">EHI-6</tspan> = Heavy work, shaded</text>
                        <text x="115" y="140" font-size="12" fill="#e65100"></text>
                        <text x="130" y="140" font-size="11" fill="#666"><tspan font-weight="700">EHI-6*</tspan> = Heavy work, full sun</text>
                    </svg>
                </div>

                <h3 onclick="toggleScientificFoundation()" style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                    <i id="scientific-foundation-icon" class="fas fa-chevron-right" style="font-size: 0.8rem; transition: transform 0.2s;"></i>
                    Scientific Foundation
                </h3>
                <div id="scientific-foundation-content" style="padding-left: 1.5rem; display: none;">
                    <p><em>Technical brief coming soon...</em></p>
                </div>
            </div>

            <div id="zones-section" class="section">
                <h2>Heat Stress Zones</h2>
                <p>EHI-N* classifies heat stress into zones based on physiological risk:</p>

                <div style="margin: 1.5rem 0;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button onclick="showZone(1)" id="zone-btn-1" style="padding: 0.5rem 1rem; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 1</button>
                        <button onclick="showZone(2)" id="zone-btn-2" style="padding: 0.5rem 1rem; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 2</button>
                        <button onclick="showZone(3)" id="zone-btn-3" style="padding: 0.5rem 1rem; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 3</button>
                        <button onclick="showZone(4)" id="zone-btn-4" style="padding: 0.5rem 1rem; border: 2px solid var(--caution-yellow); background: white; color: var(--caution-yellow); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 4</button>
                        <button onclick="showZone(5)" id="zone-btn-5" style="padding: 0.5rem 1rem; border: 2px solid var(--warning-orange); background: white; color: var(--warning-orange); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 5</button>
                        <button onclick="showZone(6)" id="zone-btn-6" style="padding: 0.5rem 1rem; border: 2px solid var(--danger-red); background: var(--danger-red); color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 6</button>
                    </div>

                    <div id="zone-content-1" class="zone-content" style="display: none; background: var(--gray-light); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--shram-teal);">
                        <h3 style="color: var(--shram-teal); margin-bottom: 1rem;"><i class="fas fa-snowflake"></i> Zone 1: Hypothermia (Severe Cold Stress)</h3>
                        <p><strong>Physiological State:</strong> Fractional skin coverage provides sufficient control.</p>
                        <p><strong>Characteristics:</strong> The body can maintain thermal equilibrium through minimal adjustments to skin blood flow and clothing.</p>
                    </div>

                    <div id="zone-content-2" class="zone-content" style="display: none; background: var(--gray-light); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--shram-teal);">
                        <h3 style="color: var(--shram-teal); margin-bottom: 1rem;"><i class="fas fa-check-circle"></i> Zone 2: Comfortable (Thermoneutral)</h3>
                        <p><strong>Physiological State:</strong> Clothing adjustment in warm conditions.</p>
                        <p><strong>Characteristics:</strong> Increased skin blood flow while maintaining comfortable clothing levels.</p>
                    </div>

                    <div id="zone-content-3" class="zone-content" style="display: none; background: var(--gray-light); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--shram-teal);">
                        <h3 style="color: var(--shram-teal); margin-bottom: 1rem;"><i class="fas fa-sun"></i> Zone 3: Warm (Manageable Heat)</h3>
                        <p><strong>Physiological State:</strong> Minimal clothing for enhanced evaporative cooling.</p>
                        <p><strong>Characteristics:</strong> Maximum skin blood flow with minimal clothing to maximize heat dissipation.</p>
                    </div>

                    <div id="zone-content-4" class="zone-content" style="display: none; background: #fffde7; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--caution-yellow);">
                        <h3 style="color: var(--caution-yellow); margin-bottom: 1rem;"><i class="fas fa-thermometer-half"></i> Zone 4: Hot (Elevated Risk)</h3>
                        <p><strong>Physiological State:</strong> Cutaneous blood flow becomes limiting.</p>
                        <p><strong>Characteristics:</strong> Skin blood flow reaches maximum capacity. The body relies primarily on sweating for heat dissipation.</p>
                        <p><strong>Recommendations:</strong> Frequent breaks and hydration needed. Monitor workers closely.</p>
                    </div>

                    <div id="zone-content-5" class="zone-content" style="display: none; background: #fff3e0; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--warning-orange);">
                        <h3 style="color: var(--warning-orange); margin-bottom: 1rem;"><i class="fas fa-heartbeat"></i> Zone 5: Very Hot (Cardiovascular Stress)</h3>
                        <p><strong>Physiological State:</strong> Skin saturated with sweat - dripping occurs.</p>
                        <p><strong>Characteristics:</strong> Maximum sweating rate achieved. Sweat drips off skin without evaporating, reducing cooling efficiency.</p>
                        <p><strong>Recommendations:</strong> Limit heavy work. Increase rest periods. Ensure continuous hydration and access to shade.</p>
                    </div>

                    <div id="zone-content-6" class="zone-content" style="background: #ffebee; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--danger-red); border: 2px solid var(--danger-red);">
                        <h3 style="color: var(--danger-red); margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i> Zone 6: Hyperthermia (Severe Heat Stress)</h3>
                        <p><strong>Physiological State:</strong> Core temperature rising - Heat production exceeds dissipation capacity.</p>
                        <p><strong>Characteristics:</strong> All thermoregulatory mechanisms exhausted. Core body temperature is actively increasing, leading to heat illness.</p>
                        <p style="background: white; padding: 1rem; border-radius: 6px; border-left: 4px solid var(--danger-red); margin-top: 1rem;"><strong>HAZARDOUS - IMMEDIATE ACTION REQUIRED:</strong> Cease work immediately. Move to cool environment. Seek medical attention. Risk of heat stroke and organ damage.</p>
                    </div>
                </div>

            </div>

            <div id="subscribe-section" class="section">
                <h2>Subscribe to Heat Stress Alerts</h2>

                <p>Get notified when hazardous heat stress conditions are detected in your location. Free service for workers, employers, and community organizers.</p>

                <div class="alert-box" style="background: #e3f2fd; border-left-color: var(--shram-teal);">
                    <p onclick="toggleHowItWorks()" style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                        <i id="how-it-works-icon" class="fas fa-chevron-right" style="font-size: 0.8rem; transition: transform 0.2s;"></i>
                        <strong>How does alerting work?</strong>
                    </p>
                    <ol id="how-it-works-content" style="margin-left: 1.5rem; margin-top: 0.5rem; display: none;">
                        <li>Select your state and district</li>
                        <li>Choose your MET level (work intensity) and zone alert threshold</li>
                        <li><strong>Live alerts:</strong> You will receive an immediate email if Zone 6 (Hazardous) is detected in your district, regardless of MET level or sun/shade conditions</li>
                        <li><strong>Daily forecast:</strong> Each day you will receive a forecast email for your selected district with your chosen MET level and zone threshold</li>
                    </ol>
                </div>

                <form id="alert-subscription-form" style="background: var(--gray-light); padding: 2rem; border-radius: 10px; margin-top: 1.5rem;">
                    <p style="font-size: 0.8rem; color: #666; margin-bottom: 1rem;"><span style="color: #d32f2f;">*</span> Required fields. If no MET level or zone alert is selected, you will receive Zone 6 alerts for all activity levels.</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="input-group">
                            <label for="subscriber-name" style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Name</label>
                            <input type="text" id="subscriber-name" placeholder="Optional" style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-medium); border-radius: 6px; font-size: 1rem;">
                        </div>

                        <div class="input-group">
                            <label for="subscriber-email" style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Email Address <span style="color: #d32f2f;">*</span></label>
                            <input type="email" id="subscriber-email" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-medium); border-radius: 6px; font-size: 1rem;">
                        </div>

                        <div class="input-group">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Phone Number</label>
                            <p style="color: #666; font-size: 0.95rem; padding: 0.75rem; background: var(--gray-light); border-radius: 6px; border: 2px dashed var(--gray-medium);">
                                <i class="fas fa-mobile-alt" style="margin-right: 0.5rem;"></i>SMS alerts coming soon
                            </p>
                            <input type="hidden" id="subscriber-phone" value="">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="input-group">
                            <label for="subscriber-state" style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">States <span style="color: #d32f2f;">*</span></label>
                            <select id="subscriber-state" required multiple onchange="updateSubscriberDistricts()" style="width: 100%; padding: 0.75rem; border: 2px solid var(--shram-teal); border-radius: 6px; font-size: 1rem; background: white; min-height: 150px;">
                            </select>
                            <small class="multi-select-hint" style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;"><span class="desktop-hint">Hold Ctrl/Cmd to select multiple</span><span class="mobile-hint">Tap to select/deselect multiple</span></small>
                        </div>

                        <div class="input-group">
                            <label for="subscriber-district" style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Districts <span style="color: #d32f2f;">*</span></label>
                            <select id="subscriber-district" required multiple style="width: 100%; padding: 0.75rem; border: 2px solid var(--shram-teal); border-radius: 6px; font-size: 1rem; background: white; min-height: 150px;">
                            </select>
                            <small class="multi-select-hint" style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;"><span class="desktop-hint">Hold Ctrl/Cmd to select multiple</span><span class="mobile-hint">Tap to select/deselect multiple</span></small>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="input-group">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">
                                MET Level (Work Intensity)
                                <span class="info-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text"><strong>MET Level:</strong> Select based on work intensity.<br> EHI-3: Light (walking, light housework)<br> EHI-4: Moderate (carrying loads, cleaning)<br> EHI-5: Heavy (construction, farming)<br> EHI-6: Very Heavy (agricultural labor, heavy lifting)</span>
                                </span>
                            </label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--gray-medium); border-radius: 6px; background: white;">
                                    <input type="checkbox" id="alert-met-3" value="3" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>EHI-3</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--gray-medium); border-radius: 6px; background: white;">
                                    <input type="checkbox" id="alert-met-4" value="4" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>EHI-4</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--gray-medium); border-radius: 6px; background: white;">
                                    <input type="checkbox" id="alert-met-5" value="5" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>EHI-5</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--shram-teal); border-radius: 6px; background: #e3f2fd;">
                                    <input type="checkbox" id="alert-met-6" value="6" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>EHI-6</span>
                                </label>
                            </div>
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">Default: EHI-6 for manual laborers. Select multiple if needed.</small>
                        </div>

                        <div class="input-group">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Zone Alerts</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--caution-yellow); border-radius: 6px; background: #fffde7;">
                                    <input type="checkbox" id="alert-zone-4" value="zone-4" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #b8860b;">Zone 4</span>
                                    <span style="font-size: 0.85rem;">(Caution)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--warning-orange); border-radius: 6px; background: #fff3e0;">
                                    <input type="checkbox" id="alert-zone-5" value="zone-5" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #d84315;">Zone 5</span>
                                    <span style="font-size: 0.85rem;">(High Risk)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--danger-red); border-radius: 6px; background: #ffebee;">
                                    <input type="checkbox" id="alert-zone-6" value="zone-6" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #c62828;">Zone 6</span>
                                    <span style="font-size: 0.85rem;">(Hazardous)</span>
                                </label>
                            </div>
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">Default: Zone 6 only. Receive alerts when conditions reach these zones.</small>
                        </div>
                    </div>

                    <button type="button" onclick="showPrivacyModal()" class="calculate-btn" style="width: 100%; margin-top: 1rem;">
                        <i class="fas fa-bell"></i> Subscribe to Alerts
                    </button>

                    <div id="subscription-message" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 6px; text-align: center; font-weight: 600;"></div>
                </form>
            </div>

            <div id="contact-section" class="section">
                <h2>Contact</h2>

                <p>
                India Energy & Climate Center (IECC)<br>
                University of California, Berkeley</p>

                <p>
                    <i class="fas fa-envelope"></i> <a href="mailto:iecc@berkeley.edu">iecc@berkeley.edu</a><br>
                    <i class="fas fa-globe"></i> <a href="https://iecc.gspp.berkeley.edu" target="_blank">iecc.gspp.berkeley.edu</a>
                </p>

                <button id="api-docs-btn" onclick="toggleApiModal()" style="margin-top: 1rem; background: var(--shram-teal); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                    <i class="fas fa-code"></i> API Documentation
                </button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p><strong>SHRAM: System for Heat Risk Assessment for Manual labor</strong></p>
        <p>Developed by Elif Kl | India Energy & Climate Center | Goldman School of Public Policy | University of California, Berkeley</p>
        <p>Data sources: India Meteorological Department (IMD), ERA5 Reanalysis (ECMWF), Open-Meteo | Updated hourly</p>
        <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
            &copy; 2025
        </p>
    </div>

    <!-- API Documentation Modal -->
    <div id="apiModal" class="api-modal">
        <div class="api-modal-content">
            <div class="api-modal-header">
                <h2 style="margin: 0;"><i class="fas fa-code"></i> API Documentation</h2>
                <button class="api-modal-close" onclick="toggleApiModal()">&times;</button>
            </div>
            <div class="api-modal-body">
                <p>Access real-time heat stress data programmatically through our API.</p>

                <div class="endpoint-grid">
                    <div class="endpoint-card">
                        <h4><i class="fas fa-globe"></i> Get Current Alerts</h4>
                        <div class="endpoint">
                            <button class="method-badge" style="cursor: pointer; border: none;" onclick="copyToClipboard('https://iecc-io.github.io/SHRAM/weather_logs/latest_alerts.json', this)"><i class="fas fa-copy"></i> Copy</button>
                            <span>https://iecc-io.github.io/SHRAM/weather_logs/latest_alerts.json</span>
                        </div>
                        <p><strong>Returns:</strong> Current heat stress zones for all Indian districts</p>
                    </div>

                    <div class="endpoint-card">
                        <h4><i class="fas fa-history"></i> Get 24-Hour History</h4>
                        <div class="endpoint">
                            <button class="method-badge" style="cursor: pointer; border: none;" onclick="copyToClipboard('https://iecc-io.github.io/SHRAM/weather_logs/alerts_24h.json', this)"><i class="fas fa-copy"></i> Copy</button>
                            <span>https://iecc-io.github.io/SHRAM/weather_logs/alerts_24h.json</span>
                        </div>
                        <p><strong>Returns:</strong> Hourly data for last 24 hours with zone distributions</p>
                    </div>

                    <div class="endpoint-card">
                        <h4><i class="fas fa-calendar-alt"></i> Get 3-Day Forecast</h4>
                        <div class="endpoint">
                            <button class="method-badge" style="cursor: pointer; border: none;" onclick="copyToClipboard('https://iecc-io.github.io/SHRAM/weather_logs/forecast_data.json', this)"><i class="fas fa-copy"></i> Copy</button>
                            <span>https://iecc-io.github.io/SHRAM/weather_logs/forecast_data.json</span>
                        </div>
                        <p><strong>Returns:</strong> 72-hour heat stress forecast with EHI predictions</p>
                    </div>

                    <div class="endpoint-card">
                        <h4><i class="fas fa-chart-line"></i> Get Weekly Trends</h4>
                        <div class="endpoint">
                            <button class="method-badge" style="cursor: pointer; border: none;" onclick="copyToClipboard('https://iecc-io.github.io/SHRAM/weather_logs/trends_weekly.json', this)"><i class="fas fa-copy"></i> Copy</button>
                            <span>https://iecc-io.github.io/SHRAM/weather_logs/trends_weekly.json</span>
                        </div>
                        <p><strong>Returns:</strong> Last 4 weeks of daily zone averages</p>
                    </div>

                    <div class="endpoint-card">
                        <h4><i class="fas fa-calendar"></i> Get Monthly Trends</h4>
                        <div class="endpoint">
                            <button class="method-badge" style="cursor: pointer; border: none;" onclick="copyToClipboard('https://iecc-io.github.io/SHRAM/weather_logs/trends_monthly.json', this)"><i class="fas fa-copy"></i> Copy</button>
                            <span>https://iecc-io.github.io/SHRAM/weather_logs/trends_monthly.json</span>
                        </div>
                        <p><strong>Returns:</strong> Last 6 months of weekly zone averages</p>
                    </div>
                </div>

                <h3 style="margin-top: 2rem;"><i class="fas fa-terminal"></i> Example Usage (Python)</h3>
                <pre><code>import requests
import pandas as pd

url = "https://iecc-io.github.io/SHRAM/weather_logs/latest_alerts.json"
data = requests.get(url).json()

df = pd.DataFrame(data['alerts'])
print(f"Zone 6 (hazardous): {data['zone_6_count']}")

hazardous = df[df['Hard Labor Heat Stress Zone'] == 'Zone 6']
print(hazardous[['DISTRICT', 'STATE', 'EHI_350 (in shade C)']])</code></pre>
            </div>
        </div>
    </div>

    <!-- Privacy Notice Modal -->
    <div id="privacyModal" class="api-modal">
        <div class="api-modal-content" style="max-width: 600px;">
            <div class="api-modal-header">
                <h2 style="margin: 0;"><i class="fas fa-shield-alt"></i> Privacy Notice</h2>
            </div>
            <div class="api-modal-body">
                <p style="font-size: 1.1rem; line-height: 1.6;">Your contact information will only be used to send heat stress alerts. We will never share your data with third parties. You can unsubscribe at any time.</p>

                <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                    <button onclick="closePrivacyModal()" style="background: var(--gray-medium); color: var(--gray-dark); border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                        Cancel
                    </button>
                    <button onclick="acceptPrivacyAndSubmit()" style="background: var(--shram-teal); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                        <i class="fas fa-check"></i> I Acknowledge
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Set Chart.js global font to Montserrat
        Chart.defaults.font.family = "'Montserrat', 'Helvetica Neue', Helvetica, Arial, sans-serif";

        // Separate MET levels for each section (dashboard)
        let currentMetStatus = 3;
        let currentMetForecast = 3;
        let currentMetLast24h = 3;
        // MET level for calculator (independent)
        let currentMet = 3;
        let forecastDays = 3;
        let trendPeriod = 'day';  // 'day', 'week', or 'month'
        let alertTrendChart, tempHumidityChart;

        // Mobile-aware chart options
        function isMobile() {
            return window.innerWidth <= 768;
        }

        function isSmallMobile() {
            return window.innerWidth <= 420;
        }

        // Get mobile-optimized line properties (thin lines, no markers)
        function getMobileLineProps() {
            const mobile = isMobile();
            return {
                borderWidth: mobile ? 1.5 : 3,
                pointRadius: mobile ? 0 : 3,
                pointHoverRadius: mobile ? 3 : 5,
                tension: 0.3
            };
        }

        // Get mobile-friendly chart labels
        function getZoneLabel(zone) {
            const mobile = isMobile();
            const labels = {
                6: mobile ? '6' : 'Zone 6 (Hazardous)',
                5: mobile ? '5' : 'Zone 5 (High Risk)',
                4: mobile ? '4' : 'Zone 4 (Elevated)',
                23: mobile ? '2-3' : 'Zone 2-3 (Comfortable)',
                1: mobile ? '1' : 'Zone 1 (Cold)'
            };
            return labels[zone] || `Zone ${zone}`;
        }

        function getTempRHLabel(type) {
            const mobile = isMobile();
            if (type === 'temp') return mobile ? 'T (C)' : 'Temperature (C)';
            if (type === 'rh') return mobile ? 'RH (%)' : 'Relative Humidity (%)';
            return type;
        }

        // Format date labels for mobile (1/2 instead of Feb 01 12:00)
        function formatDateLabel(dateStr, period) {
            const mobile = isMobile();
            if (!mobile) return dateStr;

            // Try to parse and shorten the date
            try {
                const date = new Date(dateStr);
                if (!isNaN(date)) {
                    // For all periods on mobile, just show d/m (date only, no time)
                    return `${date.getDate()}/${date.getMonth()+1}`;
                }
            } catch (e) {}

            // Fallback: try to shorten existing string format
            // "Feb 01 12:00" -> "1/2"
            const match = dateStr.match(/(\w+)\s+(\d+)/);
            if (match) {
                const months = {Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12};
                const m = months[match[1]] || match[1];
                const d = parseInt(match[2]);
                return `${d}/${m}`;
            }
            return dateStr;
        }

        function getChartOptions(type) {
            const mobile = isMobile();
            const small = isSmallMobile();
            const base = {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: {
                        top: small ? 5 : (mobile ? 8 : 10),
                        bottom: small ? 8 : (mobile ? 10 : 10),
                        left: small ? 5 : (mobile ? 8 : 10),
                        right: small ? 5 : (mobile ? 8 : 10)
                    }
                },
                // Mobile: thin lines, no markers for cleaner appearance
                elements: {
                    line: {
                        borderWidth: mobile ? 1.5 : 2,
                        tension: 0.3
                    },
                    point: {
                        radius: mobile ? 0 : 3,
                        hoverRadius: mobile ? 3 : 5
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            boxWidth: small ? 25 : (mobile ? 30 : 40),
                            boxHeight: small ? 4 : (mobile ? 5 : 6),
                            padding: small ? 4 : (mobile ? 6 : 10),
                            font: { size: small ? 8 : (mobile ? 10 : 12) },
                            usePointStyle: false
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: mobile ? 45 : 0,
                            minRotation: mobile ? 45 : 0,
                            font: { size: small ? 8 : (mobile ? 9 : 11), weight: 'bold' },
                            maxTicksLimit: small ? 6 : (mobile ? 8 : 12)
                        },
                        title: { display: !mobile, text: 'Time (IST)' }
                    },
                    y: {
                        ticks: {
                            font: { size: small ? 8 : (mobile ? 9 : 11), weight: 'bold' },
                            color: type === 'temp' ? '#d32f2f' : undefined // Red for temp axis
                        },
                        title: {
                            display: !mobile, // Hide y-axis title on mobile (use colored ticks instead)
                            text: type === 'zone' ? 'Number of Locations' : 'Temperature (C)',
                            font: { size: small ? 8 : (mobile ? 9 : 11) }
                        },
                        beginAtZero: type === 'zone'
                    }
                }
            };
            if (type === 'temp') {
                base.scales.y1 = {
                    type: 'linear',
                    position: 'right',
                    ticks: {
                        font: { size: small ? 8 : (mobile ? 9 : 11), weight: 'bold' },
                        color: '#1976d2' // Blue for humidity axis
                    },
                    title: {
                        display: !mobile, // Hide on mobile
                        text: 'Humidity (%)',
                        font: { size: small ? 8 : (mobile ? 9 : 11) }
                    },
                    grid: { drawOnChartArea: false }
                };
            }
            return base;
        }

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }
            // Also update desktop tabs if navigating from mobile
            document.querySelectorAll('.tab').forEach(t => {
                if (t.textContent.toLowerCase().includes(tabName.replace('livemap', 'live'))) {
                    t.classList.add('active');
                }
            });

            // Track tab views in Google Analytics as virtual page views
            if (typeof gtag === 'function') {
                gtag('event', 'page_view', {
                    page_title: tabName.charAt(0).toUpperCase() + tabName.slice(1) + ' - SHRAM',
                    page_location: window.location.origin + '/' + tabName,
                    page_path: '/' + tabName
                });
            }

            // Fix map sizing when switching to dashboard tab
            if (tabName === 'dashboard' && typeof forecastMap !== 'undefined' && forecastMap) {
                setTimeout(() => forecastMap.invalidateSize(), 100);
            }
        }

        // Mobile hamburger menu functions
        function toggleMobileMenu(event) {
            if (event) event.stopPropagation();
            const menu = document.getElementById('mobile-menu');
            const hamburger = document.querySelector('.hamburger-btn');
            menu.classList.toggle('open');
            hamburger.classList.toggle('open');
            console.log('Menu toggled, open:', menu.classList.contains('open'));
        }

        function mobileMenuSelect(event, tabName) {
            // Close menu
            const menu = document.getElementById('mobile-menu');
            const hamburger = document.querySelector('.hamburger-btn');
            menu.classList.remove('open');
            hamburger.classList.remove('open');

            // Update mobile menu active state
            document.querySelectorAll('.mobile-menu-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // Switch tab
            switchTab(event, tabName);
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('mobile-menu');
            const hamburger = document.querySelector('.hamburger-btn');
            if (menu && hamburger && !menu.contains(e.target) && !hamburger.contains(e.target)) {
                menu.classList.remove('open');
                hamburger.classList.remove('open');
            }
        });

        function toggleBanner(event) {
            if (event) event.stopPropagation();
            const banner = document.getElementById('zone6-banner');
            const toggleBtn = document.getElementById('banner-toggle-btn');

            if (banner.classList.contains('minimized')) {
                banner.classList.remove('minimized');
                toggleBtn.innerHTML = '<i class="fas fa-minus"></i>';
            } else {
                banner.classList.add('minimized');
                toggleBtn.innerHTML = '<i class="fas fa-plus"></i>';
            }
        }

        function toggleHowItWorks() {
            const content = document.getElementById('how-it-works-content');
            const icon = document.getElementById('how-it-works-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        function toggleScientificFoundation() {
            const content = document.getElementById('scientific-foundation-content');
            const icon = document.getElementById('scientific-foundation-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.style.transform = 'rotate(90deg)';
            } else {
                content.style.display = 'none';
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // Toggle banner when clicking anywhere on it (expand/collapse)
        function expandBannerIfMinimized(event) {
            const banner = document.getElementById('zone6-banner');
            // Don't toggle if clicking on a state item or the close button
            if (!event.target.closest('.banner-state-item') &&
                !event.target.closest('.close-btn')) {
                toggleBanner();
            }
        }

        // Navigate to forecast for a specific state (called from Zone 6 banner)
        function showForecastForState(stateName) {
            // Clear any active tooltips (mobile)
            document.querySelectorAll('.tooltip-active').forEach(t => {
                t.classList.remove('tooltip-active');
            });

            // Switch to dashboard tab
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById('dashboard-tab').classList.add('active');
            document.querySelector('.tab[onclick*="dashboard"]').classList.add('active');

            // Set the state dropdown and trigger forecast load
            const stateSelect = document.getElementById('forecast-state-select');
            if (stateSelect) {
                stateSelect.value = stateName;
                // Reset district to 'all' (will use capital)
                const districtSelect = document.getElementById('forecast-district-select');
                if (districtSelect) {
                    districtSelect.value = 'all';
                }
            }

            // Scroll to the forecast section
            const forecastSection = document.getElementById('forecast-content');
            if (forecastSection) {
                forecastSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Load the forecast for this state and zoom map to the state
            setTimeout(() => {
                if (typeof loadForecast === 'function') {
                    loadForecast();
                }
                if (typeof zoomToState === 'function') {
                    zoomToState(stateName);
                }
            }, 300);
        }

        // Position tooltip on hover for banner state items
        document.addEventListener('mouseover', function(e) {
            const stateItem = e.target.closest('.banner-state-item');
            if (stateItem) {
                const tooltip = stateItem.querySelector('.districts-tooltip');
                if (tooltip) {
                    const rect = stateItem.getBoundingClientRect();
                    tooltip.style.left = rect.left + 'px';
                    tooltip.style.top = (rect.bottom + 8) + 'px';
                }
            }
        });

        // Mobile touch support for tooltips
        // On touch devices, first tap shows tooltip, second tap follows link/action
        (function() {
            const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            if (isTouchDevice) {
                document.addEventListener('click', function(e) {
                    // Handle info-tooltip (info icons)
                    const infoTooltip = e.target.closest('.info-tooltip');
                    if (infoTooltip) {
                        if (!infoTooltip.classList.contains('tooltip-active')) {
                            // Remove active class from all tooltips
                            document.querySelectorAll('.tooltip-active').forEach(t => {
                                t.classList.remove('tooltip-active');
                            });
                            infoTooltip.classList.add('tooltip-active');
                            e.preventDefault();
                            e.stopPropagation();
                            return;
                        }
                        // If already active, allow the click through (second tap)
                        return;
                    }

                    // Handle banner-state-item (Zone 6 banner state tooltips)
                    const bannerItem = e.target.closest('.banner-state-item');
                    if (bannerItem) {
                        if (!bannerItem.classList.contains('tooltip-active')) {
                            // Remove active class from all tooltips
                            document.querySelectorAll('.tooltip-active').forEach(t => {
                                t.classList.remove('tooltip-active');
                            });
                            bannerItem.classList.add('tooltip-active');
                            // Position the tooltip
                            const tooltip = bannerItem.querySelector('.districts-tooltip');
                            if (tooltip) {
                                const rect = bannerItem.getBoundingClientRect();
                                tooltip.style.left = Math.max(10, rect.left) + 'px';
                                tooltip.style.top = (rect.bottom + 8) + 'px';
                            }
                            e.preventDefault();
                            e.stopPropagation();
                            return;
                        }
                        // If already active, allow the click through (navigate to forecast)
                        return;
                    }

                    // Handle hoverable stat-boxes (Zone 5/6 stats with tooltips)
                    const hoverableBox = e.target.closest('.stat-box.hoverable');
                    if (hoverableBox) {
                        if (!hoverableBox.classList.contains('tooltip-active')) {
                            // Remove active class from all tooltips
                            document.querySelectorAll('.tooltip-active').forEach(t => {
                                t.classList.remove('tooltip-active');
                            });
                            hoverableBox.classList.add('tooltip-active');
                            e.preventDefault();
                            e.stopPropagation();
                            return;
                        }
                        // If already active, allow the click through (second tap navigates)
                        return;
                    }

                    // Clicking elsewhere removes all active tooltips
                    document.querySelectorAll('.tooltip-active').forEach(t => {
                        t.classList.remove('tooltip-active');
                    });
                }, true);
            }
        })();

        function toggleApiModal() {
            const modal = document.getElementById('apiModal');
            modal.classList.toggle('show');
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.style.background = '#4caf50';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = 'var(--shram-teal)';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function showPrivacyModal() {
            // First validate the form fields
            const form = document.getElementById('alert-subscription-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            const modal = document.getElementById('privacyModal');
            modal.classList.add('show');
        }

        function closePrivacyModal() {
            const modal = document.getElementById('privacyModal');
            modal.classList.remove('show');
        }

        function acceptPrivacyAndSubmit() {
            // Close the modal
            closePrivacyModal();
            // Submit the form
            const form = document.getElementById('alert-subscription-form');
            form.submit();
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const apiModal = document.getElementById('apiModal');
            const privacyModal = document.getElementById('privacyModal');
            if (event.target === apiModal) {
                apiModal.classList.remove('show');
            }
            if (event.target === privacyModal) {
                privacyModal.classList.remove('show');
            }
        }

        let selectedSolar = 0; // Default to shaded

        function selectSolar(value) {
            selectedSolar = value;

            // Update button styles to match MET option styling
            document.querySelectorAll('.solar-option').forEach(btn => {
                if (parseFloat(btn.dataset.solar) === value) {
                    btn.style.border = '2px solid white';
                    btn.style.background = 'white';
                    btn.style.color = 'var(--shram-teal)';
                    btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
                    btn.classList.add('active');
                } else {
                    btn.style.border = '2px solid rgba(255,255,255,0.5)';
                    btn.style.background = 'transparent';
                    btn.style.color = 'white';
                    btn.style.boxShadow = 'none';
                    btn.classList.remove('active');
                }
            });
        }

        let shadeStates = {
            current: true,
            forecast: true,
            last24h: true
        };

        function setShade(section, isShade) {
            shadeStates[section] = isShade;

            const shadeBtn = document.getElementById(`${section}-shade-btn`);
            const sunBtn = document.getElementById(`${section}-sun-btn`);

            if (isShade) {
                // Shade is active
                shadeBtn.style.background = 'var(--shram-teal)';
                shadeBtn.style.color = 'white';
                shadeBtn.style.borderColor = 'var(--shram-teal)';
                sunBtn.style.background = '#e8f4f8';
                sunBtn.style.color = 'var(--shram-teal)';
                sunBtn.style.borderColor = '#e8f4f8';
            } else {
                // Sun is active
                shadeBtn.style.background = '#e8f4f8';
                shadeBtn.style.color = 'var(--shram-teal)';
                shadeBtn.style.borderColor = '#e8f4f8';
                sunBtn.style.background = 'var(--shram-teal)';
                sunBtn.style.color = 'white';
                sunBtn.style.borderColor = 'var(--shram-teal)';
            }

            // Reload data based on section
            if (section === 'forecast') {
                loadForecast();
            } else if (section === 'last24h') {
                loadTrendData();
            } else if (section === 'current') {
                loadLiveData();
            }
        }

        function updateMetButtons(section, metLevel) {
            const prefix = section === 'current' ? 'current' : (section === 'forecast' ? 'forecast' : 'last24h');
            for (let i = 3; i <= 6; i++) {
                const btn = document.getElementById(`${prefix}-met-${i}`);
                if (btn) {
                    if (i === metLevel) {
                        btn.style.background = 'var(--shram-teal)';
                        btn.style.color = 'white';
                        btn.style.borderColor = 'var(--shram-teal)';
                    } else {
                        btn.style.background = '#e8f4f8';
                        btn.style.color = 'var(--shram-teal)';
                        btn.style.borderColor = '#e8f4f8';
                    }
                }
            }
            // Also update hidden select for compatibility
            const select = document.getElementById(`met-select-${section === 'current' ? 'current' : (section === 'forecast' ? 'forecast' : 'last24h')}`);
            if (select) select.value = metLevel;
        }

        function selectMetCurrent(metLevel) {
            currentMetStatus = parseInt(metLevel);
            updateMetButtons('current', currentMetStatus);
            loadLiveData();
        }

        function selectMetForecast(metLevel) {
            currentMetForecast = parseInt(metLevel);
            updateMetButtons('forecast', currentMetForecast);
            loadForecast();
        }

        function selectMetLast24h(metLevel) {
            currentMetLast24h = parseInt(metLevel);
            updateMetButtons('last24h', currentMetLast24h);
            loadTrendData();
        }

        // Legacy function for backward compatibility
        function selectMet(metLevel) {
            const met = parseInt(metLevel);
            currentMetStatus = met;
            currentMetForecast = met;
            currentMetLast24h = met;
            document.querySelectorAll('.met-select-green').forEach(select => {
                select.value = met;
            });
            loadForecast();
            loadTrendData();
            loadLiveData();
        }

        document.querySelectorAll('.met-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.met-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                currentMet = parseInt(this.dataset.met);
            });
        });

        function setForecastDays(days) {
            forecastDays = days;

            // Update button styles - selected is teal filled, unselected is light blue-grey
            const btn1 = document.getElementById('forecast-1day-btn');
            const btn3 = document.getElementById('forecast-3day-btn');
            const btn1Mobile = document.getElementById('forecast-1day-btn-mobile');
            const btn3Mobile = document.getElementById('forecast-3day-btn-mobile');

            if (days === 1) {
                btn1.style.background = 'var(--shram-teal)';
                btn1.style.color = 'white';
                btn1.style.borderColor = 'var(--shram-teal)';
                btn3.style.background = '#e8f4f8';
                btn3.style.color = 'var(--shram-teal)';
                btn3.style.borderColor = '#e8f4f8';
                // Mobile buttons
                if (btn1Mobile) {
                    btn1Mobile.style.background = 'var(--shram-teal)';
                    btn1Mobile.style.color = 'white';
                    btn1Mobile.style.borderColor = 'var(--shram-teal)';
                }
                if (btn3Mobile) {
                    btn3Mobile.style.background = '#e8f4f8';
                    btn3Mobile.style.color = 'var(--shram-teal)';
                    btn3Mobile.style.borderColor = '#e8f4f8';
                }
            } else {
                btn1.style.background = '#e8f4f8';
                btn1.style.color = 'var(--shram-teal)';
                btn1.style.borderColor = '#e8f4f8';
                btn3.style.background = 'var(--shram-teal)';
                btn3.style.color = 'white';
                btn3.style.borderColor = 'var(--shram-teal)';
                // Mobile buttons
                if (btn1Mobile) {
                    btn1Mobile.style.background = '#e8f4f8';
                    btn1Mobile.style.color = 'var(--shram-teal)';
                    btn1Mobile.style.borderColor = '#e8f4f8';
                }
                if (btn3Mobile) {
                    btn3Mobile.style.background = 'var(--shram-teal)';
                    btn3Mobile.style.color = 'white';
                    btn3Mobile.style.borderColor = 'var(--shram-teal)';
                }
            }

            loadForecast();
        }

        function setTrendPeriod(period) {
            trendPeriod = period;

            // Update button styles
            const btnDay = document.getElementById('trend-day-btn');
            const btnWeek = document.getElementById('trend-week-btn');
            const btnMonth = document.getElementById('trend-month-btn');

            [btnDay, btnWeek, btnMonth].forEach(btn => {
                btn.style.background = '#e8f4f8';
                btn.style.color = 'var(--shram-teal)';
                btn.style.borderColor = '#e8f4f8';
            });

            const activeBtn = period === 'day' ? btnDay : (period === 'week' ? btnWeek : btnMonth);
            activeBtn.style.background = 'var(--shram-teal)';
            activeBtn.style.color = 'white';
            activeBtn.style.borderColor = 'var(--shram-teal)';

            // Load appropriate data
            loadTrendData();
        }

        async function loadTrendData() {
            // Map period to file and display settings
            const periodConfig = {
                'day': { file: 'trends_daily.json', labelKey: 'timestamp', labelFormat: 'time' },
                'week': { file: 'trends_weekly.json', labelKey: 'date', labelFormat: 'date' },
                'month': { file: 'trends_monthly.json', labelKey: 'week', labelFormat: 'week' }
            };

            const config = periodConfig[trendPeriod];

            try {
                let response;
                try {
                    response = await fetch(`weather_logs/${config.file}`);
                    if (!response.ok) throw new Error('Local file not found');
                } catch (e) {
                    response = await fetch(`https://iecc-io.github.io/SHRAM/weather_logs/${config.file}`);
                }
                const data = await response.json();

                if (!data.data || data.data.length === 0) {
                    document.getElementById('last24h-timestamp').innerHTML = `<strong>No ${trendPeriod}ly data available yet</strong>`;
                    return;
                }

                // Update timestamp
                const generated = new Date(data.generated).toLocaleString('en-IN', {
                    timeZone: 'Asia/Calcutta',
                    dateStyle: 'medium',
                    timeStyle: 'short'
                });
                document.getElementById('last24h-timestamp').innerHTML = `<strong>Last Updated: ${generated} IST</strong>`;

                // Get MET/sun column key
                const met = currentMetLast24h || 3;
                const sun = shadeStates.last24h ? 'shade' : 'sun';
                const zoneKey = `met${met}_${sun}`;

                const labels = [];
                const zone6Data = [], zone5Data = [], zone4Data = [], zone23Data = [], zone1Data = [];

                data.data.forEach(entry => {
                    // Generate label based on format
                    if (config.labelFormat === 'date') {
                        labels.push(new Date(entry.date).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' }));
                    } else if (config.labelFormat === 'week') {
                        labels.push(entry.week.replace('-W', ' W'));
                    } else if (config.labelFormat === 'time') {
                        // Format timestamp as "Jan 26 14:00"
                        const ts = new Date(entry.timestamp);
                        const dateStr = ts.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                        const timeStr = ts.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: false });
                        labels.push(`${dateStr} ${timeStr}`);
                    } else {
                        labels.push(entry[config.labelKey]);
                    }

                    // Get zone data for this MET/sun combo
                    const zones = entry[zoneKey] || {};
                    zone6Data.push(zones.zone6 || 0);
                    zone5Data.push(zones.zone5 || 0);
                    zone4Data.push(zones.zone4 || 0);
                    zone23Data.push((zones.zone2 || 0) + (zones.zone3 || 0));
                    zone1Data.push(zones.zone1 || 0);
                });

                // Create chart
                const ctxAlert = document.getElementById('alertTrendChart').getContext('2d');
                if (alertTrendChart) alertTrendChart.destroy();

                const lineProps = getMobileLineProps();
                // Format labels for mobile
                const mobileLabels = labels.map(l => formatDateLabel(l, trendPeriod));
                alertTrendChart = new Chart(ctxAlert, {
                    type: 'line',
                    data: {
                        labels: mobileLabels,
                        datasets: [
                            {
                                label: getZoneLabel(6),
                                data: zone6Data,
                                borderColor: '#d32f2f',
                                backgroundColor: 'rgba(211, 47, 47, 0.1)',
                                fill: true,
                                ...lineProps
                            },
                            {
                                label: getZoneLabel(5),
                                data: zone5Data,
                                borderColor: '#e65100',
                                backgroundColor: 'rgba(230, 81, 0, 0.1)',
                                fill: true,
                                ...lineProps
                            },
                            {
                                label: getZoneLabel(4),
                                data: zone4Data,
                                borderColor: '#c79100',
                                backgroundColor: 'rgba(199, 145, 0, 0.1)',
                                fill: true,
                                ...lineProps
                            },
                            {
                                label: getZoneLabel(23),
                                data: zone23Data,
                                borderColor: '#006D77',
                                backgroundColor: 'rgba(0, 109, 119, 0.1)',
                                fill: true,
                                ...lineProps
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: {
                                display: true,
                                text: trendPeriod === 'day' ? 'Last 7 Days (Hourly)' :
                                      trendPeriod === 'week' ? 'Last 4 Weeks (Daily Snapshots)' :
                                      'Last 6 Months (Weekly Snapshots)'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Number of Districts' }
                            }
                        }
                    }
                });

                // Temp/humidity chart - show actual data
                const tempData = [], rhData = [];
                data.data.forEach(entry => {
                    tempData.push(entry.avg_temp || null);
                    rhData.push(entry.avg_rh || null);
                });

                if (tempHumidityChart) tempHumidityChart.destroy();
                const ctxTemp = document.getElementById('tempHumidityChart').getContext('2d');
                const lineProps2 = getMobileLineProps();
                const mobile = isMobile();
                tempHumidityChart = new Chart(ctxTemp, {
                    type: 'line',
                    data: {
                        labels: mobileLabels,
                        datasets: [
                            {
                                label: getTempRHLabel('temp'),
                                data: tempData,
                                borderColor: '#d32f2f',
                                backgroundColor: 'rgba(211, 47, 47, 0.1)',
                                fill: false,
                                yAxisID: 'y',
                                ...lineProps2
                            },
                            {
                                label: getTempRHLabel('rh'),
                                data: rhData,
                                borderColor: '#1976d2',
                                backgroundColor: 'rgba(25, 118, 210, 0.1)',
                                fill: false,
                                yAxisID: 'y1',
                                ...lineProps2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: { position: 'bottom' },
                            title: {
                                display: true,
                                text: trendPeriod === 'day' ? 'Last 7 Days (Hourly Avg)' :
                                      trendPeriod === 'week' ? 'Last 4 Weeks (Daily Avg)' :
                                      'Last 6 Months (Weekly Avg)'
                            }
                        },
                        scales: {
                            x: {
                                ticks: { font: { weight: 'bold' } }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: !mobile, text: 'Temperature (C)' },
                                ticks: { color: '#d32f2f', font: { weight: 'bold' } }, // Red for temperature
                                grid: { drawOnChartArea: true }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: !mobile, text: 'Relative Humidity (%)' },
                                ticks: { color: '#1976d2', font: { weight: 'bold' } }, // Blue for humidity
                                min: 0,
                                max: 100,
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading trend data:', error);
                document.getElementById('last24h-timestamp').innerHTML = `<strong>Error loading ${trendPeriod}ly data</strong>`;
            }
        }

        // Unit conversions
        function celsiusToFahrenheit(c) { return (c * 9/5) + 32; }
        function fahrenheitToCelsius(f) { return (f - 32) * 5/9; }
        function kgToLbs(kg) { return kg * 2.20462; }
        function lbsToKg(lbs) { return lbs / 2.20462; }
        function metersToFeet(m) { return m * 3.28084; }
        function feetToMeters(ft) { return ft / 3.28084; }

        function convertHeight() {
            const heightInput = document.getElementById('height-input');
            const unit = document.getElementById('height-unit').value;
            const currentValue = parseFloat(heightInput.value);

            if (unit === 'ft') {
                heightInput.value = metersToFeet(currentValue).toFixed(2);
                heightInput.placeholder = "5.75";
            } else {
                heightInput.value = feetToMeters(currentValue).toFixed(2);
                heightInput.placeholder = "1.75";
            }
        }

        // Cache for lookup tables
        let lookupTableCache = {};

        async function loadLookupTable(met, sunCondition) {
            const key = `met${met}_${sunCondition}`;
            if (lookupTableCache[key]) {
                return lookupTableCache[key];
            }

            try {
                const filename = `ehi_met${met}_${sunCondition}.json`;
                const response = await fetch(`lookup_tables/${filename}`);
                if (!response.ok) throw new Error('Table not found');
                const data = await response.json();
                lookupTableCache[key] = data;
                return data;
            } catch (error) {
                console.error('Error loading lookup table:', error);
                return null;
            }
        }

        async function calculateEHI() {
            let temp = parseFloat(document.getElementById('temp-input').value);
            const tempUnit = document.getElementById('temp-unit').value;
            const rh = Math.round(parseFloat(document.getElementById('rh-input').value));

            // Validate inputs
            if (isNaN(temp) || isNaN(rh)) {
                alert('Please enter valid temperature and humidity values.');
                return;
            }

            if (tempUnit === 'F') temp = fahrenheitToCelsius(temp);

            // Determine sun condition from selectedSolar
            const sunCondition = selectedSolar > 0 ? 'sun' : 'shade';

            // Load the appropriate lookup table
            const lookupTable = await loadLookupTable(currentMet, sunCondition);
            if (!lookupTable) {
                alert('Could not load EHI lookup table. Please try again.');
                return;
            }

            // Round temperature to nearest 0.5C for lookup
            const tempRounded = (Math.round(temp * 2) / 2).toFixed(1);
            const rhStr = String(Math.min(100, Math.max(0, rh)));

            // Look up EHI and zone
            let ehiValue, zone;
            if (lookupTable.data[tempRounded] && lookupTable.data[tempRounded][rhStr]) {
                [ehiValue, zone] = lookupTable.data[tempRounded][rhStr];
            } else {
                // Temperature out of range
                alert(`Temperature ${tempRounded}C is outside the lookup table range (-40C to 60C).`);
                return;
            }

            const zoneNames = {
                1: "Zone 1: Cold Stress",
                2: "Zone 2: Comfortable",
                3: "Zone 3: Comfortable",
                4: "Zone 4: Caution",
                5: "Zone 5: High Risk",
                6: "Zone 6: HAZARDOUS"
            };

            const zoneColors = {
                1: "#2196f3",
                2: "#4caf50",
                3: "#4caf50",
                4: "#c79100",
                5: "#e65100",
                6: "#d32f2f"
            };

            const descriptions = {
                1: "Cold stress conditions. Ensure adequate insulation.",
                2: "Comfortable conditions for work.",
                3: "Comfortable conditions for work.",
                4: "Caution advised. Take regular breaks and hydrate.",
                5: "High risk. Frequent rest and hydration hazardous.",
                6: "HAZARDOUS: Core temperature rising. Cease work immediately."
            };

            // Build EHI label: EHI-N* where N is MET and * if sun
            const asterisk = (selectedSolar > 0) ? '*' : '';
            const ehiLabel = `EHI-${currentMet}${asterisk}`;

            document.getElementById('result-zone').textContent = zoneNames[zone] || `Zone ${zone}`;
            document.getElementById('result-zone').style.color = zoneColors[zone] || '#333';
            document.getElementById('result-value').textContent = `${ehiLabel}: ${ehiValue.toFixed(1)}C`;
            document.getElementById('result-description').textContent = descriptions[zone] || '';
            document.getElementById('result-display').classList.add('show');
        }

        function countUniqueDistricts(alerts) {
            return new Set(alerts.map(a => `${a.STATE}_${a.DISTRICT}`)).size;
        }

        // Global data storage
        let allAlertsData = null;
        let all24HourData = null;

        // Populate state dropdowns from data
        function populateStateDropdowns(alerts) {
            const availableStates = [...new Set(alerts.map(a => a.STATE))].sort();

            // All Indian states/UTs for reference (title case to match IMD data format)
            const allStates = [
                'Andaman And Nicobar', 'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar',
                'Chandigarh', 'Chhattisgarh', 'Dadra And Nagar Haveli', 'Daman And Diu', 'Delhi',
                'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jammu And Kashmir', 'Jharkhand',
                'Karnataka', 'Kerala', 'Ladakh', 'Lakshadweep', 'Madhya Pradesh', 'Maharashtra',
                'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Puducherry', 'Punjab',
                'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh',
                'Uttarakhand', 'West Bengal'
            ].sort();

            // Current Status dropdowns - make all states clickable, even if no current data
            // (unavailable states will show last available data from 24h history)
            const currentStateSelect = document.getElementById('current-state-select');
            currentStateSelect.innerHTML = '<option value="all">All India</option>';
            allStates.forEach(state => {
                const isAvailable = availableStates.includes(state);
                // Use disabled for grey styling, but we'll enable selection via JS
                const label = isAvailable ? state : `${state} (last available)`;
                const disabled = isAvailable ? '' : 'disabled';
                currentStateSelect.innerHTML += `<option value="${state}" ${disabled}>${label}</option>`;
            });

            // NOTE: Forecast dropdowns are populated separately from india_districts.json
            // by loadIndiaDistrictsData() - do NOT populate them here with uppercase names

            // Charts dropdowns - make all states clickable
            const chartsStateSelect = document.getElementById('charts-state-select');
            chartsStateSelect.innerHTML = '<option value="all">All India</option>';
            allStates.forEach(state => {
                const isAvailable = availableStates.includes(state);
                // Use disabled for grey styling, but we'll enable selection via JS
                const label = isAvailable ? state : `${state} (last available)`;
                const disabled = isAvailable ? '' : 'disabled';
                chartsStateSelect.innerHTML += `<option value="${state}" ${disabled}>${label}</option>`;
            });

            // Enable selection of "disabled" options by temporarily enabling them on mousedown
            enableDisabledOptions(currentStateSelect);
            enableDisabledOptions(chartsStateSelect);
        }

        // Helper function to allow clicking on disabled options (for greyed-out styling)
        function enableDisabledOptions(selectElement) {
            selectElement.addEventListener('mousedown', function(e) {
                // Temporarily enable all disabled options
                const disabledOptions = this.querySelectorAll('option[disabled]');
                disabledOptions.forEach(opt => opt.removeAttribute('disabled'));
            });
            selectElement.addEventListener('change', function() {
                // Re-disable options after selection (will be reset on next populateStateDropdowns call)
            });
        }

        // Update district dropdowns based on selected state
        function updateCurrentDistricts() {
            const stateSelect = document.getElementById('current-state-select');
            const districtSelect = document.getElementById('current-district-select');
            const selectedState = stateSelect.value;

            if (selectedState === 'all') {
                districtSelect.innerHTML = '<option value="all" class="available">All Districts</option>';
                return;
            }

            // First try to get districts from current alerts
            let districts = [];
            let isHistorical = false;

            if (allAlertsData) {
                districts = [...new Set(
                    allAlertsData.alerts
                        .filter(a => a.STATE === selectedState)
                        .map(a => a.DISTRICT)
                )].sort();
            }

            // If no current districts, try to find from 24h historical data
            if (districts.length === 0 && all24HourData && all24HourData.hourly_alerts) {
                const normalizedState = normalizeLocationName(selectedState);
                const allHistoricalDistricts = new Set();

                all24HourData.hourly_alerts.forEach(entry => {
                    const stations = entry.alerts || entry.stations || [];
                    stations.forEach(s => {
                        if (normalizeLocationName(s.STATE) === normalizedState) {
                            allHistoricalDistricts.add(s.DISTRICT);
                        }
                    });
                });

                districts = [...allHistoricalDistricts].sort();
                isHistorical = districts.length > 0;
            }

            // Use disabled attribute for grey styling on historical data
            const headerText = isHistorical ? 'All Districts (last available)' : 'All Districts';
            const headerDisabled = isHistorical ? 'disabled' : '';
            districtSelect.innerHTML = `<option value="all" ${headerDisabled}>${headerText}</option>`;
            districts.forEach(district => {
                const label = district.replace(/_/g, ' ');
                const disabled = isHistorical ? 'disabled' : '';
                districtSelect.innerHTML += `<option value="${district}" ${disabled}>${label}${isHistorical ? ' (last available)' : ''}</option>`;
            });
            // Enable selection of disabled options
            enableDisabledOptions(districtSelect);
        }

        function updateForecastDistricts() {
            const stateSelect = document.getElementById('forecast-state-select');
            const districtSelect = document.getElementById('forecast-district-select');
            const selectedState = stateSelect.value;

            console.log('updateForecastDistricts called, selectedState:', selectedState);
            console.log('window.indiaDistrictsData available:', !!window.indiaDistrictsData);

            // Use window.indiaDistrictsData for forecast districts
            if (!window.indiaDistrictsData || selectedState === 'all') {
                districtSelect.innerHTML = '<option value="all" class="available">All Districts (Capital)</option>';
                return;
            }

            const stateData = window.indiaDistrictsData.states[selectedState];
            console.log('stateData for', selectedState, ':', stateData ? 'found' : 'NOT FOUND');

            if (!stateData) {
                districtSelect.innerHTML = '<option value="all" class="available">All Districts</option>';
                return;
            }

            const districts = Object.keys(stateData.districts).sort();
            console.log('Found', districts.length, 'districts for', selectedState);

            districtSelect.innerHTML = `<option value="all" class="available">All Districts (${stateData.capital.name})</option>`;
            districts.forEach(district => {
                districtSelect.innerHTML += `<option value="${district}" class="available">${district.replace(/_/g, ' ')}</option>`;
            });
        }

        // State name mapping for GeoJSON files
        function getGeoJSONStateName(stateName) {
            // Map from india_districts.json names to geojson file names
            const mapping = {
                'Andhra_Pradesh': 'andhra_pradesh',
                'Arunachal_Pradesh': 'arunachal_pradesh',
                'Assam': 'assam',
                'Bihar': 'bihar',
                'Chhattisgarh': 'chhattisgarh',
                'Goa': 'goa',
                'Gujarat': 'gujarat',
                'Haryana': 'haryana',
                'Himachal_Pradesh': 'himachal_pradesh',
                'Jharkhand': 'jharkhand',
                'Karnataka': 'karnataka',
                'Kerala': 'kerala',
                'Madhya_Pradesh': 'madhya_pradesh',
                'Maharashtra': 'maharashtra',
                'Manipur': 'manipur',
                'Meghalaya': 'meghalaya',
                'Mizoram': 'mizoram',
                'Nagaland': 'nagaland',
                'Odisha': 'odisha',
                'Punjab': 'punjab',
                'Rajasthan': 'rajasthan',
                'Sikkim': 'sikkim',
                'Tamil_Nadu': 'tamil_nadu',
                'Telangana': 'telangana',
                'Tripura': 'tripura',
                'Uttar_Pradesh': 'uttar_pradesh',
                'Uttarakhand': 'uttarakhand',
                'West_Bengal': 'west_bengal',
                'Andaman_and_Nicobar': 'andaman_and_nicobar_islands',
                'Chandigarh': 'chandigarh',
                'Dadra_and_Nagar_Haveli': 'dadra_and_nagar_haveli_and_daman_and_diu',
                'Delhi': 'delhi',
                'Jammu_and_Kashmir': 'jammu_and_kashmir',
                'Ladakh': 'ladakh',
                'Lakshadweep': 'lakshadweep',
                'Puducherry': 'puducherry'
            };
            return mapping[stateName] || stateName.toLowerCase();
        }

        // Reset forecast map to default view (all of India)
        function resetForecastMap() {
            if (forecastMap) {
                forecastMap.setView([23, 82], 4.4);
                // Reset state selection
                document.getElementById('forecast-state-select').value = 'all';
                document.getElementById('selected-location-label').textContent = '';
                // Reload states layer
                loadAllStates();
            }
        }

        // Initialize the forecast map with all states
        async function initForecastMap() {
            const instruction = document.getElementById('map-instruction');
            const label = document.getElementById('selected-location-label');

            // Initialize map
            forecastMap = L.map('forecast-map', {
                zoomControl: true,
                attributionControl: false
            }).setView([23, 82], 4.4);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(forecastMap);

            // Add IECC logo marker at Berkeley office location
            const ieccIcon = L.divIcon({
                className: 'iecc-marker',
                html: '<img src="iecc-logo.svg" style="height: 18px;">',
                iconSize: [60, 18],
                iconAnchor: [30, 9]
            });
            L.marker([37.8755, -122.2618], { icon: ieccIcon })
                .bindTooltip(`
                    <div style="text-align: center; min-width: 150px;">
                        <div style="font-weight: 600; color: #2d637f; margin-bottom: 0.5rem;">
                            <i class="fas fa-users"></i> Heat Resilience Team
                        </div>
                        <div style="font-size: 0.8rem; line-height: 1.5;">
                            <div style="font-weight: 600;">Elif Kilic <span style="font-weight: 400; color: #666; font-size: 0.7rem;">(Lead)</span></div>
                            <div>Rohini Tamarana</div>
                            <div>Piyush Narang</div>
                            <div>Fernando Augusto</div>
                            <div>Shruti Deorah</div>
                            <div>Prof. Ashok Gadgil</div>
                        </div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 0.5rem; border-top: 1px solid #eee; padding-top: 0.5rem;">
                            India Energy & Climate Center<br>UC Berkeley
                        </div>
                        <div style="font-size: 0.65rem; color: #2d637f; margin-top: 0.3rem;">
                            <i class="fas fa-mouse-pointer"></i> Click to visit team page
                        </div>
                    </div>
                `, { direction: 'top', offset: [0, -5] })
                .on('click', function() {
                    window.open('https://iecc.gspp.berkeley.edu/about/team/', '_blank');
                })
                .addTo(forecastMap);

            // Load states GeoJSON
            try {
                const response = await fetch('geojson/india_states.geojson');
                if (!response.ok) throw new Error('Could not load states GeoJSON');
                statesGeoJSON = await response.json();
                showAllStates();
            } catch (error) {
                console.error('Error loading states GeoJSON:', error);
                instruction.textContent = 'Error loading map data';
            }
        }

        // Show all states on the map
        function showAllStates() {
            const instruction = document.getElementById('map-instruction');
            const label = document.getElementById('selected-location-label');

            // Reset state
            currentSelectedState = null;
            selectedDistrictCoords = null;
            document.getElementById('forecast-state-select').value = 'all';

            instruction.innerHTML = '<i class="fas fa-hand-pointer"></i> Click on a state to select it:';
            label.textContent = '';

            // Remove district layer if exists
            if (districtLayer) {
                forecastMap.removeLayer(districtLayer);
                districtLayer = null;
            }

            // Remove states layer if exists
            if (statesLayer) {
                forecastMap.removeLayer(statesLayer);
            }

            // Add states layer
            if (statesGeoJSON) {
                statesLayer = L.geoJSON(statesGeoJSON, {
                    style: {
                        fillColor: '#2d637f',
                        fillOpacity: 0.4,
                        color: '#2d637f',
                        weight: 2
                    },
                    onEachFeature: function(feature, layer) {
                        const stateName = feature.properties.name;

                        layer.bindTooltip(stateName.replace(/_/g, ' '), {
                            permanent: false,
                            direction: 'center',
                            className: 'district-tooltip'
                        });

                        layer.on('click', function() {
                            zoomToState(stateName);
                        });

                        layer.on('mouseover', function() {
                            layer.setStyle({ fillOpacity: 0.7 });
                        });

                        layer.on('mouseout', function() {
                            layer.setStyle({ fillOpacity: 0.4 });
                        });
                    }
                }).addTo(forecastMap);

                // Fit to India bounds
                forecastMap.fitBounds(statesLayer.getBounds(), { padding: [10, 10] });
            }

            // Show "select a state" in forecast
            loadForecast();
        }

        // Zoom to a specific state and show its districts
        async function zoomToState(stateName) {
            const instruction = document.getElementById('map-instruction');
            const label = document.getElementById('selected-location-label');

            currentSelectedState = stateName;
            document.getElementById('forecast-state-select').value = stateName;

            instruction.innerHTML = `<i class="fas fa-map-marker-alt"></i> Click on a district in <strong>${stateName.replace(/_/g, ' ')}</strong>:`;
            label.textContent = 'Loading districts...';

            // Update states layer to show shaded (other states clickable)
            if (statesLayer) {
                forecastMap.removeLayer(statesLayer);
            }

            // Re-add states layer with shaded style (other states visible and clickable)
            if (statesGeoJSON) {
                statesLayer = L.geoJSON(statesGeoJSON, {
                    style: function(feature) {
                        const isCurrentState = feature.properties.name === stateName;
                        return {
                            fillColor: '#2d637f',
                            fillOpacity: isCurrentState ? 0 : 0.2,  // Hide fill for current state (districts will show)
                            color: '#2d637f',
                            weight: isCurrentState ? 0 : 1
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const featureStateName = feature.properties.name;
                        if (featureStateName !== stateName) {
                            layer.bindTooltip(featureStateName.replace(/_/g, ' '), {
                                permanent: false,
                                direction: 'center',
                                className: 'district-tooltip'
                            });

                            layer.on('click', function() {
                                zoomToState(featureStateName);
                            });

                            layer.on('mouseover', function() {
                                layer.setStyle({ fillOpacity: 0.5 });
                            });

                            layer.on('mouseout', function() {
                                layer.setStyle({ fillOpacity: 0.2 });
                            });
                        }
                    }
                }).addTo(forecastMap);
            }

            // Load district GeoJSON for this state
            try {
                const geoJSONName = getGeoJSONStateName(stateName);
                const response = await fetch(`geojson/${geoJSONName}_districts.geojson`);

                if (!response.ok) {
                    throw new Error(`GeoJSON not found for ${stateName}`);
                }

                const geojsonData = await response.json();

                // Remove old district layer
                if (districtLayer) {
                    forecastMap.removeLayer(districtLayer);
                }

                // Add district layer with IECC blue
                districtLayer = L.geoJSON(geojsonData, {
                    style: {
                        fillColor: '#2d637f',
                        fillOpacity: 0.3,
                        color: '#2d637f',
                        weight: 2
                    },
                    onEachFeature: function(feature, layer) {
                        const districtName = feature.properties.name;
                        const centroid = feature.properties.centroid;

                        layer.bindTooltip(districtName.replace(/_/g, ' '), {
                            permanent: false,
                            direction: 'center',
                            className: 'district-tooltip'
                        });

                        layer.on('click', function() {
                            // Highlight selected district - reset others to IECC blue
                            districtLayer.eachLayer(l => {
                                l.setStyle({ fillColor: '#2d637f', fillOpacity: 0.3 });
                            });
                            // Set selected district to IECC brown
                            layer.setStyle({ fillColor: '#8B5A2B', fillOpacity: 0.6 });

                            // Store coordinates
                            selectedDistrictCoords = {
                                name: districtName,
                                lat: centroid[1],
                                lon: centroid[0]
                            };

                            label.textContent = `Selected: ${districtName.replace(/_/g, ' ')}`;
                            document.getElementById('forecast-district-select').value = districtName;
                            loadForecast();
                        });

                        layer.on('mouseover', function() {
                            if (!selectedDistrictCoords || selectedDistrictCoords.name !== districtName) {
                                layer.setStyle({ fillOpacity: 0.5 });
                            }
                        });

                        layer.on('mouseout', function() {
                            if (!selectedDistrictCoords || selectedDistrictCoords.name !== districtName) {
                                layer.setStyle({ fillOpacity: 0.3 });
                            }
                        });
                    }
                }).addTo(forecastMap);

                // Fit to state bounds
                forecastMap.fitBounds(districtLayer.getBounds(), { padding: [20, 20] });

                // Use state capital for initial forecast
                if (window.indiaDistrictsData && window.indiaDistrictsData.states[stateName]) {
                    const capital = window.indiaDistrictsData.states[stateName].capital;
                    selectedDistrictCoords = {
                        name: capital.name,
                        lat: capital.lat,
                        lon: capital.lon
                    };
                    label.textContent = `State capital: ${capital.name} (click a district to change)`;
                    loadForecast();
                } else {
                    label.textContent = 'Click on a district';
                }

            } catch (error) {
                console.error('Error loading district GeoJSON:', error);
                label.textContent = `Districts not available - using state capital`;

                // Fall back to state capital
                if (window.indiaDistrictsData && window.indiaDistrictsData.states[stateName]) {
                    const capital = window.indiaDistrictsData.states[stateName].capital;
                    selectedDistrictCoords = {
                        name: capital.name,
                        lat: capital.lat,
                        lon: capital.lon
                    };
                    loadForecast();
                }
            }
        }

        // Keep onStateSelected for compatibility but redirect to map
        function onStateSelected() {
            const selectedState = document.getElementById('forecast-state-select').value;
            if (selectedState === 'all') {
                showAllStates();
            } else {
                zoomToState(selectedState);
            }
        }

        function updateChartsDistricts() {
            const stateSelect = document.getElementById('charts-state-select');
            const districtSelect = document.getElementById('charts-district-select');
            const selectedState = stateSelect.value;

            if (selectedState === 'all') {
                districtSelect.innerHTML = '<option value="all" class="available">All Districts</option>';
                return;
            }

            // First try to get districts from current alerts
            let districts = [];
            let isHistorical = false;

            if (allAlertsData) {
                districts = [...new Set(
                    allAlertsData.alerts
                        .filter(a => a.STATE === selectedState)
                        .map(a => a.DISTRICT)
                )].sort();
            }

            // If no current districts, try to find from 24h historical data
            if (districts.length === 0 && all24HourData && all24HourData.hourly_alerts) {
                const normalizedState = normalizeLocationName(selectedState);
                const allHistoricalDistricts = new Set();

                all24HourData.hourly_alerts.forEach(entry => {
                    const stations = entry.alerts || entry.stations || [];
                    stations.forEach(s => {
                        if (normalizeLocationName(s.STATE) === normalizedState) {
                            allHistoricalDistricts.add(s.DISTRICT);
                        }
                    });
                });

                districts = [...allHistoricalDistricts].sort();
                isHistorical = districts.length > 0;
            }

            // Use disabled attribute for grey styling on historical data
            const headerText = isHistorical ? 'All Districts (last available)' : 'All Districts';
            const headerDisabled = isHistorical ? 'disabled' : '';
            districtSelect.innerHTML = `<option value="all" ${headerDisabled}>${headerText}</option>`;
            districts.forEach(district => {
                const label = district.replace(/_/g, ' ');
                const disabled = isHistorical ? 'disabled' : '';
                districtSelect.innerHTML += `<option value="${district}" ${disabled}>${label}${isHistorical ? ' (last available)' : ''}</option>`;
            });
            // Enable selection of disabled options
            enableDisabledOptions(districtSelect);
        }

        // Helper to normalize state/district names for comparison
        function normalizeLocationName(str) {
            return str ? str.toLowerCase().replace(/_/g, ' ').trim() : '';
        }

        // Find last available data from 24h history for a state/district
        function findLastAvailableData(selectedState, selectedDistrict) {
            if (!all24HourData || !all24HourData.hourly_alerts) return null;

            const hourlySource = all24HourData.hourly_alerts;
            const normalizedState = normalizeLocationName(selectedState);
            const normalizedDistrict = selectedDistrict !== 'all' ? normalizeLocationName(selectedDistrict) : null;

            // Search from most recent to oldest
            for (let i = hourlySource.length - 1; i >= 0; i--) {
                const entry = hourlySource[i];
                const stations = entry.alerts || entry.stations || [];

                let matchingStations = stations.filter(s =>
                    normalizeLocationName(s.STATE) === normalizedState
                );

                if (normalizedDistrict) {
                    matchingStations = matchingStations.filter(s =>
                        normalizeLocationName(s.DISTRICT) === normalizedDistrict
                    );
                }

                if (matchingStations.length > 0) {
                    return {
                        timestamp: entry.timestamp,
                        alerts: matchingStations
                    };
                }
            }
            return null;
        }

        // Filter current status based on selected state/district
        function filterCurrentStatus() {
            if (!allAlertsData) return;

            const selectedState = document.getElementById('current-state-select').value;
            const selectedDistrict = document.getElementById('current-district-select').value;

            let filteredAlerts = allAlertsData.alerts;
            let isHistoricalData = false;
            let dataTimestamp = allAlertsData.timestamp;

            if (selectedState !== 'all') {
                filteredAlerts = filteredAlerts.filter(a => a.STATE === selectedState);
            }
            if (selectedDistrict !== 'all') {
                filteredAlerts = filteredAlerts.filter(a => a.DISTRICT === selectedDistrict);
            }

            // If no current data found, try to get last available from 24h history
            if (filteredAlerts.length === 0 && selectedState !== 'all') {
                const historicalData = findLastAvailableData(selectedState, selectedDistrict);
                if (historicalData) {
                    filteredAlerts = historicalData.alerts;
                    dataTimestamp = historicalData.timestamp;
                    isHistoricalData = true;
                }
            }

            // Recalculate zone counts using the correct column names
            const zone6Count = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 6").length;
            const zone5Count = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 5").length;
            const zone4Count = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 4").length;
            const totalDistricts = countUniqueDistricts(filteredAlerts);

            // Update display
            const locationText = selectedState === 'all' ? 'All India' :
                (selectedDistrict === 'all' ? selectedState.replace(/_/g, ' ') :
                selectedDistrict.replace(/_/g, ' ') + ', ' + selectedState.replace(/_/g, ' '));

            const formattedTimestamp = new Date(dataTimestamp).toLocaleString('en-IN', {
                timeZone: 'Asia/Calcutta',
                dateStyle: 'medium',
                timeStyle: 'short'
            });

            // Show warning and red timestamp if using historical data
            const timestampLabel = isHistoricalData ? 'Last Data Available' : 'Last Updated';
            const timestampStyle = isHistoricalData
                ? 'background: #ffebee; color: #c62828; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #ef9a9a;'
                : '';

            // Update global timestamp only - show red warning style if historical data, otherwise normal
            // Note: last24h-timestamp is managed independently by load24HourData()
            if (isHistoricalData) {
                document.getElementById('global-timestamp').innerHTML = `
                    <span style="background: #ffebee; color: #c62828; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #ef9a9a; display: inline-block;">
                        <i class="fas fa-history"></i> <strong>Last Data Available: ${formattedTimestamp} IST</strong>
                        <br><small style="font-weight: normal;">No current IMD data for this location</small>
                    </span>
                `;
            } else {
                // Reset to normal timestamp style
                document.getElementById('global-timestamp').innerHTML = `<strong>Last Updated: ${formattedTimestamp} IST</strong>`;
            }

            document.getElementById('live-status-summary').innerHTML = `
                <p style="text-align: center; font-size: 1.2rem; color: #333;">
                    <strong>${filteredAlerts.length}</strong> stations in <strong>${locationText}</strong> across <strong>${totalDistricts}</strong> districts
                </p>
            `;

            // Get zone-specific districts for tooltips
            const zone6 = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 6");
            const zone5 = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 5");

            const noAlertsMessage = isHistoricalData ?
                '<p style="margin-top: 0.5rem; font-style: italic;">No alerts in last available data</p>' :
                '<p style="margin-top: 0.5rem; font-style: italic;">No alerts currently</p>';

            const zone6DistrictsList = zone6.length > 0 ?
                `<div class="districts-list">${zone6.map(a => `${a.DISTRICT.replace(/_/g, ' ')}, ${a.STATE.replace(/_/g, ' ')}`).join('<br>')}</div>` :
                noAlertsMessage;

            const zone5DistrictsList = zone5.length > 0 ?
                `<div class="districts-list">${zone5.map(a => `${a.DISTRICT.replace(/_/g, ' ')}, ${a.STATE.replace(/_/g, ' ')}`).join('<br>')}</div>` :
                noAlertsMessage;

            document.getElementById('status-grid').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number" style="font-size: 1.8rem;">${filteredAlerts.length}</div>
                    <div class="stat-label" style="font-size: 0.85rem;">Total Alerts</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number" style="font-size: 1.8rem;">${totalDistricts}</div>
                    <div class="stat-label" style="font-size: 0.85rem;">Districts Affected</div>
                </div>
                <div class="stat-box hoverable" style="background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%); padding: 1rem; cursor: pointer; border-color: #d32f2f;" onclick="switchTab(event, 'about')">
                    <div class="stat-number" style="font-size: 1.8rem;">${zone6Count}</div>
                    <div class="stat-label" style="font-size: 0.85rem;">Zone 6 (Hazardous)</div>
                    <div class="zone-tooltip tooltip-down" style="border-color: #d32f2f;">
                        <h4 style="color: #d32f2f;"><i class="fas fa-exclamation-triangle"></i> Zone 6: Hyperthermia (HAZARDOUS)</h4>
                        <p><strong>Action Required:</strong> Core temperature rising - cease work immediately. Move to cool environment. Seek medical attention.</p>
                        ${zone6DistrictsList}
                        <span class="learn-more-link"><i class="fas fa-info-circle"></i> Click to learn more about EHI zones</span>
                    </div>
                </div>
                <div class="stat-box hoverable" style="background: linear-gradient(135deg, #e65100 0%, #d84315 100%); padding: 1rem; cursor: pointer; border-color: #e65100;" onclick="switchTab(event, 'about')">
                    <div class="stat-number" style="font-size: 1.8rem;">${zone5Count}</div>
                    <div class="stat-label" style="font-size: 0.85rem;">Zone 5 (High)</div>
                    <div class="zone-tooltip tooltip-down" style="border-color: #e65100;">
                        <h4 style="color: #e65100;"><i class="fas fa-heartbeat"></i> Zone 5: Very Hot (Cardiovascular Stress)</h4>
                        <p><strong>Action Required:</strong> Limit heavy work. Increase rest periods. Ensure continuous hydration and access to shade.</p>
                        ${zone5DistrictsList}
                        <span class="learn-more-link"><i class="fas fa-info-circle"></i> Click to learn more about EHI zones</span>
                    </div>
                </div>
            `;

            // Update mobile location summary (shown under tiles on mobile)
            const locationSummary = document.getElementById('current-location-summary');
            if (locationSummary) {
                locationSummary.textContent = `${filteredAlerts.length} stations in ${locationText} across ${totalDistricts} districts`;
                locationSummary.style.display = window.innerWidth <= 768 ? 'block' : 'none';
            }

            // Note: Zone 6 banner is NOT updated here - it stays global (set in loadLiveData)
        }

        async function loadLiveData() {
            try {
                // Try local file first (for local development), then fall back to GitHub Pages
                let response;
                try {
                    response = await fetch('weather_logs/latest_alerts.json');
                    if (!response.ok) throw new Error('Local file not found');
                } catch (e) {
                    response = await fetch('https://iecc-io.github.io/SHRAM/weather_logs/latest_alerts.json');
                }
                const data = await response.json();

                // Store data globally for filtering
                allAlertsData = data;

                // Populate state dropdowns
                populateStateDropdowns(data.alerts);

                // Get current MET level and sun condition for "Current" section
                const met = currentMetStatus || 6;
                const sun = shadeStates.current ? 'shade' : 'sun';
                const zoneCol = `Zone_${met}_${sun}`;
                const ehiCol = `EHI_${met}_${sun}`;

                // Get zone counts for selected MET/sun from zone_counts object
                const zoneCountKey = `met${met}_${sun}`;
                const zone6Count = data.zone_counts ? (data.zone_counts[`${zoneCountKey}_zone6`] || 0) : data.zone_6_count;
                const zone5Count = data.zone_counts ? (data.zone_counts[`${zoneCountKey}_zone5`] || 0) : data.zone_5_count;

                const lastUpdate = new Date(data.timestamp).toLocaleString('en-IN', {
                    timeZone: 'Asia/Calcutta',
                    dateStyle: 'medium',
                    timeStyle: 'short'
                });

                // Update global timestamp only - last24h-timestamp is managed independently by load24HourData()
                document.getElementById('global-timestamp').innerHTML = `<strong>Last Updated: ${lastUpdate} IST</strong>`;

                // Filter alerts for selected MET/sun (only Zone 5 & 6 are alerts)
                const zone6 = data.alerts.filter(a => a[zoneCol] === "Zone 6");
                const zone5 = data.alerts.filter(a => a[zoneCol] === "Zone 5");
                const alertCount = zone6.length + zone5.length;
                const totalDistricts = countUniqueDistricts([...zone6, ...zone5]);

                // Summary is set by global-timestamp, so just clear live-status-summary
                document.getElementById('live-status-summary').innerHTML = '';

                const zone6DistrictsList = zone6.length > 0 ?
                    `<div class="districts-list">${zone6.map(a => `${a.DISTRICT}, ${a.STATE}`).join('<br>')}</div>` :
                    '<p style="margin-top: 0.5rem; font-style: italic;">No alerts currently</p>';

                const zone5DistrictsList = zone5.length > 0 ?
                    `<div class="districts-list">${zone5.map(a => `${a.DISTRICT}, ${a.STATE}`).join('<br>')}</div>` :
                    '<p style="margin-top: 0.5rem; font-style: italic;">No alerts currently</p>';

                document.getElementById('status-grid').innerHTML = `
                    <div class="stat-box">
                        <div class="stat-number" style="font-size: 1.8rem;">${alertCount}</div>
                        <div class="stat-label" style="font-size: 0.85rem;">Total Alerts (Zone 5 & 6)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" style="font-size: 1.8rem;">${totalDistricts}</div>
                        <div class="stat-label" style="font-size: 0.85rem;">Districts Affected</div>
                    </div>
                    <div class="stat-box hoverable" style="background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%); padding: 1rem; cursor: pointer; border-color: #d32f2f;" onclick="switchTab(event, 'about')">
                        <div class="stat-number" style="font-size: 1.8rem;">${zone6.length}</div>
                        <div class="stat-label" style="font-size: 0.85rem;">Zone 6 (Hazardous)</div>
                        <div class="zone-tooltip tooltip-down" style="border-color: #d32f2f;">
                            <h4 style="color: #d32f2f;"><i class="fas fa-exclamation-triangle"></i> Zone 6: Hyperthermia (HAZARDOUS)</h4>
                            <p><strong>Action Required:</strong> Core temperature rising - cease work immediately. Move to cool environment. Seek medical attention.</p>
                            ${zone6DistrictsList}
                            <span class="learn-more-link"><i class="fas fa-info-circle"></i> Click to learn more about EHI zones</span>
                        </div>
                    </div>
                    <div class="stat-box hoverable" style="background: linear-gradient(135deg, #e65100 0%, #d84315 100%); padding: 1rem; cursor: pointer; border-color: #e65100;" onclick="switchTab(event, 'about')">
                        <div class="stat-number" style="font-size: 1.8rem;">${zone5.length}</div>
                        <div class="stat-label" style="font-size: 0.85rem;">Zone 5 (High Risk)</div>
                        <div class="zone-tooltip tooltip-down" style="border-color: #e65100;">
                            <h4 style="color: #e65100;"><i class="fas fa-heartbeat"></i> Zone 5: High Risk (Cardiovascular Stress)</h4>
                            <p><strong>Action Required:</strong> Limit heavy work. Increase rest periods. Ensure continuous hydration and access to shade.</p>
                            ${zone5DistrictsList}
                            <span class="learn-more-link"><i class="fas fa-info-circle"></i> Click to learn more about EHI zones</span>
                        </div>
                    </div>
                `;

                // Update Zone 6 floating banner - use GLOBAL zone 6 data
                // Check for Zone 6 across ALL MET levels and sun conditions
                const globalZone6 = data.alerts.filter(a =>
                    a["Zone_3_shade"] === "Zone 6" || a["Zone_3_sun"] === "Zone 6" ||
                    a["Zone_4_shade"] === "Zone 6" || a["Zone_4_sun"] === "Zone 6" ||
                    a["Zone_5_shade"] === "Zone 6" || a["Zone_5_sun"] === "Zone 6" ||
                    a["Zone_6_shade"] === "Zone 6" || a["Zone_6_sun"] === "Zone 6"
                );
                if (globalZone6.length > 0) {
                    const marqueeItems = globalZone6.map(a => `${a.DISTRICT}, ${a.STATE}`).join(' | ');

                    // Group districts by state
                    const stateGroups = {};
                    globalZone6.forEach(a => {
                        if (!stateGroups[a.STATE]) {
                            stateGroups[a.STATE] = [];
                        }
                        stateGroups[a.STATE].push(a.DISTRICT);
                    });

                    // Build state items with hover tooltips showing districts
                    const statesList = Object.keys(stateGroups).sort().map(state => {
                        const districts = stateGroups[state];
                        const districtNames = districts.map(d => `<div class="district-name">${d}</div>`).join('');
                        return `
                            <div class="banner-state-item" onclick="showForecastForState('${state.replace(/'/g, "\\'")}')">
                                ${state}<span class="district-count">${districts.length}</span>
                                <div class="districts-tooltip">
                                    <div class="tooltip-title">${state} districts affected</div>
                                    ${districtNames}
                                </div>
                            </div>
                        `;
                    }).join('');

                    const numStates = Object.keys(stateGroups).length;
                    const bannerHtml = `
                        <strong style="font-size: 1.4rem;"><i class="fas fa-exclamation-triangle"></i> ZONE 6 DETECTED (${globalZone6.length} districts in ${numStates} states)</strong><br>
                        <span style="font-size: 1rem; font-weight: 600;">Hover over state for districts. Click to view forecast.</span>
                        <div class="banner-states-list">
                            ${statesList}
                        </div>
                        <span class="banner-static-text">ZONE 6 DETECTED</span>
                        <div class="banner-marquee-container">
                            <marquee behavior="scroll" direction="left" scrollamount="5" style="font-size: 1rem;">
                                ${marqueeItems} | ${marqueeItems}
                            </marquee>
                        </div>
                    `;
                    document.getElementById('zone6-banner-content').innerHTML = bannerHtml;
                    document.getElementById('zone6-banner').style.background = 'linear-gradient(135deg, #d32f2f 0%, #c62828 100%)';
                    document.getElementById('zone6-banner').classList.add('show');

                } else {
                    // Show teal IECC advisory banner
                    const bannerHtml = `
                        <strong style="font-size: 1.2rem;"><i class="fas fa-info-circle"></i> Heat Stress Advisory</strong><br>
                        <span style="font-size: 1rem;">No hazardous (Zone 6) heat stress alerts at this time. Learn more about the Extended Heat Index (EHI) methodology:</span><br>
                        <a href="https://iecc.gspp.berkeley.edu/resources/visualizations/national-advisory-on-the-extended-heatindex-350-ehi-350/" target="_blank" style="color: white; font-weight: 700; text-decoration: underline; font-size: 1rem; margin-top: 0.5rem; display: inline-block;">
                            <i class="fas fa-external-link-alt"></i> See EHI Advisory from IECC
                        </a>
                    `;
                    document.getElementById('zone6-banner-content').innerHTML = bannerHtml;
                    document.getElementById('zone6-banner').style.background = 'var(--shram-teal)';
                    document.getElementById('zone6-banner').style.boxShadow = '0 4px 20px rgba(0, 109, 119, 0.4)';
                    document.getElementById('zone6-banner').classList.add('show');
                }
            } catch (error) {
                console.error('Error loading live data:', error);
                document.getElementById('live-status-summary').innerHTML = '<p style="text-align: center; color: #666;">Data will load when available</p>';
            }
        }

        // WeatherAPI.com API key
        const WEATHER_API_KEY = '4753e967970b4abca6b63520261401';

        // India districts data (loaded from JSON) - using window to ensure global scope
        window.indiaDistrictsData = null;
        let forecastChart = null;

        // Forecast map variables
        let forecastMap = null;
        let statesLayer = null;
        let districtLayer = null;
        let selectedDistrictCoords = null;
        let currentSelectedState = null;
        let statesGeoJSON = null;

        // Load districts data on startup
        async function loadIndiaDistrictsData() {
            try {
                console.log('Loading india_districts.json...');
                const response = await fetch('india_districts.json?t=' + Date.now());
                window.indiaDistrictsData = await response.json();
                const numStates = Object.keys(window.indiaDistrictsData.states || {}).length;
                console.log('Districts data loaded:', numStates, 'states');
                console.log('First 5 states:', Object.keys(window.indiaDistrictsData.states).slice(0, 5));

                // Force populate the dropdown immediately
                const stateSelect = document.getElementById('forecast-state-select');
                if (stateSelect && window.indiaDistrictsData && window.indiaDistrictsData.states) {
                    stateSelect.innerHTML = '<option value="all">-- Select a State --</option>';
                    Object.keys(window.indiaDistrictsData.states).sort().forEach(state => {
                        const opt = document.createElement('option');
                        opt.value = state;
                        opt.textContent = state.replace(/_/g, ' ');
                        stateSelect.appendChild(opt);
                    });
                    console.log('Dropdown populated with', stateSelect.options.length, 'options');
                }
            } catch (error) {
                console.error('Error loading districts data:', error);
            }
        }

        // Populate forecast state dropdown from districts data
        function populateForecastStateDropdown() {
            console.log('=== populateForecastStateDropdown called ===');
            if (!window.indiaDistrictsData) {
                console.log('populateForecastStateDropdown: No data yet');
                return;
            }

            const stateSelect = document.getElementById('forecast-state-select');
            console.log('stateSelect element:', stateSelect);
            if (!stateSelect) {
                console.error('forecast-state-select element not found!');
                return;
            }

            const states = Object.keys(window.indiaDistrictsData.states).sort();
            console.log('Populating state dropdown with', states.length, 'states:', states.slice(0, 5));

            // Clear and rebuild
            stateSelect.innerHTML = '';
            const allIndiaOption = document.createElement('option');
            allIndiaOption.value = 'all';
            allIndiaOption.textContent = 'All India';
            stateSelect.appendChild(allIndiaOption);

            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state.replace(/_/g, ' ');
                stateSelect.appendChild(option);
            });

            console.log('State dropdown now has', stateSelect.options.length, 'options');
            console.log('Options:', Array.from(stateSelect.options).slice(0, 5).map(o => o.value));
        }

        // Simplified EHI zone calculation based on temperature and humidity
        function calculateZone(temp, rh, met, inSun) {
            // MET levels: 3=180W, 4=240W, 5=300W, 6=360W
            const metWatts = met * 60;

            // Simple zone estimation based on conditions
            // Higher temp + higher humidity + higher MET = higher zone
            const heatLoad = temp + (rh * 0.3) + (met * 2) + (inSun ? 3 : 0);

            if (heatLoad > 55 || (temp > 40 && rh > 50)) return 6;
            if (heatLoad > 48 || (temp > 38 && rh > 40)) return 5;
            if (heatLoad > 42 || temp > 35) return 4;
            if (heatLoad > 35) return 3;
            return 2;
        }

        function getZoneColor(zone) {
            const colors = {
                6: '#d32f2f', // Hazardous - red
                5: '#e65100', // High risk - orange
                4: '#c79100', // Caution - yellow
                3: '#4caf50', // Comfortable - green
                2: '#4caf50', // Comfortable - green
                1: '#2196f3'  // Cold stress - blue
            };
            return colors[zone] || '#999';
        }

        function getZoneLabel(zone) {
            const labels = {
                6: 'HAZARDOUS',
                5: 'High Risk',
                4: 'Caution',
                3: 'Comfortable',
                2: 'Comfortable',
                1: 'Cold Stress'
            };
            return labels[zone] || 'Unknown';
        }

        // Get location coordinates from district data
        function getForecastLocation() {
            // First check if we have coordinates from map click
            if (selectedDistrictCoords) {
                console.log('Using map-selected district:', selectedDistrictCoords.name);
                return selectedDistrictCoords;
            }

            const selectedState = document.getElementById('forecast-state-select').value;
            const selectedDistrict = document.getElementById('forecast-district-select').value;

            console.log('getForecastLocation: state=', selectedState, ', district=', selectedDistrict);

            // Default: New Delhi
            let location = { name: 'New Delhi', lat: 28.6139, lon: 77.2090 };

            if (!window.indiaDistrictsData) {
                console.log('No districts data, using default New Delhi');
                return location;
            }

            if (selectedState === 'all') {
                // Will show "select a state" message, not fetch
                return location;
            }

            const stateData = window.indiaDistrictsData.states[selectedState];
            console.log('Looking for state:', selectedState, '- Found:', !!stateData);
            if (!stateData) {
                console.log('State not found in data:', selectedState);
                console.log('Available states:', Object.keys(window.indiaDistrictsData.states).slice(0, 5));
                return location;
            }

            console.log('Using state capital:', stateData.capital.name, 'at', stateData.capital.lat, stateData.capital.lon);

            if (selectedDistrict === 'all') {
                // Use state capital
                return {
                    name: stateData.capital.name,
                    lat: stateData.capital.lat,
                    lon: stateData.capital.lon
                };
            }

            // Use specific district
            const districtData = stateData.districts[selectedDistrict];
            if (districtData) {
                return {
                    name: selectedDistrict.replace(/_/g, ' '),
                    lat: districtData.lat,
                    lon: districtData.lon
                };
            }

            return location;
        }

        // Store pre-computed forecast data globally
        let forecastData = null;

        async function loadForecastData() {
            // Load pre-computed forecast data once
            if (!forecastData) {
                try {
                    // Try local file first, then fall back to GitHub Pages
                    let response;
                    try {
                        response = await fetch('weather_logs/forecast_data.json');
                        if (!response.ok) throw new Error('Local file not found');
                    } catch (e) {
                        response = await fetch('https://iecc-io.github.io/SHRAM/weather_logs/forecast_data.json');
                    }
                    forecastData = await response.json();
                    console.log('Loaded pre-computed forecast data:', forecastData.metadata);
                } catch (error) {
                    console.error('Error loading forecast data:', error);
                    forecastData = null;
                }
            }
            return forecastData;
        }

        async function loadForecast() {
            const forecastContent = document.getElementById('forecast-content');
            const chartCanvas = document.getElementById('forecast-chart');

            // Check if All India is selected - show message to select a state
            const selectedState = document.getElementById('forecast-state-select').value;
            if (selectedState === 'all') {
                forecastContent.innerHTML = '<p style="text-align: center; color: var(--shram-teal); font-size: 1.1rem; padding: 2rem;"><i class="fas fa-map-marker-alt"></i> Please select a state to view the forecast</p>';
                // Clear chart
                if (forecastChart) {
                    forecastChart.destroy();
                    forecastChart = null;
                }
                return;
            }

            forecastContent.innerHTML = '<p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Loading forecast...</p>';

            try {
                // Load pre-computed forecast data
                const data = await loadForecastData();
                if (!data) {
                    throw new Error('Forecast data not available');
                }

                // Get current MET and shade settings
                const met = currentMetForecast || 6;
                const sunCondition = shadeStates.forecast ? 'shade' : 'sun';
                const days = Math.min(forecastDays, 3);

                // Get selected state and district
                const selectedDistrict = document.getElementById('forecast-district-select').value;

                // Find forecast for the selected location
                let locationForecast = null;
                let locationName = '';

                const stateData = data.states[selectedState];
                if (!stateData) {
                    throw new Error(`No forecast data for ${selectedState}`);
                }

                if (selectedDistrict && selectedDistrict !== '' && stateData.districts[selectedDistrict]) {
                    locationForecast = stateData.districts[selectedDistrict].forecast;
                    locationName = `${selectedDistrict.replace(/_/g, ' ')}, ${selectedState.replace(/_/g, ' ')}`;
                } else if (stateData.capital) {
                    locationForecast = stateData.capital.forecast;
                    locationName = `${stateData.capital.name}, ${selectedState.replace(/_/g, ' ')}`;
                } else {
                    // Use first available district
                    const firstDistrict = Object.keys(stateData.districts)[0];
                    if (firstDistrict) {
                        locationForecast = stateData.districts[firstDistrict].forecast;
                        locationName = `${firstDistrict.replace(/_/g, ' ')}, ${selectedState.replace(/_/g, ' ')}`;
                    }
                }

                if (!locationForecast || locationForecast.length === 0) {
                    throw new Error('No forecast data for this location');
                }

                // Limit to requested number of days
                const forecast = locationForecast.slice(0, days);

                // Build chart data - every hour using pre-computed EHI zones
                const chartLabels = [];
                const chartData = [];
                const chartColors = [];
                const isDayLabel = []; // Track which indices are day labels (for bold styling)

                forecast.forEach((day, dayIndex) => {
                    const dateObj = new Date(day.date);
                    const dayName = dateObj.toLocaleDateString('en-IN', { weekday: 'short' });
                    const dateNum = dateObj.getDate();

                    // Show every hour (0-23)
                    day.hours.forEach((hourData, hour) => {
                        if (hourData && hourData.data) {
                            // Get pre-computed zone for selected MET and sun condition
                            const metData = hourData.data[`met${met}`];
                            const rawZone = metData ? metData[sunCondition].zone : 2;

                            // Use actual zone numbers 1-6
                            const rawZoneInt = Math.round(rawZone);
                            const zone = rawZoneInt >= 1 && rawZoneInt <= 6 ? rawZoneInt : 2;

                            // Full day + date at midnight, just hours otherwise (every 3 hours)
                            let label;
                            let isDay = false;
                            if (hour === 0) {
                                // Full day name and date at midnight
                                const monthDay = dateObj.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                                label = `${dayName}, ${monthDay}`;
                                isDay = true;
                            } else if (hour % 3 === 0) {
                                // Show hours at 3, 6, 9, 12, 15, 18, 21
                                label = `${hour}:00`;
                            } else {
                                label = '';
                            }
                            chartLabels.push(label);
                            chartData.push(zone);
                            chartColors.push(getZoneColor(rawZoneInt)); // Keep original zone for color
                            isDayLabel.push(isDay);
                        }
                    });
                });

                // Create summary HTML with location and timestamp on same line
                let html = `<p style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                    <strong><i class="fas fa-map-marker-alt"></i> ${locationName}</strong>
                    ${data.metadata && data.metadata.generated_at_ist ? `<span style="font-size: 0.85rem; color: #666; font-weight: 600;"><i class="fas fa-clock"></i> Forecast generated: ${data.metadata.generated_at_ist}</span>` : ''}
                </p>`;

                // Add peak conditions summary
                html += `<div style="padding: 1rem; background: var(--gray-light); border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem; color: var(--shram-teal);"><i class="fas fa-sun"></i> Peak Conditions</h4>`;

                forecast.forEach(day => {
                    const dateStr = new Date(day.date).toLocaleDateString('en-IN', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short'
                    });
                    const maxTemp = day.day.maxtemp_c;
                    const minTemp = day.day.mintemp_c;
                    const avgHumidity = day.day.avghumidity;

                    // Find peak zone for the day using pre-computed data
                    let peakZone = 1;
                    day.hours.forEach(h => {
                        if (h && h.data) {
                            const metData = h.data[`met${met}`];
                            const z = metData ? metData[sunCondition].zone : 1;
                            if (z > peakZone) peakZone = z;
                        }
                    });

                    const peakColor = getZoneColor(peakZone);
                    // Display Zone 2/3 together since they can't be distinguished
                    const zoneLabel = (peakZone === 2 || peakZone === 3) ? 'Zone 2/3' : `Zone ${peakZone}`;

                    // Use dark text for Zone 4 (yellow) for better contrast
                    const textColor = peakZone === 4 ? '#333' : 'white';
                    html += `<p style="margin: 0.5rem 0;">
                        <strong>${dateStr}:</strong> ${minTemp.toFixed(0)}C - ${maxTemp.toFixed(0)}C, ${avgHumidity}% RH
                        <span style="background: ${peakColor}; color: ${textColor}; padding: 2px 8px; border-radius: 4px; margin-left: 0.5rem; font-size: 0.85rem;">Peak: ${zoneLabel}</span>
                    </p>`;
                });

                html += '</div>';

                forecastContent.innerHTML = html;

                // Create/update the chart
                const ctx = document.getElementById('forecast-chart').getContext('2d');

                if (forecastChart) {
                    forecastChart.destroy();
                }

                forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        isDayLabel: isDayLabel, // Custom property for styling
                        datasets: [{
                            label: 'EHI Zone',
                            data: chartData,
                            borderColor: '#2d637f',
                            backgroundColor: 'rgba(45, 99, 127, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            stepped: true,
                            pointRadius: 4,
                            pointBackgroundColor: chartColors,
                            pointBorderColor: chartColors,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const level = context.raw;
                                        const labels = { 1: 'Zone 1', 2: 'Zone 2', 3: 'Zone 3', 4: 'Zone 4', 5: 'Zone 5', 6: 'Zone 6' };
                                        return labels[level] || '';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: 0.5,
                                max: 6.5,
                                title: {
                                    display: true,
                                    text: 'Zone',
                                    font: { weight: 'bold' }
                                },
                                ticks: {
                                    stepSize: 1,
                                    font: { weight: 'bold' },
                                    callback: function(value) {
                                        const v = Math.round(value);
                                        if (v >= 1 && v <= 6) return v.toString();
                                        return '';
                                    }
                                },
                                grid: {
                                    color: function(context) {
                                        if (context.tick.value === 1) return 'rgba(33, 150, 243, 0.4)';
                                        if (context.tick.value === 4) return 'rgba(199, 145, 0, 0.4)';
                                        if (context.tick.value === 5) return 'rgba(230, 81, 0, 0.4)';
                                        if (context.tick.value === 6) return 'rgba(211, 47, 47, 0.4)';
                                        return 'rgba(0, 0, 0, 0.1)';
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    autoSkip: false,
                                    font: { weight: 'bold' },
                                    callback: function(value, index, ticks) {
                                        const label = this.getLabelForValue(value);
                                        if (!label) return null;

                                        // On mobile, only show labels every 6 hours (keep grid lines)
                                        const isMobile = window.innerWidth <= 768;
                                        if (isMobile) {
                                            // Show day labels (contain comma) and every 6th hour (indices 0, 6, 12, 18)
                                            if (label.includes(',')) return label; // Day labels always show
                                            // Check if this is an hourly label at 6-hour intervals
                                            const hourMatch = label.match(/^(\d+)/);
                                            if (hourMatch) {
                                                const hour = parseInt(hourMatch[1]);
                                                if (hour % 6 !== 0) return null; // Hide non-6-hour labels on mobile
                                            }
                                        }
                                        return label;
                                    },
                                    font: function(context) {
                                        // Bold font for day labels (contain comma like "Sun, 26 Jan")
                                        // In Chart.js 4.x, context.tick.label contains the tick label
                                        const tickLabel = context.tick && context.tick.label;
                                        if (tickLabel && typeof tickLabel === 'string' && tickLabel.includes(',')) {
                                            return { size: 11, weight: 'bold' };
                                        }
                                        return { size: 9 };
                                    }
                                },
                                grid: {
                                    color: function(context) {
                                        // Bold line at midnight (day labels contain comma)
                                        const tickLabel = context.tick && context.tick.label;
                                        if (tickLabel && typeof tickLabel === 'string' && tickLabel.includes(',')) {
                                            return 'rgba(0, 0, 0, 0.5)';
                                        }
                                        return 'rgba(0, 0, 0, 0.05)';
                                    },
                                    lineWidth: function(context) {
                                        // Thicker line at midnight (day labels contain comma)
                                        const tickLabel = context.tick && context.tick.label;
                                        if (tickLabel && typeof tickLabel === 'string' && tickLabel.includes(',')) {
                                            return 2;
                                        }
                                        return 1;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading forecast:', error);
                forecastContent.innerHTML = `<p style="color: #666; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="color: #e65100;"></i>
                    Unable to load forecast data.<br>
                    <small>${error.message || 'Please try again later.'}</small>
                </p>`;
            }
        }

        async function load24HourData() {
            try {
                // Try local file first, then fall back to GitHub Pages
                let response;
                try {
                    response = await fetch('weather_logs/alerts_24h.json');
                    if (!response.ok) throw new Error('Local file not found');
                } catch (e) {
                    response = await fetch('https://iecc-io.github.io/SHRAM/weather_logs/alerts_24h.json');
                }
                const data = await response.json();

                // Store globally for historical data lookups (used by filterCurrentStatus for unavailable locations)
                all24HourData = data;

                // Get selected state and district
                const selectedState = document.getElementById('charts-state-select').value;
                const selectedDistrict = document.getElementById('charts-district-select').value;

                // Get current MET level and map to actual column names in JSON
                const met = currentMetLast24h || 6;
                // Map MET levels to actual column names in alerts_24h.json
                // Currently data only has: "Light Work Heat Stress Zone" (MET 3) and "Hard Labor Heat Stress Zone" (MET 6)
                const zoneColMap = {
                    3: 'Light Work Heat Stress Zone',
                    4: 'Hard Labor Heat Stress Zone',  // fallback to MET 6 for MET 4
                    5: 'Hard Labor Heat Stress Zone',  // fallback to MET 6 for MET 5
                    6: 'Hard Labor Heat Stress Zone'
                };
                const zoneCol = zoneColMap[met] || 'Hard Labor Heat Stress Zone';

                const hourlySource = data.hourly_data || data.hourly_alerts;

                // Update timestamp for Last 24 Hours section (get most recent entry timestamp)
                if (hourlySource && hourlySource.length > 0) {
                    const latestTimestamp = hourlySource[hourlySource.length - 1].timestamp || data.timestamp || data.last_updated;
                    if (latestTimestamp) {
                        const timestamp = new Date(latestTimestamp).toLocaleString('en-IN', {
                            timeZone: 'Asia/Calcutta',
                            dateStyle: 'medium',
                            timeStyle: 'short'
                        });
                        document.getElementById('last24h-timestamp').innerHTML = `<strong>Last Updated: ${timestamp} IST</strong>`;
                    }
                }
                if (!hourlySource || hourlySource.length === 0) {
                    createPlaceholderCharts();
                    return;
                }

                const labels = [];
                const zone6Data = [], zone5Data = [], zone4Data = [], zone23Data = [], zone1Data = [];
                const tempData = [], rhData = [];

                // Helper to normalize state/district names for comparison (handles UPPERCASE_UNDERSCORED vs Title Case)
                const normalizeForComparison = (str) => str ? str.toLowerCase().replace(/_/g, ' ') : '';

                hourlySource.forEach(entry => {
                    // Use stations (all data) instead of alerts (filtered)
                    let stations = entry.stations || entry.alerts || [];

                    // Filter by selected state and district (handle format differences)
                    if (selectedState !== 'all') {
                        const normalizedSelected = normalizeForComparison(selectedState);
                        stations = stations.filter(s => normalizeForComparison(s.STATE) === normalizedSelected);
                    }
                    if (selectedDistrict !== 'all') {
                        const normalizedSelected = normalizeForComparison(selectedDistrict);
                        stations = stations.filter(s => normalizeForComparison(s.DISTRICT) === normalizedSelected);
                    }

                    const time = new Date(entry.timestamp);
                    labels.push(time.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Calcutta' }));

                    // Count zones using dynamic column based on selected MET/sun
                    zone6Data.push(stations.filter(s => s[zoneCol] === "Zone 6").length);
                    zone5Data.push(stations.filter(s => s[zoneCol] === "Zone 5").length);
                    zone4Data.push(stations.filter(s => s[zoneCol] === "Zone 4").length);
                    // Combine Zone 2 and Zone 3 into "Comfortable"
                    zone23Data.push(stations.filter(s => s[zoneCol] === "Zone 3" || s[zoneCol] === "Zone 2").length);
                    zone1Data.push(stations.filter(s => s[zoneCol] === "Zone 1").length);

                    if (stations.length > 0) {
                        tempData.push((stations.reduce((sum, s) => sum + parseFloat(s.TEMP || 0), 0) / stations.length).toFixed(1));
                        rhData.push((stations.reduce((sum, s) => sum + parseFloat(s.RH || 0), 0) / stations.length).toFixed(1));
                    } else {
                        tempData.push(null);
                        rhData.push(null);
                    }
                });

                const ctxAlert = document.getElementById('alertTrendChart').getContext('2d');
                if (alertTrendChart) alertTrendChart.destroy();
                alertTrendChart = new Chart(ctxAlert, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Zone 6', data: zone6Data, borderColor: '#d32f2f', backgroundColor: 'rgba(211, 47, 47, 0.1)', fill: true },
                            { label: 'Zone 5', data: zone5Data, borderColor: '#e65100', backgroundColor: 'rgba(230, 81, 0, 0.1)', fill: true },
                            { label: 'Zone 4', data: zone4Data, borderColor: '#c79100', backgroundColor: 'rgba(199, 145, 0, 0.1)', fill: true },
                            { label: 'Zone 2-3', data: zone23Data, borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.1)', fill: true },
                            { label: 'Zone 1', data: zone1Data, borderColor: '#03a9f4', backgroundColor: 'rgba(3, 169, 244, 0.1)', fill: true }
                        ]
                    },
                    options: getChartOptions('zone')
                });

                const ctxTemp = document.getElementById('tempHumidityChart').getContext('2d');
                if (tempHumidityChart) tempHumidityChart.destroy();
                tempHumidityChart = new Chart(ctxTemp, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Temp (C)', data: tempData, borderColor: '#d32f2f', yAxisID: 'y', fill: false },
                            { label: 'RH (%)', data: rhData, borderColor: '#1976d2', yAxisID: 'y1', fill: false }
                        ]
                    },
                    options: getChartOptions('temp')
                });
            } catch (error) {
                console.error('Error loading 24-hour data:', error);
                createPlaceholderCharts();
            }
        }

        function createPlaceholderCharts() {
            // Create sample data for demonstration
            const hours = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
            const sampleZone6 = Array.from({length: 24}, () => Math.floor(Math.random() * 15));
            const sampleZone5 = Array.from({length: 24}, () => Math.floor(Math.random() * 25));
            const sampleZone4 = Array.from({length: 24}, () => Math.floor(Math.random() * 40));
            const sampleZone3 = Array.from({length: 24}, () => Math.floor(Math.random() * 50));
            const sampleZone2 = Array.from({length: 24}, () => Math.floor(Math.random() * 30));
            const sampleZone1 = Array.from({length: 24}, () => Math.floor(Math.random() * 10));
            const sampleTemp = Array.from({length: 24}, (_, i) => 25 + Math.sin(i/24*Math.PI*2) * 10);
            const sampleRH = Array.from({length: 24}, (_, i) => 60 - Math.sin(i/24*Math.PI*2) * 20);

            const ctxAlert = document.getElementById('alertTrendChart').getContext('2d');
            if (alertTrendChart) alertTrendChart.destroy();
            alertTrendChart = new Chart(ctxAlert, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        { label: 'Zone 6', data: sampleZone6, borderColor: '#d32f2f', backgroundColor: 'rgba(211, 47, 47, 0.1)', fill: true },
                        { label: 'Zone 5', data: sampleZone5, borderColor: '#e65100', backgroundColor: 'rgba(230, 81, 0, 0.1)', fill: true },
                        { label: 'Zone 4', data: sampleZone4, borderColor: '#c79100', backgroundColor: 'rgba(199, 145, 0, 0.1)', fill: true },
                        { label: 'Zone 3', data: sampleZone3, borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.1)', fill: true },
                        { label: 'Zone 2', data: sampleZone2, borderColor: '#8bc34a', backgroundColor: 'rgba(139, 195, 74, 0.1)', fill: true },
                        { label: 'Zone 1', data: sampleZone1, borderColor: '#03a9f4', backgroundColor: 'rgba(3, 169, 244, 0.1)', fill: true }
                    ]
                },
                options: getChartOptions('zone')
            });

            const ctxTemp = document.getElementById('tempHumidityChart').getContext('2d');
            if (tempHumidityChart) tempHumidityChart.destroy();
            tempHumidityChart = new Chart(ctxTemp, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        { label: 'Temp (C)', data: sampleTemp, borderColor: '#d32f2f', yAxisID: 'y', fill: false },
                        { label: 'RH (%)', data: sampleRH, borderColor: '#1976d2', yAxisID: 'y1', fill: false }
                    ]
                },
                options: getChartOptions('temp')
            });
        }

        async function loadSummerStats() {
            try {
                // Try local file first, then fall back to GitHub Pages
                let response;
                try {
                    response = await fetch('weather_logs/summer_stats.json');
                    if (!response.ok) throw new Error('Local file not found');
                } catch (e) {
                    response = await fetch('https://iecc-io.github.io/SHRAM/weather_logs/summer_stats.json');
                }
                const data = await response.json();

                // Check if summer data is available yet
                if (!data.hottest_location || data.total_alerts === 0) {
                    document.getElementById('summer-stats-content').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-calendar-alt" style="font-size: 2rem; margin-bottom: 1rem; color: #999;"></i>
                            <p style="font-size: 1.1rem;"><strong>Summer ${data.year} Statistics</strong></p>
                            <p>Data collection started: ${new Date(data.data_collection_started).toLocaleDateString('en-IN', { dateStyle: 'medium' })}</p>
                            <p style="margin-top: 0.5rem;">Summer statistics will be available once the season begins (June - September).</p>
                        </div>
                    `;
                    return;
                }

                // Parse dates as IST (data is already in IST, append +05:30 to prevent double conversion)
                const hottestDateIST = data.hottest_location.date.includes('+') ? data.hottest_location.date : data.hottest_location.date + '+05:30';
                const hottestDate = new Date(hottestDateIST).toLocaleString('en-IN', {
                    timeZone: 'Asia/Calcutta',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                }) + ' IST';

                const ehiDateIST = data.peak_ehi350_location.date.includes('+') ? data.peak_ehi350_location.date : data.peak_ehi350_location.date + '+05:30';
                const ehiDate = new Date(ehiDateIST).toLocaleString('en-IN', {
                    timeZone: 'Asia/Calcutta',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                }) + ' IST';

                // Prepare tooltip content for zones
                const zone6TopState = data.zone_6_top_state || 'N/A';
                const zone6CommonTime = (data.zone_6_common_time || 'Afternoon (12-4 PM)') + ' IST';
                const zone5TopState = data.zone_5_top_state || 'N/A';
                const zone5CommonTime = (data.zone_5_common_time || 'Afternoon (12-4 PM)') + ' IST';

                let html = `
                    <div class="status-grid">
                        <div class="stat-box">
                            <div class="stat-number">${(data.total_alerts || 0).toLocaleString()}</div>
                            <div class="stat-label">Total Alerts (Summer ${data.year})</div>
                        </div>
                        <div class="stat-box hoverable" style="background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%); cursor: pointer; border-color: #d32f2f;" onclick="switchTab(event, 'about')">
                            <div class="stat-number">${data.zone_6_events.toLocaleString()}</div>
                            <div class="stat-label">Zone 6 Hours</div>
                            <div class="zone-tooltip tooltip-down" style="border-color: #d32f2f;">
                                <h4 style="color: #d32f2f;"><i class="fas fa-exclamation-triangle"></i> Zone 6 Summer Statistics</h4>
                                <p><strong>Top State:</strong> ${zone6TopState.replace(/_/g, ' ')}</p>
                                <p><strong>Most Common Time:</strong> ${zone6CommonTime}</p>
                                <span class="learn-more-link"><i class="fas fa-info-circle"></i> Click to learn more about EHI zones</span>
                            </div>
                        </div>
                        <div class="stat-box hoverable" style="background: linear-gradient(135deg, #e65100 0%, #d84315 100%); cursor: pointer; border-color: #e65100;" onclick="switchTab(event, 'about')">
                            <div class="stat-number">${data.zone_5_events.toLocaleString()}</div>
                            <div class="stat-label">Zone 5 Hours</div>
                            <div class="zone-tooltip tooltip-down" style="border-color: #e65100;">
                                <h4 style="color: #e65100;"><i class="fas fa-heartbeat"></i> Zone 5 Summer Statistics</h4>
                                <p><strong>Top State:</strong> ${zone5TopState.replace(/_/g, ' ')}</p>
                                <p><strong>Most Common Time:</strong> ${zone5CommonTime}</p>
                                <span class="learn-more-link"><i class="fas fa-info-circle"></i> Click to learn more about EHI zones</span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; background: var(--gray-light); padding: 1.5rem; border-radius: 8px;">
                        <h3 style="color: var(--danger-red); margin-bottom: 1rem;"><i class="fas fa-exclamation-circle"></i> Summer ${data.year} Peak Heat Events</h3>

                        <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid var(--danger-red);">
                            <strong style="color: var(--danger-red); font-size: 1.1rem;">Hottest Location Recorded:</strong><br>
                            <span style="font-size: 1rem;">${data.hottest_location.station}, ${data.hottest_location.district}, ${data.hottest_location.state.replace(/_/g, ' ')}</span><br>
                            <span style="font-size: 1.3rem; font-weight: 700; color: var(--danger-red);">${data.peak_temp}C</span>${data.hottest_location.rh ? ` at ${data.hottest_location.rh}% RH` : ''} on ${hottestDate}
                        </div>

                        <div style="background: white; padding: 1rem; border-radius: 6px; border-left: 4px solid var(--warning-orange);">
                            <strong style="color: var(--warning-orange); font-size: 1.1rem;">Highest EHI-6 Recorded:</strong><br>
                            <span style="font-size: 1rem;">${data.peak_ehi350_location.station}, ${data.peak_ehi350_location.district}, ${data.peak_ehi350_location.state.replace(/_/g, ' ')}</span><br>
                            <span style="font-size: 1.3rem; font-weight: 700; color: var(--warning-orange);">${data.peak_ehi350.toFixed(1)}C EHI-6</span>${data.peak_ehi350_location.temp && data.peak_ehi350_location.rh ? ` (${data.peak_ehi350_location.temp}C, ${data.peak_ehi350_location.rh}% RH)` : ''} on ${ehiDate}
                        </div>
                    </div>
                `;

                document.getElementById('summer-stats-content').innerHTML = html;
            } catch (error) {
                console.error('Error loading summer stats:', error);
                document.getElementById('summer-stats-content').innerHTML = '<p style="text-align: center; color: #666;">Summer statistics not available</p>';
            }
        }

        function showZone(zoneNum) {
            // Hide all zone content
            for (let i = 1; i <= 6; i++) {
                const content = document.getElementById(`zone-content-${i}`);
                const btn = document.getElementById(`zone-btn-${i}`);
                if (content) content.style.display = 'none';
                if (btn) {
                    // Reset button styles based on zone
                    if (i === 1) {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--shram-teal)';
                    } else if (i === 2 || i === 3) {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--shram-teal)';
                    } else if (i === 4) {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--caution-yellow)';
                    } else if (i === 5) {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--warning-orange)';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--danger-red)';
                    }
                }
            }

            // Show selected zone
            const selectedContent = document.getElementById(`zone-content-${zoneNum}`);
            const selectedBtn = document.getElementById(`zone-btn-${zoneNum}`);
            if (selectedContent) selectedContent.style.display = 'block';
            if (selectedBtn) {
                if (zoneNum === 1) {
                    selectedBtn.style.background = 'var(--shram-teal)';
                    selectedBtn.style.color = 'white';
                } else if (zoneNum === 2 || zoneNum === 3) {
                    selectedBtn.style.background = 'var(--shram-teal)';
                    selectedBtn.style.color = 'white';
                } else if (zoneNum === 4) {
                    selectedBtn.style.background = 'var(--caution-yellow)';
                    selectedBtn.style.color = 'white';
                } else if (zoneNum === 5) {
                    selectedBtn.style.background = 'var(--warning-orange)';
                    selectedBtn.style.color = 'white';
                } else {
                    selectedBtn.style.background = 'var(--danger-red)';
                    selectedBtn.style.color = 'white';
                }
            }
        }

        // Alert subscription functions
        function updateSubscriberDistricts() {
            const stateSelect = document.getElementById('subscriber-state');
            const districtSelect = document.getElementById('subscriber-district');
            const selectedState = stateSelect.value;

            if (!allAlertsData || selectedState === '') {
                districtSelect.innerHTML = '<option value="">Select District</option>';
                return;
            }

            const districts = [...new Set(
                allAlertsData.alerts
                    .filter(a => a.STATE === selectedState)
                    .map(a => a.DISTRICT)
            )].sort();

            districtSelect.innerHTML = '<option value="">Select District</option>';
            districts.forEach(district => {
                districtSelect.innerHTML += `<option value="${district}" class="available">${district.replace(/_/g, ' ')}</option>`;
            });
        }

        function populateSubscriberStates() {
            if (!allAlertsData) return;

            const states = [...new Set(allAlertsData.alerts.map(a => a.STATE))].sort();
            const subscriberStateSelect = document.getElementById('subscriber-state');

            subscriberStateSelect.innerHTML = '<option value="">Select State</option>';
            states.forEach(state => {
                subscriberStateSelect.innerHTML += `<option value="${state}" class="available">${state.replace(/_/g, ' ')}</option>`;
            });
        }

        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for messages from Live Map iframe (click-to-forecast)
            window.addEventListener('message', async function(event) {
                if (event.data && event.data.type === 'navigateToForecast') {
                    const stateName = event.data.state;
                    const clickLat = event.data.lat;
                    const clickLon = event.data.lon;

                    // Switch to Dashboard tab
                    const dashboardTab = document.querySelector('.tab[onclick*="dashboard"]');
                    if (dashboardTab) {
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.getElementById('dashboard-tab').classList.add('active');
                        dashboardTab.classList.add('active');
                    }
                    // Switch to Forecast section within Dashboard
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    const forecastBtn = document.querySelector('.nav-btn[onclick*="forecast"]');
                    if (forecastBtn) forecastBtn.classList.add('active');
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    const forecastSection = document.getElementById('forecast-section');
                    if (forecastSection) forecastSection.classList.add('active');

                    // Select the state and find nearest district
                    if (window.indiaDistrictsData && window.indiaDistrictsData.states[stateName]) {
                        // Call zoomToState and wait for it to complete
                        await zoomToState(stateName);

                        // If we have lat/lon, find and select the nearest district
                        if (clickLat && clickLon) {
                            const stateData = window.indiaDistrictsData.states[stateName];
                            let nearestDistrict = null;
                            let minDistance = Infinity;

                            // Check all districts in the state
                            for (const [districtName, districtData] of Object.entries(stateData.districts || {})) {
                                if (districtData.lat && districtData.lon) {
                                    // Simple Euclidean distance (good enough for nearby points)
                                    const dist = Math.sqrt(
                                        Math.pow(districtData.lat - clickLat, 2) +
                                        Math.pow(districtData.lon - clickLon, 2)
                                    );
                                    if (dist < minDistance) {
                                        minDistance = dist;
                                        nearestDistrict = districtName;
                                    }
                                }
                            }

                            // Select the nearest district if found
                            if (nearestDistrict && stateData.districts[nearestDistrict]) {
                                const districtData = stateData.districts[nearestDistrict];
                                // Update selectedDistrictCoords to override the capital
                                selectedDistrictCoords = {
                                    name: nearestDistrict,
                                    lat: districtData.lat,
                                    lon: districtData.lon
                                };
                                // Update UI label
                                const label = document.getElementById('selected-location-label');
                                if (label) {
                                    label.textContent = `Selected: ${nearestDistrict.replace(/_/g, ' ')}`;
                                }
                                // Highlight the district on the map if layer exists
                                if (districtLayer) {
                                    districtLayer.eachLayer(layer => {
                                        if (layer.feature && layer.feature.properties.name === nearestDistrict) {
                                            layer.setStyle({ fillColor: '#8B5A2B', fillOpacity: 0.6 });
                                        } else {
                                            layer.setStyle({ fillColor: '#2d637f', fillOpacity: 0.3 });
                                        }
                                    });
                                }
                                // Load forecast for the nearest district
                                loadForecast();
                            }
                        }
                    }
                }
            });

            // Load 24h historical data first (needed for fallback when current data unavailable)
            load24HourData().then(() => {
                // Then load live data - it will use historical data for unavailable locations
                loadLiveData().then(() => {
                    // Populate subscriber dropdowns after data loads
                    populateSubscriberStates();
                });
            });
            // Load districts data and initialize forecast map
            loadIndiaDistrictsData().then(() => {
                initForecastMap();  // Initialize map with all states
                // Fix initial map sizing after short delay
                setTimeout(() => {
                    if (forecastMap) forecastMap.invalidateSize();
                }, 200);
            });
            loadSummerStats();

            // Handle subscription form
            const subscriptionForm = document.getElementById('alert-subscription-form');
            if (subscriptionForm) {
                subscriptionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const messageDiv = document.getElementById('subscription-message');
                    const submitBtn = this.querySelector('button[type="submit"]');

                    // Collect form data
                    const formData = {
                        name: document.getElementById('subscriber-name').value,
                        email: document.getElementById('subscriber-email').value,
                        phone: document.getElementById('subscriber-phone').value,
                        state: document.getElementById('subscriber-state').value,
                        district: document.getElementById('subscriber-district').value,
                        zones: {
                            zone4: document.getElementById('alert-zone-4').checked,
                            zone5: document.getElementById('alert-zone-5').checked,
                            zone6: document.getElementById('alert-zone-6').checked
                        },
                        timestamp: new Date().toISOString()
                    };

                    // Validate at least one zone is selected
                    if (!formData.zones.zone4 && !formData.zones.zone5 && !formData.zones.zone6) {
                        messageDiv.style.display = 'block';
                        messageDiv.style.background = '#ffebee';
                        messageDiv.style.color = '#d32f2f';
                        messageDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please select at least one zone for alerts';
                        return;
                    }

                    // Disable submit button
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subscribing...';

                    try {
                        // TODO: Replace with your actual backend endpoint
                        // For now, we'll show a success message and log the data
                        console.log('Subscription data:', formData);

                        // Simulate API call
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // Show success message
                        messageDiv.style.display = 'block';
                        messageDiv.style.background = '#e8f5e9';
                        messageDiv.style.color = '#2e7d32';
                        messageDiv.innerHTML = `
                            <i class="fas fa-check-circle"></i> Successfully subscribed!<br>
                            <small style="font-weight: 400;">You will receive alerts for ${document.getElementById('subscriber-state').options[document.getElementById('subscriber-state').selectedIndex].text}, ${document.getElementById('subscriber-district').options[document.getElementById('subscriber-district').selectedIndex].text}</small>
                        `;

                        // Reset form
                        subscriptionForm.reset();

                        // TODO: Send data to your backend
                        // Example with Google Forms or your API:
                        /*
                        const response = await fetch('YOUR_API_ENDPOINT', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        */

                    } catch (error) {
                        console.error('Subscription error:', error);
                        messageDiv.style.display = 'block';
                        messageDiv.style.background = '#ffebee';
                        messageDiv.style.color = '#d32f2f';
                        messageDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> An error occurred. Please try again or contact us directly.';
                    } finally {
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-bell"></i> Subscribe to Alerts';
                    }
                });
            }
        });

        // =============================================
        // SHRAM Onboarding Guide (Intro.js)
        // =============================================
        function startTour() {
            // Helper to switch tabs during tour
            function goToTab(tabName) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.getElementById(tabName + '-tab').classList.add('active');
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                // Find and activate the correct tab button
                const tabMap = {
                    'dashboard': 'Dashboard',
                    'livemap': 'Live Zone Map',
                    'calculator': 'Calculator',
                    'about': 'About'
                };
                document.querySelectorAll('.tab').forEach(t => {
                    if (t.textContent.includes(tabMap[tabName])) {
                        t.classList.add('active');
                    }
                });
            }

            // Ensure we start on dashboard
            goToTab('dashboard');

            const tour = introJs();

            // Define steps with tab info
            const steps = [
                // Welcome
                {
                    title: 'Welcome to SHRAM!',
                    intro: 'SHRAM monitors heat stress for outdoor workers across India. Let\'s explore the key features.',
                    tab: 'dashboard'
                },
                // Navigation Tabs
                {
                    element: document.querySelector('.tabs'),
                    title: 'Navigation Tabs',
                    intro: 'Use these tabs to navigate between different sections. Let\'s start with the <b>Dashboard</b>.',
                    position: 'bottom',
                    tab: 'dashboard'
                },
                // Activity Level (METs) on Dashboard
                {
                    element: document.querySelector('#met-toggle-current'),
                    title: 'Activity Level (METs)',
                    intro: 'Select your <b>work intensity</b>:<br> <b>3 METs:</b> Light work (walking, housework)<br> <b>4 METs:</b> Moderate (carrying loads)<br> <b>5 METs:</b> Heavy (construction)<br> <b>6 METs:</b> Very heavy (agricultural labor)',
                    position: 'bottom',
                    tab: 'dashboard'
                },
                // Sun Exposure
                {
                    element: document.querySelector('#sun-shade-toggle'),
                    title: 'Sun Exposure',
                    intro: 'Toggle between <b>Shade</b> and <b>Sun</b> to see how direct sunlight increases heat risk during the day.<br><br><em>Note: From 6pm to 6am, all values show shaded conditions (no sun).</em>',
                    position: 'bottom',
                    tab: 'dashboard'
                },
                // Current Heat Stress Alerts Status
                {
                    element: document.querySelector('#status-grid'),
                    title: 'Current Heat Stress Alerts Status',
                    intro: 'See how many districts are in each heat stress zone right now. <b>Hover over zone tiles</b> to see affected districts, or <b>click</b> to see zone definitions.',
                    position: 'top',
                    tab: 'dashboard',
                    scrollTo: 'tooltip'
                },
                // Forecast Map
                {
                    element: document.querySelector('#forecast-map'),
                    title: '1- and 3-Day Heat Stress Forecast',
                    intro: '<b>Click any state and district</b> on the map to see its heat forecast for the next 1 or 3 days.<br><br><em>7-day forecasts expected in 2026.</em>',
                    position: 'right',
                    tab: 'dashboard'
                },
                // Live Map intro
                {
                    element: document.querySelector('#livemap-tab-btn'),
                    title: 'Live Zone Map',
                    intro: 'Now let\'s check out the <b>Live Zone Map</b> - an interactive full view of current conditions across India.',
                    position: 'bottom',
                    tab: 'livemap'
                },
                // Live Map MET/Sun controls
                {
                    element: document.querySelector('#livemap-controls-overlay'),
                    title: 'Map Controls',
                    intro: 'Use the <b>MET level</b> and <b>Sun/Shade</b> buttons at the top of the map to adjust work intensity and sun exposure settings.',
                    position: 'bottom',
                    tab: 'livemap'
                },
                // Live Map alerts and trends
                {
                    element: document.querySelector('#livemap-sidebar-overlay'),
                    title: 'Active Alerts & Trends',
                    intro: 'The sidebar on the right shows <b>Active Alerts</b> count and <b>Historical Zones</b> over the past hour.',
                    position: 'left',
                    tab: 'livemap'
                },
                // Live Map hover/click
                {
                    element: document.querySelector('#livemap-tab .section'),
                    title: 'Explore Locations',
                    intro: '<b>Hover</b> over any location to see current conditions. <b>Click</b> a district to view its detailed forecast.',
                    position: 'top',
                    tab: 'livemap'
                },
                // Calculator
                {
                    element: document.querySelector('.calculator-container'),
                    title: 'EHI-N* Calculator',
                    intro: 'The <b>Calculator</b> lets you compute heat stress for any temperature, humidity, and work intensity. Great for planning outdoor work!',
                    position: 'bottom',
                    tab: 'calculator'
                },
                // About EHI-N* Tab
                {
                    element: document.querySelector('#about-tab-btn'),
                    title: 'About EHI-N*',
                    intro: 'Visit the <b>About</b> tab to learn more about the science behind heat stress and subscribe to alerts.',
                    position: 'bottom',
                    tab: 'about'
                },
                // About EHI-N* Section
                {
                    element: document.querySelector('#about-ehi-section'),
                    title: 'Understanding EHI-N*',
                    intro: 'Learn about the <b>Extended Heat Index for Laboring Populations</b> and the science behind heat stress assessment.<br><br><em>Technical report and working paper coming soon.</em>',
                    position: 'bottom',
                    tab: 'about'
                },
                // Heat Stress Zones
                {
                    element: document.querySelector('#zones-section'),
                    title: 'Heat Stress Zones',
                    intro: 'Understand what each <b>zone</b> means physiologically - from Zone 1 (comfortable) to Zone 6 (hazardous). Click zone buttons to see detailed definitions.',
                    position: 'bottom',
                    tab: 'about'
                },
                // Subscribe
                {
                    element: document.querySelector('#alert-subscription-form'),
                    title: 'Stay Safe!',
                    intro: 'Enter your <b>name, email, location, and work intensity</b> to receive heat stress alerts. You\'ll get immediate alerts when Zone 6 is detected and daily forecasts for your district.',
                    position: 'bottom',
                    tab: 'about'
                },
                // API Documentation
                {
                    element: document.querySelector('#api-docs-btn'),
                    title: 'API for Developers',
                    intro: 'Access our <b>three datasets</b> programmatically:<br> Current alerts<br> 24-hour history<br> 3-day forecasts<br><br>Click to view API documentation.',
                    position: 'top',
                    tab: 'about'
                },
                // Take Tour Again - final step
                {
                    element: document.querySelector('.take-tour-btn.desktop-tour-btn') || document.querySelector('.take-tour-btn'),
                    title: 'Take the Tour Again',
                    intro: 'Click the <b>?</b> button anytime to take this tour again!<br><br><b>Thanks for taking the tour!</b>',
                    position: 'bottom',
                    tab: 'dashboard'
                }
            ];

            tour.setOptions({
                steps: steps.filter(step => !step.element || step.element !== null),
                showProgress: true,
                showBullets: false,
                exitOnOverlayClick: true,
                showStepNumbers: false,
                keyboardNavigation: true,
                scrollToElement: true,
                scrollPadding: 80,
                doneLabel: 'Got it!',
                nextLabel: 'Next ',
                prevLabel: ' Back',
                skipLabel: '',
                disableInteraction: true
            });

            // Switch tabs as we navigate through the tour
            tour.onbeforechange(function(targetElement) {
                const stepIndex = this._currentStep;
                const stepData = steps[stepIndex];
                if (stepData && stepData.tab) {
                    goToTab(stepData.tab);
                }
            });

            tour.oncomplete(function() {
                localStorage.setItem('shram-guide-completed', 'true');
                goToTab('dashboard');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            tour.onexit(function() {
                localStorage.setItem('shram-guide-completed', 'true');
            });

            tour.start();
        }

        // No auto-start - user clicks Help button
    </script>
</body>
</html>
