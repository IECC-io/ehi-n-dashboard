<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHRAM: System for Heat Risk Assessment for Manual Labor</title>

    <!-- Google Analytics (supports multiple accounts) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FZRLEJEW2N"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        // Primary Google Analytics account
        gtag('config', 'G-FZRLEJEW2N');
        // Secondary Google Analytics account (company - to be added later)
        // gtag('config', 'G-COMPANY-ID');
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --iecc-blue: #2d637f;
            --iecc-green: #9DAD33;
            --iecc-light-blue: #4a8dad;
            --iecc-dark-blue: #1a3d4f;
            --iecc-brown: #8B5A2B;
            --shram-teal: #006D77;
            --danger-red: #d32f2f;
            --warning-orange: #f57c00;
            --caution-yellow: #fbc02d;
            --gray-light: #f5f5f5;
            --gray-medium: #e0e0e0;
            --gray-dark: #333;
            --shram-dark-orange: #C54B26;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--gray-dark);
            background: var(--gray-light);
        }

        .logo-strip {
            background: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-bottom: 10px solid var(--shram-dark-orange);
        }

        .logo-strip-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-strip img {
            height: 50px;
            width: auto;
        }

        .logo-strip-text {
            font-size: 0.9rem;
            color: var(--gray-dark);
        }

        .logo-strip-text strong {
            color: var(--shram-teal);
            font-size: 1.1rem;
        }

        .header {
            background: var(--shram-dark-orange);
            color: white;
            padding: 1rem 2rem 0.5rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            position: relative;
            min-height: 180px;
        }

        .logo-container {
            position: absolute;
            left: 4rem;
            bottom: 0.5rem;
            height: 180px;
            width: calc(100% - 4rem);
            overflow: hidden;
        }

        .logo-container img {
            height: 180px;
            width: auto;
        }

        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; font-weight: 700; }
        .header .credit { font-size: 0.95rem; opacity: 0.85; font-style: italic; margin-bottom: 2rem; }

        .tabs {
            display: flex;
            gap: 0;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
            margin-left: auto;
            align-self: flex-end;
            margin-bottom: -0.5rem;
        }

        .tab {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            position: relative;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
        }

        .tab.active {
            background: white;
            color: var(--shram-teal);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            right: 0;
            height: 10px;
            background: var(--iecc-brown);
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .section {
            background: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            border-left: 4px solid var(--iecc-brown);
        }

        h2 {
            color: var(--shram-teal);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--gray-light);
            font-size: 1.4rem;
        }

        h3 {
            color: var(--shram-teal);
            margin: 1.5rem 0 1rem 0;
            font-size: 1.3rem;
        }

        /* Two-column Dashboard Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 968px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Calculator */
        .calculator-container {
            background: var(--shram-teal);
            color: white;
            padding: 2.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(45, 99, 127, 0.3);
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .input-wrapper {
            display: flex;
            gap: 0.5rem;
        }

        .input-wrapper input {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.95);
            color: var(--gray-dark);
        }

        .input-wrapper select {
            padding: 0.75rem;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.95);
            color: var(--gray-dark);
            font-size: 1rem;
            cursor: pointer;
        }

        .input-group input:focus,
        .input-wrapper select:focus {
            outline: 2px solid var(--iecc-brown);
        }

        .met-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .met-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .met-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--iecc-brown);
        }

        .met-option.active {
            background: white;
            color: var(--shram-teal);
            border-color: var(--iecc-brown);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .met-option i { font-size: 2rem; margin-bottom: 0.5rem; display: block; }
        .met-option .met-label { font-weight: 600; font-size: 0.95rem; }
        .met-option .met-desc { font-size: 0.8rem; opacity: 0.8; margin-top: 0.25rem; }

        /* Blue MET dropdown for dashboard sections */
        .met-select-green {
            background: var(--shram-teal);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.6rem center;
            padding-right: 2rem;
            vertical-align: middle;
        }
        .met-select-green:hover {
            background-color: var(--iecc-dark-blue);
        }
        .met-select-green option {
            background: white;
            color: #333;
        }

        /* Info tooltip for MET and shade/sun controls */
        .info-tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
            margin-left: 0.3rem;
            vertical-align: middle;
        }
        .info-tooltip i {
            color: var(--shram-teal);
            font-size: 0.85rem;
            opacity: 0.7;
        }
        .info-tooltip:hover i {
            opacity: 1;
        }
        .info-tooltip .tooltip-text {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-dark);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 400;
            width: 250px;
            text-align: left;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: opacity 0.2s, visibility 0.2s;
            line-height: 1.4;
        }
        .info-tooltip .tooltip-text::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--gray-dark);
        }
        .info-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .calculate-btn {
            background: var(--iecc-brown);
            color: white;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            margin-top: 1rem;
        }

        .calculate-btn:hover {
            background: #7a4a1b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 90, 43, 0.4);
        }

        .result-display {
            background: rgba(255, 255, 255, 0.95);
            color: var(--gray-dark);
            padding: 2rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            display: none;
        }

        .result-display.show { display: block; }
        .result-zone { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .result-value { font-size: 1.5rem; font-weight: 600; color: var(--shram-teal); margin-bottom: 1rem; }

        .zone-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .zone-badge {
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
            font-size: 0.9rem;
        }

        .zone-4-badge { background: #fffde7; border-color: #fbc02d; }
        .zone-5-badge { background: #fff3e0; border-color: #f57c00; }
        .zone-6-badge { background: #ffebee; border-color: #d32f2f; }
        .zone-badge strong { display: block; margin-bottom: 0.25rem; }

        .status-overview { margin-bottom: 2rem; }

        .status-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }

        .stat-box {
            background: var(--shram-teal);
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(45, 99, 127, 0.2);
            position: relative;
        }

        .stat-box.hoverable:hover .zone-tooltip {
            display: block;
        }

        .zone-tooltip {
            display: none;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            color: #333;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 250px;
            max-width: 350px;
            text-align: left;
            border: 2px solid currentColor;
        }

        .zone-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 8px solid transparent;
            border-top-color: white;
        }

        .zone-tooltip h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            color: inherit;
        }

        .zone-tooltip p {
            margin: 0.5rem 0 0 0;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .zone-tooltip .districts-list {
            max-height: 150px;
            overflow-y: auto;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #ddd;
            font-size: 0.8rem;
        }

        .stat-number { font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-label { font-size: 0.95rem; opacity: 0.9; }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            min-height: 350px;
        }

        .chart-container canvas {
            max-height: 400px;
            min-height: 250px;
        }

        /* Floating Zone 6 Alert Banner */
        .zone6-alert-banner {
            background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%);
            color: white;
            padding: 1rem 2rem;
            margin: 0.5rem 0 1rem 0;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(211, 47, 47, 0.4);
            animation: pulse 2s ease-in-out infinite;
            display: none;
            position: sticky;
            top: 0.5rem;
            z-index: 1100;  /* Higher than Leaflet map controls (1000) */
            max-height: 300px;
            overflow-y: auto;
        }

        .zone6-alert-banner.show {
            display: block;
        }

        .zone6-alert-banner .close-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
        }

        .zone6-alert-banner .close-btn:hover {
            opacity: 1;
        }

        .zone6-alert-banner.minimized {
            padding: 0.75rem 2rem;
        }

        .zone6-alert-banner.minimized #zone6-banner-content strong {
            display: none;
        }

        .zone6-alert-banner.minimized #zone6-banner-content span {
            display: none;
        }

        .zone6-alert-banner.minimized #zone6-banner-content br {
            display: none;
        }

        .zone6-alert-banner.minimized #zone6-banner-content .banner-static-text {
            display: inline-block !important;
            font-size: 1.1rem;
            font-weight: 700;
            margin-right: 1rem;
            vertical-align: middle;
        }

        .zone6-alert-banner.minimized #zone6-banner-content .banner-marquee-container {
            display: inline-block !important;
            width: calc(100% - 220px);
            vertical-align: middle;
        }

        .zone6-alert-banner.minimized #zone6-banner-content marquee {
            display: inline-block !important;
            margin: 0 !important;
            vertical-align: middle;
        }

        .banner-static-text {
            display: none;
        }

        .banner-marquee-container {
            display: none;
        }

        .banner-marquee-container marquee {
            display: block;
        }

        /* Districts list for expanded banner */
        .banner-districts-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 1rem;
            max-height: 150px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .banner-districts-list::-webkit-scrollbar {
            width: 6px;
        }

        .banner-districts-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .banner-districts-list::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.4);
            border-radius: 3px;
        }

        .banner-district-item {
            background: rgba(255,255,255,0.15);
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .banner-district-item i {
            font-size: 0.7rem;
            opacity: 0.8;
        }

        /* When minimized, hide list and show marquee */
        .zone6-alert-banner.minimized .banner-districts-list {
            display: none;
        }

        .zone6-alert-banner.minimized .banner-marquee-container {
            display: inline-block !important;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 4px 20px rgba(211, 47, 47, 0.4); }
            50% { box-shadow: 0 4px 30px rgba(211, 47, 47, 0.7); }
        }

        /* API Modal Styles */
        .api-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            overflow: auto;
        }

        .api-modal.show {
            display: block;
        }

        .api-modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 10px;
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .api-modal-header {
            background: var(--shram-teal);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .api-modal-close {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background: none;
            border: none;
            opacity: 0.8;
        }

        .api-modal-close:hover {
            opacity: 1;
        }

        .api-modal-body {
            padding: 2rem;
        }

        .endpoint-grid { display: grid; gap: 1.5rem; margin-top: 1.5rem; }

        .endpoint-card {
            background: var(--gray-light);
            padding: 1.5rem;
            border-radius: 8px;
            border-left: 4px solid var(--shram-teal);
        }

        .endpoint-card h4 { color: var(--shram-teal); margin-bottom: 1rem; }

        .endpoint {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            overflow-x: auto;
            word-break: break-all;
        }

        .method-badge {
            display: inline-block;
            background: var(--iecc-brown);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }

        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 1.5rem;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code { font-family: 'Courier New', monospace; }

        .alert-box {
            background: #fff3e0;
            border-left: 4px solid var(--warning-orange);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #1976d2;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        .success-box {
            background: #e8f5e9;
            border-left: 4px solid var(--iecc-brown);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }

        /* Dropdown option styles for data availability */
        /* Note: Most browsers don't support styling <option> elements */
        /* We use disabled attribute for unavailable options instead */
        select option.available {
            font-weight: bold;
        }

        select option.unavailable,
        select option:disabled {
            color: #999;
            font-style: italic;
        }

        .footer {
            background: var(--shram-dark-orange);
            color: white;
            padding: 2rem;
            text-align: center;
            margin-top: 3rem;
        }

        .footer a { color: var(--iecc-brown); text-decoration: none; }
        .footer a:hover { text-decoration: underline; }

        .forecast-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .forecast-table th,
        .forecast-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-medium);
        }

        .forecast-table th {
            background: var(--shram-teal);
            color: white;
            font-weight: 600;
        }

        .forecast-table tr:hover { background: var(--gray-light); }

        /* District map tooltip */
        .district-tooltip {
            background: white;
            border: 2px solid var(--shram-teal);
            border-radius: 4px;
            padding: 4px 8px;
            font-weight: 600;
            color: var(--shram-teal);
        }

        #district-map {
            background: #f5f5f5;
        }

        @media (max-width: 768px) {
            .header { padding: 1rem; }
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }
            .header img { height: 50px; margin-bottom: 0.5rem; }

            /* Keep tabs horizontal but compact */
            .tabs {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.3rem;
            }
            .tab {
                flex: 1 1 auto;
                min-width: auto;
                padding: 0.5rem 0.4rem;
                font-size: 0.7rem;
            }
            .tab i { display: none; } /* Hide icons on mobile to save space */

            .container { padding: 0.5rem; }

            /* Zone 6 Banner - compact */
            #zone6-banner {
                padding: 0.75rem !important;
                font-size: 0.8rem !important;
            }
            #zone6-banner strong { font-size: 0.9rem !important; }
            #zone6-banner span { font-size: 0.75rem !important; }

            /* Dashboard grid - stack on mobile */
            .dashboard-grid {
                grid-template-columns: 1fr !important;
                gap: 0.75rem;
            }

            /* Compact sections */
            .section { padding: 0.75rem; margin-bottom: 0.75rem; }
            .section h2 { font-size: 0.95rem; margin-bottom: 0.5rem; }
            .section h3 { font-size: 0.85rem; }
            .section p { font-size: 0.8rem; }

            /* Dashboard section titles */
            .dashboard-grid .section h2 { font-size: 0.9rem; }

            /* Stat boxes */
            .stat-box { padding: 0.5rem; }
            .stat-number { font-size: 1.2rem; }
            .stat-label { font-size: 0.65rem; }

            /* Status grid */
            .status-grid {
                flex-direction: column;
                gap: 0.4rem;
            }

            /* Status overview text */
            #live-status-summary p { font-size: 0.8rem !important; }

            /* Forecast section */
            #forecast-content p { font-size: 0.8rem; }
            #forecast-chart { height: 200px !important; }

            /* Last 24 hours */
            #last24h-timestamp { font-size: 0.8rem; }
            .chart-container { height: 180px !important; }

            /* Calculator */
            .calculator-container { padding: 0.75rem; }
            .calculator-grid { gap: 0.5rem; }

            /* MET selector */
            .met-selector { grid-template-columns: repeat(2, 1fr); gap: 0.4rem; }
            .met-option { padding: 0.4rem; font-size: 0.75rem; }

            /* Charts */
            .chart-grid { grid-template-columns: 1fr; }

            /* Dropdowns and inputs */
            select, input { font-size: 0.8rem; padding: 0.35rem; }
            label { font-size: 0.8rem; }

            /* Logo strip */
            .logo-strip { padding: 0.4rem 0.75rem; }
            .logo-strip img { height: 30px; }

            /* Filter dropdowns */
            .dashboard-grid select { width: 100%; margin-bottom: 0.25rem; }
        }
    </style>
    <!-- Leaflet CSS and JS for district map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="logo-strip">
        <div class="logo-strip-content">
            <a href="https://iecc.gspp.berkeley.edu/impact-areas/resilience-climate-impacts/" target="_blank" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                <img src="iecc-logo.svg" alt="IECC Logo" style="height: 50px; width: auto;">
            </a>
        </div>
    </div>

    <div class="header">
        <div class="header-content">
            <div class="logo-container">
                <img src="shram_logo.svg" alt="SHRAM: System for Heat Risk Assessment for Manual Labor">
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab(event, 'dashboard')">
                    <i class="fas fa-dashboard"></i> Dashboard
                </button>
                <button class="tab" onclick="switchTab(event, 'livemap')">
                    <i class="fas fa-map-marked-alt"></i> Live Map
                </button>
                <button class="tab" onclick="switchTab(event, 'calculator')">
                    <i class="fas fa-calculator"></i> EHI-N* Calculator
                </button>
                <button class="tab" onclick="switchTab(event, 'about')">
                    <i class="fas fa-info-circle"></i> About EHI-N*
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Zone 6 Hazardous Alert Banner -->
        <div id="zone6-banner" class="zone6-alert-banner minimized">
            <button class="close-btn" onclick="toggleBanner()" id="banner-toggle-btn"><i class="fas fa-plus"></i></button>
            <div id="zone6-banner-content"></div>
        </div>

        <!-- TAB 1: DASHBOARD -->
        <div id="dashboard-tab" class="tab-content active">
            <!-- Two-column layout: Current Status (left) | Forecast (right) -->
            <div class="dashboard-grid">
                <!-- LEFT: Current Status -->
                <div class="section">
                    <h2><i class="fas fa-chart-line"></i> Current Heat Status for
                        <select id="met-select-current" onchange="selectMetCurrent(this.value)" class="met-select-green">
                            <option value="3">EHI-3 (Light Work)</option>
                            <option value="4">EHI-4 (Moderate)</option>
                            <option value="5">EHI-5 (Heavy)</option>
                            <option value="6" selected>EHI-6 (Very Heavy)</option>
                        </select>
                        <span style="margin-left: 0.5rem;">
                            <button id="current-shade-btn" onclick="setShade('current', true)" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                <i class="fas fa-cloud"></i> Shade
                            </button><button id="current-sun-btn" onclick="setShade('current', false)" style="background: white; color: var(--shram-teal); border: 2px solid var(--shram-teal); border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                <i class="fas fa-sun"></i> Sun
                            </button>
                        </span>
                        <span class="info-tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text"><strong>MET Level:</strong> Select based on work intensity.<br>• EHI-3: Light (walking, light housework)<br>• EHI-4: Moderate (carrying loads, cleaning)<br>• EHI-5: Heavy (construction, farming)<br>• EHI-6: Very Heavy (agricultural labor, heavy lifting)<br><br><strong>Sun Exposure:</strong><br>• <strong>Shade:</strong> Working under cover or indoors<br>• <strong>Sun:</strong> Direct sunlight exposure</span>
                        </span>
                    </h2>

                    <!-- State/District Filter -->
                    <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label for="current-state-select" style="font-weight: 600; margin-right: 0.5rem; color: var(--shram-teal);">State:</label>
                            <select id="current-state-select" onchange="updateCurrentDistricts(); filterCurrentStatus();" style="padding: 0.5rem; border-radius: 6px; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); font-weight: 500; width: 100%; font-size: 1rem;">
                                <option value="all">All India</option>
                            </select>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label for="current-district-select" style="font-weight: 600; margin-right: 0.5rem; color: var(--shram-teal);">District:</label>
                            <select id="current-district-select" onchange="filterCurrentStatus()" style="padding: 0.5rem; border-radius: 6px; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); font-weight: 500; width: 100%; font-size: 1rem;">
                                <option value="all">All Districts</option>
                            </select>
                        </div>
                    </div>

                    <div class="status-overview">
                        <div id="live-status-summary">
                            <p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Loading current status...</p>
                        </div>
                        <div class="status-grid" id="status-grid"></div>
                    </div>

                    <p style="text-align: center; font-size: 0.85rem; color: #999; margin-top: 1.5rem; font-style: italic;">Data source: India Meteorological Department (IMD)</p>
                </div>

                <!-- RIGHT: Forecast -->
                <div class="section">
                    <h2><i class="fas fa-calendar-alt"></i> Heat Forecast for
                        <select id="met-select-forecast" onchange="selectMetForecast(this.value)" class="met-select-green">
                            <option value="3">EHI-3 (Light Work)</option>
                            <option value="4">EHI-4 (Moderate)</option>
                            <option value="5">EHI-5 (Heavy)</option>
                            <option value="6" selected>EHI-6 (Very Heavy)</option>
                        </select>
                        <span style="margin-left: 0.5rem;">
                            <button id="forecast-shade-btn" onclick="setShade('forecast', true)" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                <i class="fas fa-cloud"></i> Shade
                            </button><button id="forecast-sun-btn" onclick="setShade('forecast', false)" style="background: white; color: var(--shram-teal); border: 2px solid var(--shram-teal); border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">
                                <i class="fas fa-sun"></i> Sun
                            </button>
                        </span>
                        <span class="info-tooltip">
                            <i class="fas fa-info-circle"></i>
                            <span class="tooltip-text"><strong>MET Level:</strong> Select based on work intensity.<br>• EHI-3: Light (walking, light housework)<br>• EHI-4: Moderate (carrying loads, cleaning)<br>• EHI-5: Heavy (construction, farming)<br>• EHI-6: Very Heavy (agricultural labor, heavy lifting)<br><br><strong>Sun Exposure:</strong><br>• <strong>Shade:</strong> Working under cover or indoors<br>• <strong>Sun:</strong> Direct sunlight exposure</span>
                        </span>
                    </h2>

                    <!-- Interactive Map for State/District Selection -->
                    <div style="margin-bottom: 1.5rem;">
                        <p id="map-instruction" style="font-weight: 600; color: var(--shram-teal); margin-bottom: 0.5rem;">
                            <i class="fas fa-hand-pointer"></i> Click on a state to select it:
                        </p>
                        <div id="forecast-map" style="height: 350px; border-radius: 8px; border: 2px solid var(--shram-teal);"></div>
                        <div style="margin-top: 0.5rem;">
                            <p id="selected-location-label" style="font-weight: 600; color: var(--shram-teal); margin: 0;"></p>
                        </div>
                    </div>

                    <!-- Hidden selects for compatibility -->
                    <select id="forecast-state-select" style="display: none;">
                        <option value="all">-- Select a State --</option>
                    </select>
                    <select id="forecast-district-select" style="display: none;">
                        <option value="all">All Districts</option>
                    </select>

                    <div style="margin-bottom: 1.5rem;">
                        <button id="forecast-1day-btn" onclick="setForecastDays(1)" class="calculate-btn" style="margin-right: 1rem; padding: 0.5rem 1.5rem; font-size: 0.9rem; background: white; color: var(--shram-teal); border: 2px solid var(--shram-teal);">1-Day</button>
                        <button id="forecast-3day-btn" onclick="setForecastDays(3)" class="calculate-btn" style="padding: 0.5rem 1.5rem; font-size: 0.9rem; background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal);">3-Day</button>
                    </div>

                    <div id="forecast-content">
                        <p style="text-align: center; color: #666;">Loading forecast...</p>
                    </div>
                    <div style="margin-top: 1.5rem;">
                        <canvas id="forecast-chart" style="height: 400px; min-height: 350px;"></canvas>
                    </div>

                    <p style="text-align: center; font-size: 0.85rem; color: #999; margin-top: 1.5rem; font-style: italic;">Data source: WeatherAPI.com</p>
                </div>
            </div>

            <!-- Last 24 Hours (full width) -->
            <div class="section">
                <h2><i class="fas fa-clock"></i> Last 24 Hours for
                    <select id="met-select-last24h" onchange="selectMetLast24h(this.value)" class="met-select-green">
                        <option value="3">EHI-3 (Light Work)</option>
                        <option value="4">EHI-4 (Moderate)</option>
                        <option value="5">EHI-5 (Heavy)</option>
                        <option value="6" selected>EHI-6 (Very Heavy)</option>
                    </select>
                    <span style="margin-left: 0.5rem;">
                        <button id="last24h-shade-btn" onclick="setShade('last24h', true)" style="background: var(--shram-teal); color: white; border: 2px solid var(--shram-teal); padding: 0.5rem 0.75rem; border-radius: 6px 0 0 6px; font-weight: 700; cursor: pointer; font-size: 1rem;">
                            <i class="fas fa-cloud"></i> Shade
                        </button><button id="last24h-sun-btn" onclick="setShade('last24h', false)" style="background: white; color: var(--shram-teal); border: 2px solid var(--shram-teal); border-left: none; padding: 0.5rem 0.75rem; border-radius: 0 6px 6px 0; font-weight: 700; cursor: pointer; font-size: 1rem;">
                            <i class="fas fa-sun"></i> Sun
                        </button>
                    </span>
                    <span class="info-tooltip">
                        <i class="fas fa-info-circle"></i>
                        <span class="tooltip-text"><strong>MET Level:</strong> Select based on work intensity.<br>• EHI-3: Light (walking, light housework)<br>• EHI-4: Moderate (carrying loads, cleaning)<br>• EHI-5: Heavy (construction, farming)<br>• EHI-6: Very Heavy (agricultural labor, heavy lifting)<br><br><strong>Sun Exposure:</strong><br>• <strong>Shade:</strong> Working under cover or indoors<br>• <strong>Sun:</strong> Direct sunlight exposure</span>
                    </span>
                </h2>
                <p id="last24h-timestamp" style="text-align: center; font-size: 1.2rem; color: #000; margin-bottom: 1rem; font-weight: 600;"></p>

                <!-- State/District Filter -->
                <div style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label for="charts-state-select" style="font-weight: 600; margin-right: 0.5rem; color: var(--shram-teal);">State:</label>
                        <select id="charts-state-select" onchange="updateChartsDistricts(); load24HourData();" style="padding: 0.5rem; border-radius: 6px; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); font-weight: 500; width: 100%; font-size: 1rem;">
                            <option value="all">All India</option>
                        </select>
                    </div>
                    <div style="flex: 1; min-width: 200px;">
                        <label for="charts-district-select" style="font-weight: 600; margin-right: 0.5rem; color: var(--shram-teal);">District:</label>
                        <select id="charts-district-select" onchange="load24HourData()" style="padding: 0.5rem; border-radius: 6px; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); font-weight: 500; width: 100%; font-size: 1rem;">
                            <option value="all">All Districts</option>
                        </select>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="chart-container">
                        <h3>Heat Stress Zone Trends</h3>
                        <canvas id="alertTrendChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3>Temperature & Humidity</h3>
                        <canvas id="tempHumidityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Summer Statistics (full width) -->
            <div class="section">
                <h2><i class="fas fa-fire"></i> Summer (March to September) 2025 Stats for EHI-6</h2>
                <div id="summer-stats-content">
                    <p style="text-align: center; color: #666;">Loading summer statistics...</p>
                </div>
            </div>
        </div>

        <!-- TAB 2: LIVE MAP -->
        <div id="livemap-tab" class="tab-content">
            <div class="section" style="padding: 0; overflow: hidden;">
                <iframe src="map_deck.html" style="width: 100%; height: calc(100vh - 200px); min-height: 600px; border: none;"></iframe>
            </div>
        </div>

        <!-- TAB 3: EHI-N CALCULATOR -->
        <div id="calculator-tab" class="tab-content">
            <div class="calculator-container">
                <h2 style="color: white; border-bottom-color: rgba(255,255,255,0.3);">
                    <i class="fas fa-calculator"></i> Calculate EHI-N*
                </h2>

                <div class="calculator-grid">
                    <div class="input-group">
                        <label for="temp-input"><i class="fas fa-thermometer-half"></i> Temperature</label>
                        <div class="input-wrapper">
                            <input type="number" id="temp-input" placeholder="35" min="-50" max="150" value="35">
                            <select id="temp-unit">
                                <option value="C">°C</option>
                                <option value="F">°F</option>
                            </select>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="rh-input"><i class="fas fa-tint"></i> Relative Humidity (%)</label>
                        <input type="number" id="rh-input" placeholder="70" min="0" max="100" value="70" style="padding: 0.75rem; border: none; border-radius: 6px; background: rgba(255,255,255,0.95); font-size: 1rem;">
                    </div>

                    <div class="input-group">
                        <label style="display: block; margin-bottom: 0.5rem;"><i class="fas fa-sun"></i> Solar Exposure</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="solar-option active" data-solar="0" onclick="selectSolar(0)" style="flex: 1; padding: 0.75rem; border: 2px solid white; border-radius: 6px; background: rgba(255,255,255,0.95); cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-tree" style="display: block; font-size: 1.5rem; margin-bottom: 0.25rem;"></i>
                                Shaded
                            </button>
                            <button type="button" class="solar-option" data-solar="1" onclick="selectSolar(1)" style="flex: 1; padding: 0.75rem; border: 2px solid transparent; border-radius: 6px; background: rgba(255,255,255,0.7); cursor: pointer; font-size: 0.9rem; font-weight: 600;">
                                <i class="fas fa-sun" style="display: block; font-size: 1.5rem; margin-bottom: 0.25rem;"></i>
                                Full Sun
                            </button>
                        </div>
                    </div>
                </div>

                <h3 style="color: white; margin-top: 2rem;"><i class="fas fa-running"></i> Select Activity Level (METs)</h3>
                <div class="met-selector">
                    <div class="met-option" data-met="3">
                        <i class="fas fa-walking"></i>
                        <div class="met-label">3 METs</div>
                        <div class="met-desc">Light Work</div>
                    </div>
                    <div class="met-option" data-met="4">
                        <i class="fas fa-person-digging"></i>
                        <div class="met-label">4 METs</div>
                        <div class="met-desc">Moderate Work</div>
                    </div>
                    <div class="met-option" data-met="5">
                        <i class="fas fa-hammer"></i>
                        <div class="met-label">5 METs</div>
                        <div class="met-desc">Heavy Work</div>
                    </div>
                    <div class="met-option active" data-met="6">
                        <i class="fas fa-dumbbell"></i>
                        <div class="met-label">6 METs</div>
                        <div class="met-desc">Very Heavy</div>
                    </div>
                </div>

                <button class="calculate-btn" onclick="calculateEHI()">
                    <i class="fas fa-calculator"></i> Calculate
                </button>

                <div class="result-display" id="result-display">
                    <div class="result-zone" id="result-zone">--</div>
                    <div class="result-value" id="result-value">--</div>
                    <p id="result-description">--</p>
                </div>
            </div>
        </div>

        <!-- TAB 3: ABOUT EHI-N -->
        <div id="about-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-book"></i> About EHI-N*</h2>

                <p>The <strong>Extended Heat Index for Working Populations (EHI-N*)</strong> is a physiologically-based heat stress metric designed to assess thermal strain in labor-intensive occupations.</p>

                <h3><i class="fas fa-tag"></i> Nomenclature</h3>
                <ul>
                    <li><strong>N</strong> = Metabolic load (activity level): Accounts for labor intensity from resting to heavy work (3-6 METs)</li>
                    <li><strong>*</strong> = Sunlight included: Heat stress in direct sunlight conditions
                        <ul>
                            <li><strong>EHI-N</strong> (without *) = Shaded conditions only</li>
                            <li><strong>EHI-N*</strong> (with *) = Full sun exposure</li>
                        </ul>
                    </li>
                </ul>

                <h3><i class="fas fa-flask"></i> Scientific Foundation</h3>
                <p><em>Technical brief coming soon...</em></p>
            </div>

            <div class="section">
                <h2><i class="fas fa-layer-group"></i> Heat Stress Zones</h2>
                <p>EHI-N* classifies heat stress into zones based on physiological strain:</p>

                <div style="margin: 1.5rem 0;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button onclick="showZone(1)" id="zone-btn-1" style="padding: 0.5rem 1rem; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 1</button>
                        <button onclick="showZone(2)" id="zone-btn-2" style="padding: 0.5rem 1rem; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 2</button>
                        <button onclick="showZone(3)" id="zone-btn-3" style="padding: 0.5rem 1rem; border: 2px solid var(--shram-teal); background: white; color: var(--shram-teal); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 3</button>
                        <button onclick="showZone(4)" id="zone-btn-4" style="padding: 0.5rem 1rem; border: 2px solid var(--caution-yellow); background: white; color: var(--caution-yellow); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 4</button>
                        <button onclick="showZone(5)" id="zone-btn-5" style="padding: 0.5rem 1rem; border: 2px solid var(--warning-orange); background: white; color: var(--warning-orange); border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 5</button>
                        <button onclick="showZone(6)" id="zone-btn-6" style="padding: 0.5rem 1rem; border: 2px solid var(--danger-red); background: var(--danger-red); color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">Zone 6</button>
                    </div>

                    <div id="zone-content-1" class="zone-content" style="display: none; background: var(--gray-light); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--shram-teal);">
                        <h3 style="color: var(--shram-teal); margin-bottom: 1rem;"><i class="fas fa-snowflake"></i> Zone 1: Hypothermia (Severe Cold Stress)</h3>
                        <p><strong>Physiological State:</strong> Fractional skin coverage provides sufficient control.</p>
                        <p><strong>Characteristics:</strong> The body can maintain thermal equilibrium through minimal adjustments to skin blood flow and clothing.</p>
                    </div>

                    <div id="zone-content-2" class="zone-content" style="display: none; background: var(--gray-light); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--iecc-brown);">
                        <h3 style="color: var(--iecc-brown); margin-bottom: 1rem;"><i class="fas fa-check-circle"></i> Zone 2: Comfortable (Thermoneutral)</h3>
                        <p><strong>Physiological State:</strong> Clothing adjustment in warm conditions.</p>
                        <p><strong>Characteristics:</strong> Increased skin blood flow while maintaining comfortable clothing levels.</p>
                    </div>

                    <div id="zone-content-3" class="zone-content" style="display: none; background: var(--gray-light); padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--iecc-brown);">
                        <h3 style="color: var(--iecc-brown); margin-bottom: 1rem;"><i class="fas fa-sun"></i> Zone 3: Warm (Manageable Heat)</h3>
                        <p><strong>Physiological State:</strong> Minimal clothing for enhanced evaporative cooling.</p>
                        <p><strong>Characteristics:</strong> Maximum skin blood flow with minimal clothing to maximize heat dissipation.</p>
                    </div>

                    <div id="zone-content-4" class="zone-content" style="display: none; background: #fffde7; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--caution-yellow);">
                        <h3 style="color: var(--caution-yellow); margin-bottom: 1rem;"><i class="fas fa-thermometer-half"></i> Zone 4: Hot (Elevated Risk)</h3>
                        <p><strong>Physiological State:</strong> Cutaneous blood flow becomes limiting.</p>
                        <p><strong>Characteristics:</strong> Skin blood flow reaches maximum capacity. The body relies primarily on sweating for heat dissipation.</p>
                        <p><strong>⚠️ Recommendations:</strong> Frequent breaks and hydration needed. Monitor workers closely.</p>
                    </div>

                    <div id="zone-content-5" class="zone-content" style="display: none; background: #fff3e0; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--warning-orange);">
                        <h3 style="color: var(--warning-orange); margin-bottom: 1rem;"><i class="fas fa-heartbeat"></i> Zone 5: Very Hot (Cardiovascular Stress)</h3>
                        <p><strong>Physiological State:</strong> Skin saturated with sweat - dripping occurs.</p>
                        <p><strong>Characteristics:</strong> Maximum sweating rate achieved. Sweat drips off skin without evaporating, reducing cooling efficiency.</p>
                        <p><strong>⚠️ Recommendations:</strong> Limit heavy work. Increase rest periods. Ensure continuous hydration and access to shade.</p>
                    </div>

                    <div id="zone-content-6" class="zone-content" style="background: #ffebee; padding: 1.5rem; border-radius: 8px; border-left: 4px solid var(--danger-red); border: 2px solid var(--danger-red);">
                        <h3 style="color: var(--danger-red); margin-bottom: 1rem;"><i class="fas fa-exclamation-triangle"></i> Zone 6: Hyperthermia (Severe Heat Stress)</h3>
                        <p><strong>Physiological State:</strong> Core temperature rising - Heat production exceeds dissipation capacity.</p>
                        <p><strong>Characteristics:</strong> All thermoregulatory mechanisms exhausted. Core body temperature is actively increasing, leading to heat illness.</p>
                        <p style="background: white; padding: 1rem; border-radius: 6px; border-left: 4px solid var(--danger-red); margin-top: 1rem;"><strong>🚨 HAZARDOUS - IMMEDIATE ACTION REQUIRED:</strong> Cease work immediately. Move to cool environment. Seek medical attention. Risk of heat stroke and organ damage.</p>
                    </div>
                </div>

                <div style="background: #e3f2fd; padding: 1rem; border-radius: 6px; border-left: 4px solid #1976d2; margin-top: 1.5rem;">
                    <p><strong><i class="fas fa-info-circle"></i> Note:</strong> For India heat stress monitoring, we focus on <strong>Zones 5 and 6</strong> as these represent hazardous heat stress levels requiring intervention.</p>
                </div>
            </div>

            <div class="section">
                <h2><i class="fas fa-bell"></i> Subscribe to Heat Stress Alerts</h2>

                <p>Get notified when hazardous heat stress conditions are detected in your location. Free service for workers, employers, and community organizers.</p>

                <div class="alert-box" style="background: #e3f2fd; border-left-color: var(--shram-teal);">
                    <p><strong><i class="fas fa-info-circle"></i> How it works:</strong></p>
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>Select your state and district</li>
                        <li>Choose your MET level (work intensity) - default is EHI-6 for manual laborers</li>
                        <li>Select which zones trigger alerts - default is Zone 6 (Hazardous) only</li>
                        <li>Get real-time notifications when heat stress reaches your selected threshold</li>
                        <li>Alerts include zone classification, current EHI value, and safety recommendations</li>
                    </ul>
                </div>

                <form id="alert-subscription-form" style="background: var(--gray-light); padding: 2rem; border-radius: 10px; margin-top: 1.5rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="input-group">
                            <label for="subscriber-name" style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Full Name *</label>
                            <input type="text" id="subscriber-name" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-medium); border-radius: 6px; font-size: 1rem;">
                        </div>

                        <div class="input-group">
                            <label for="subscriber-email" style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Email Address *</label>
                            <input type="email" id="subscriber-email" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--gray-medium); border-radius: 6px; font-size: 1rem;">
                        </div>

                        <div class="input-group">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Phone Number</label>
                            <p style="color: #666; font-size: 0.95rem; padding: 0.75rem; background: var(--gray-light); border-radius: 6px; border: 2px dashed var(--gray-medium);">
                                <i class="fas fa-mobile-alt" style="margin-right: 0.5rem;"></i>SMS alerts coming soon
                            </p>
                            <input type="hidden" id="subscriber-phone" value="">
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="input-group">
                            <label for="subscriber-state" style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">States *</label>
                            <select id="subscriber-state" required multiple onchange="updateSubscriberDistricts()" style="width: 100%; padding: 0.75rem; border: 2px solid var(--shram-teal); border-radius: 6px; font-size: 1rem; background: white; min-height: 150px;">
                            </select>
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">Hold Ctrl/Cmd to select multiple states</small>
                        </div>

                        <div class="input-group">
                            <label for="subscriber-district" style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Districts *</label>
                            <select id="subscriber-district" required multiple style="width: 100%; padding: 0.75rem; border: 2px solid var(--iecc-brown); border-radius: 6px; font-size: 1rem; background: white; min-height: 150px;">
                            </select>
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">Hold Ctrl/Cmd to select multiple districts</small>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 1.5rem;">
                        <div class="input-group">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">
                                MET Level (Work Intensity) *
                                <span class="info-tooltip">
                                    <i class="fas fa-info-circle"></i>
                                    <span class="tooltip-text"><strong>MET Level:</strong> Select based on work intensity.<br>• EHI-3: Light (walking, light housework)<br>• EHI-4: Moderate (carrying loads, cleaning)<br>• EHI-5: Heavy (construction, farming)<br>• EHI-6: Very Heavy (agricultural labor, heavy lifting)</span>
                                </span>
                            </label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--gray-medium); border-radius: 6px; background: white;">
                                    <input type="checkbox" id="alert-met-4" value="4" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>EHI-4 (Moderate)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--gray-medium); border-radius: 6px; background: white;">
                                    <input type="checkbox" id="alert-met-5" value="5" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>EHI-5 (Heavy)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--shram-teal); border-radius: 6px; background: #e3f2fd;">
                                    <input type="checkbox" id="alert-met-6" value="6" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span>EHI-6 (Very Heavy)</span>
                                </label>
                            </div>
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">Default: EHI-6 for manual laborers. Select multiple if needed.</small>
                        </div>

                        <div class="input-group">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--gray-dark);">Zone Alerts *</label>
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--caution-yellow); border-radius: 6px; background: #fffde7;">
                                    <input type="checkbox" id="alert-zone-4" value="zone-4" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #f9a825;">Zone 4</span>
                                    <span style="font-size: 0.85rem;">(Caution)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--warning-orange); border-radius: 6px; background: #fff3e0;">
                                    <input type="checkbox" id="alert-zone-5" value="zone-5" style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #ef6c00;">Zone 5</span>
                                    <span style="font-size: 0.85rem;">(High Risk)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 0.75rem; border: 2px solid var(--danger-red); border-radius: 6px; background: #ffebee;">
                                    <input type="checkbox" id="alert-zone-6" value="zone-6" checked style="width: 18px; height: 18px; cursor: pointer;">
                                    <span style="font-weight: 600; color: #c62828;">Zone 6</span>
                                    <span style="font-size: 0.85rem;">(Hazardous)</span>
                                </label>
                            </div>
                            <small style="color: #666; font-size: 0.85rem; margin-top: 0.5rem; display: block;">Default: Zone 6 only. Receive alerts when conditions reach these zones.</small>
                        </div>
                    </div>

                    <button type="button" onclick="showPrivacyModal()" class="calculate-btn" style="width: 100%; margin-top: 1rem;">
                        <i class="fas fa-bell"></i> Subscribe to Alerts
                    </button>

                    <div id="subscription-message" style="display: none; margin-top: 1rem; padding: 1rem; border-radius: 6px; text-align: center; font-weight: 600;"></div>
                </form>
            </div>

            <div class="section">
                <h2><i class="fas fa-envelope"></i> Contact</h2>

                <p>
                India Energy & Climate Center (IECC)<br>
                University of California, Berkeley</p>

                <p>
                    <i class="fas fa-envelope"></i> <a href="mailto:iecc@berkeley.edu">iecc@berkeley.edu</a><br>
                    <i class="fas fa-globe"></i> <a href="https://iecc.gspp.berkeley.edu" target="_blank">iecc.gspp.berkeley.edu</a>
                </p>

                <button onclick="toggleApiModal()" style="margin-top: 1rem; background: var(--shram-teal); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                    <i class="fas fa-code"></i> API Documentation
                </button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p><strong>SHRAM: System for Heat Risk Assessment for Manual labor</strong></p>
        <p>Developed by Elif Kılıç | <span style="color: #fff;">India Energy & Climate Center</span> | University of California, Berkeley</p>
        <p>Data sources: India Meteorological Department (IMD), ERA5 Reanalysis (ECMWF) | Updated hourly</p>
        <p style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.8;">
            &copy; 2025
        </p>
    </div>

    <!-- API Documentation Modal -->
    <div id="apiModal" class="api-modal">
        <div class="api-modal-content">
            <div class="api-modal-header">
                <h2 style="margin: 0;"><i class="fas fa-code"></i> API Documentation</h2>
                <button class="api-modal-close" onclick="toggleApiModal()">&times;</button>
            </div>
            <div class="api-modal-body">
                <p>Access real-time heat stress data programmatically through our API.</p>

                <div class="endpoint-grid">
                    <div class="endpoint-card">
                        <h4><i class="fas fa-globe"></i> Get Current Alerts</h4>
                        <div class="endpoint">
                            <button class="method-badge" style="cursor: pointer; border: none;" onclick="copyToClipboard('https://iecc-io.github.io/ehi-n-dashboard/weather_logs/latest_alerts.json', this)"><i class="fas fa-copy"></i> Copy</button>
                            <span>https://iecc-io.github.io/ehi-n-dashboard/weather_logs/latest_alerts.json</span>
                        </div>
                        <p><strong>Returns:</strong> Current heat stress zones for all Indian districts</p>
                    </div>

                    <div class="endpoint-card">
                        <h4><i class="fas fa-history"></i> Get 24-Hour History</h4>
                        <div class="endpoint">
                            <button class="method-badge" style="cursor: pointer; border: none;" onclick="copyToClipboard('https://iecc-io.github.io/ehi-n-dashboard/weather_logs/alerts_24h.json', this)"><i class="fas fa-copy"></i> Copy</button>
                            <span>https://iecc-io.github.io/ehi-n-dashboard/weather_logs/alerts_24h.json</span>
                        </div>
                        <p><strong>Returns:</strong> Hourly data for last 24 hours with zone distributions</p>
                    </div>

                    <div class="endpoint-card">
                        <h4><i class="fas fa-calendar-alt"></i> Get 3-Day Forecast</h4>
                        <div class="endpoint">
                            <button class="method-badge" style="cursor: pointer; border: none;" onclick="copyToClipboard('https://iecc-io.github.io/ehi-n-dashboard/weather_logs/forecast_data.json', this)"><i class="fas fa-copy"></i> Copy</button>
                            <span>https://iecc-io.github.io/ehi-n-dashboard/weather_logs/forecast_data.json</span>
                        </div>
                        <p><strong>Returns:</strong> 72-hour heat stress forecast with EHI predictions</p>
                    </div>
                </div>

                <h3 style="margin-top: 2rem;"><i class="fas fa-terminal"></i> Example Usage (Python)</h3>
                <pre><code>import requests
import pandas as pd

url = "https://iecc-io.github.io/ehi-n-dashboard/weather_logs/latest_alerts.json"
data = requests.get(url).json()

df = pd.DataFrame(data['alerts'])
print(f"Zone 6 (hazardous): {data['zone_6_count']}")

hazardous = df[df['Hard Labor Heat Stress Zone'] == 'Zone 6']
print(hazardous[['DISTRICT', 'STATE', 'EHI_350 (in shade °C)']])</code></pre>
            </div>
        </div>
    </div>

    <!-- Privacy Notice Modal -->
    <div id="privacyModal" class="api-modal">
        <div class="api-modal-content" style="max-width: 600px;">
            <div class="api-modal-header">
                <h2 style="margin: 0;"><i class="fas fa-shield-alt"></i> Privacy Notice</h2>
            </div>
            <div class="api-modal-body">
                <p style="font-size: 1.1rem; line-height: 1.6;">Your contact information will only be used to send heat stress alerts. We will never share your data with third parties. You can unsubscribe at any time.</p>

                <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
                    <button onclick="closePrivacyModal()" style="background: var(--gray-medium); color: var(--gray-dark); border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                        Cancel
                    </button>
                    <button onclick="acceptPrivacyAndSubmit()" style="background: var(--shram-teal); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem;">
                        <i class="fas fa-check"></i> I Acknowledge
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Separate MET levels for each section (dashboard)
        let currentMetStatus = 6;
        let currentMetForecast = 6;
        let currentMetLast24h = 6;
        // MET level for calculator (independent)
        let currentMet = 6;
        let forecastDays = 3;
        let alertTrendChart, tempHumidityChart;

        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function toggleBanner() {
            const banner = document.getElementById('zone6-banner');
            const toggleBtn = document.getElementById('banner-toggle-btn');

            if (banner.classList.contains('minimized')) {
                banner.classList.remove('minimized');
                toggleBtn.innerHTML = '<i class="fas fa-minus"></i>';
            } else {
                banner.classList.add('minimized');
                toggleBtn.innerHTML = '<i class="fas fa-plus"></i>';
            }
        }

        function toggleApiModal() {
            const modal = document.getElementById('apiModal');
            modal.classList.toggle('show');
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.style.background = '#4caf50';
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = 'var(--iecc-brown)';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        function showPrivacyModal() {
            // First validate the form fields
            const form = document.getElementById('alert-subscription-form');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            const modal = document.getElementById('privacyModal');
            modal.classList.add('show');
        }

        function closePrivacyModal() {
            const modal = document.getElementById('privacyModal');
            modal.classList.remove('show');
        }

        function acceptPrivacyAndSubmit() {
            // Close the modal
            closePrivacyModal();
            // Submit the form
            const form = document.getElementById('alert-subscription-form');
            form.submit();
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const apiModal = document.getElementById('apiModal');
            const privacyModal = document.getElementById('privacyModal');
            if (event.target === apiModal) {
                apiModal.classList.remove('show');
            }
            if (event.target === privacyModal) {
                privacyModal.classList.remove('show');
            }
        }

        let selectedSolar = 0; // Default to shaded

        function selectSolar(value) {
            selectedSolar = value;

            // Update button styles
            document.querySelectorAll('.solar-option').forEach(btn => {
                if (parseFloat(btn.dataset.solar) === value) {
                    btn.style.border = '2px solid white';
                    btn.style.background = 'rgba(255,255,255,0.95)';
                    btn.classList.add('active');
                } else {
                    btn.style.border = '2px solid transparent';
                    btn.style.background = 'rgba(255,255,255,0.7)';
                    btn.classList.remove('active');
                }
            });
        }

        let shadeStates = {
            current: true,
            forecast: true,
            last24h: true
        };

        function setShade(section, isShade) {
            shadeStates[section] = isShade;

            const shadeBtn = document.getElementById(`${section}-shade-btn`);
            const sunBtn = document.getElementById(`${section}-sun-btn`);

            if (isShade) {
                // Shade is active
                shadeBtn.style.background = 'var(--shram-teal)';
                shadeBtn.style.color = 'white';
                sunBtn.style.background = 'white';
                sunBtn.style.color = 'var(--shram-teal)';
            } else {
                // Sun is active
                shadeBtn.style.background = 'white';
                shadeBtn.style.color = 'var(--shram-teal)';
                sunBtn.style.background = 'var(--shram-teal)';
                sunBtn.style.color = 'white';
            }

            // Reload data based on section
            if (section === 'forecast') {
                loadForecast();
            } else if (section === 'last24h') {
                load24HourData();
            } else if (section === 'current') {
                loadLiveData();
            }
        }

        function selectMetCurrent(metLevel) {
            currentMetStatus = parseInt(metLevel);
            loadLiveData();
        }

        function selectMetForecast(metLevel) {
            currentMetForecast = parseInt(metLevel);
            loadForecast();
        }

        function selectMetLast24h(metLevel) {
            currentMetLast24h = parseInt(metLevel);
            load24HourData();
        }

        // Legacy function for backward compatibility
        function selectMet(metLevel) {
            const met = parseInt(metLevel);
            currentMetStatus = met;
            currentMetForecast = met;
            currentMetLast24h = met;
            document.querySelectorAll('.met-select-green').forEach(select => {
                select.value = met;
            });
            loadForecast();
            load24HourData();
            loadLiveData();
        }

        document.querySelectorAll('.met-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.met-option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                currentMet = parseInt(this.dataset.met);
            });
        });

        function setForecastDays(days) {
            forecastDays = days;

            // Update button styles - selected is blue filled, unselected is white with blue border
            const btn1 = document.getElementById('forecast-1day-btn');
            const btn3 = document.getElementById('forecast-3day-btn');

            if (days === 1) {
                btn1.style.background = 'var(--shram-teal)';
                btn1.style.color = 'white';
                btn3.style.background = 'white';
                btn3.style.color = 'var(--shram-teal)';
            } else {
                btn1.style.background = 'white';
                btn1.style.color = 'var(--shram-teal)';
                btn3.style.background = 'var(--shram-teal)';
                btn3.style.color = 'white';
            }

            loadForecast();
        }

        // Unit conversions
        function celsiusToFahrenheit(c) { return (c * 9/5) + 32; }
        function fahrenheitToCelsius(f) { return (f - 32) * 5/9; }
        function kgToLbs(kg) { return kg * 2.20462; }
        function lbsToKg(lbs) { return lbs / 2.20462; }
        function metersToFeet(m) { return m * 3.28084; }
        function feetToMeters(ft) { return ft / 3.28084; }

        function convertHeight() {
            const heightInput = document.getElementById('height-input');
            const unit = document.getElementById('height-unit').value;
            const currentValue = parseFloat(heightInput.value);

            if (unit === 'ft') {
                heightInput.value = metersToFeet(currentValue).toFixed(2);
                heightInput.placeholder = "5.75";
            } else {
                heightInput.value = feetToMeters(currentValue).toFixed(2);
                heightInput.placeholder = "1.75";
            }
        }

        // Cache for lookup tables
        let lookupTableCache = {};

        async function loadLookupTable(met, sunCondition) {
            const key = `met${met}_${sunCondition}`;
            if (lookupTableCache[key]) {
                return lookupTableCache[key];
            }

            try {
                const filename = `ehi_met${met}_${sunCondition}.json`;
                const response = await fetch(`lookup_tables/${filename}`);
                if (!response.ok) throw new Error('Table not found');
                const data = await response.json();
                lookupTableCache[key] = data;
                return data;
            } catch (error) {
                console.error('Error loading lookup table:', error);
                return null;
            }
        }

        async function calculateEHI() {
            let temp = parseFloat(document.getElementById('temp-input').value);
            const tempUnit = document.getElementById('temp-unit').value;
            const rh = Math.round(parseFloat(document.getElementById('rh-input').value));

            // Validate inputs
            if (isNaN(temp) || isNaN(rh)) {
                alert('Please enter valid temperature and humidity values.');
                return;
            }

            if (tempUnit === 'F') temp = fahrenheitToCelsius(temp);

            // Determine sun condition from selectedSolar
            const sunCondition = selectedSolar > 0 ? 'sun' : 'shade';

            // Load the appropriate lookup table
            const lookupTable = await loadLookupTable(currentMet, sunCondition);
            if (!lookupTable) {
                alert('Could not load EHI lookup table. Please try again.');
                return;
            }

            // Round temperature to nearest 0.5°C for lookup
            const tempRounded = (Math.round(temp * 2) / 2).toFixed(1);
            const rhStr = String(Math.min(100, Math.max(0, rh)));

            // Look up EHI and zone
            let ehiValue, zone;
            if (lookupTable.data[tempRounded] && lookupTable.data[tempRounded][rhStr]) {
                [ehiValue, zone] = lookupTable.data[tempRounded][rhStr];
            } else {
                // Temperature out of range
                alert(`Temperature ${tempRounded}°C is outside the lookup table range (-40°C to 60°C).`);
                return;
            }

            const zoneNames = {
                1: "Zone 1: Cold Stress",
                2: "Zone 2: Comfortable",
                3: "Zone 3: Comfortable",
                4: "Zone 4: Caution",
                5: "Zone 5: High Risk",
                6: "Zone 6: HAZARDOUS"
            };

            const zoneColors = {
                1: "#2196f3",
                2: "#4caf50",
                3: "#4caf50",
                4: "#fbc02d",
                5: "#f57c00",
                6: "#d32f2f"
            };

            const descriptions = {
                1: "Cold stress conditions. Ensure adequate insulation.",
                2: "Comfortable conditions for work.",
                3: "Comfortable conditions for work.",
                4: "Caution advised. Take regular breaks and hydrate.",
                5: "High risk. Frequent rest and hydration hazardous.",
                6: "HAZARDOUS: Core temperature rising. Cease work immediately."
            };

            // Build EHI label: EHI-N* where N is MET and * if sun
            const asterisk = (selectedSolar > 0) ? '*' : '';
            const ehiLabel = `EHI-${currentMet}${asterisk}`;

            document.getElementById('result-zone').textContent = zoneNames[zone] || `Zone ${zone}`;
            document.getElementById('result-zone').style.color = zoneColors[zone] || '#333';
            document.getElementById('result-value').textContent = `${ehiLabel}: ${ehiValue.toFixed(1)}°C`;
            document.getElementById('result-description').textContent = descriptions[zone] || '';
            document.getElementById('result-display').classList.add('show');
        }

        function countUniqueDistricts(alerts) {
            return new Set(alerts.map(a => `${a.STATE}_${a.DISTRICT}`)).size;
        }

        // Global data storage
        let allAlertsData = null;
        let all24HourData = null;

        // Populate state dropdowns from data
        function populateStateDropdowns(alerts) {
            const availableStates = [...new Set(alerts.map(a => a.STATE))].sort();

            // All Indian states/UTs for reference (title case to match IMD data format)
            const allStates = [
                'Andaman And Nicobar', 'Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar',
                'Chandigarh', 'Chhattisgarh', 'Dadra And Nagar Haveli', 'Daman And Diu', 'Delhi',
                'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jammu And Kashmir', 'Jharkhand',
                'Karnataka', 'Kerala', 'Ladakh', 'Lakshadweep', 'Madhya Pradesh', 'Maharashtra',
                'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Puducherry', 'Punjab',
                'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana', 'Tripura', 'Uttar Pradesh',
                'Uttarakhand', 'West Bengal'
            ].sort();

            // Current Status dropdowns - make all states clickable, even if no current data
            // (unavailable states will show last available data from 24h history)
            const currentStateSelect = document.getElementById('current-state-select');
            currentStateSelect.innerHTML = '<option value="all">All India</option>';
            allStates.forEach(state => {
                const isAvailable = availableStates.includes(state);
                // Use disabled for grey styling, but we'll enable selection via JS
                const label = isAvailable ? state : `${state} (last available)`;
                const disabled = isAvailable ? '' : 'disabled';
                currentStateSelect.innerHTML += `<option value="${state}" ${disabled}>${label}</option>`;
            });

            // NOTE: Forecast dropdowns are populated separately from india_districts.json
            // by loadIndiaDistrictsData() - do NOT populate them here with uppercase names

            // Charts dropdowns - make all states clickable
            const chartsStateSelect = document.getElementById('charts-state-select');
            chartsStateSelect.innerHTML = '<option value="all">All India</option>';
            allStates.forEach(state => {
                const isAvailable = availableStates.includes(state);
                // Use disabled for grey styling, but we'll enable selection via JS
                const label = isAvailable ? state : `${state} (last available)`;
                const disabled = isAvailable ? '' : 'disabled';
                chartsStateSelect.innerHTML += `<option value="${state}" ${disabled}>${label}</option>`;
            });

            // Enable selection of "disabled" options by temporarily enabling them on mousedown
            enableDisabledOptions(currentStateSelect);
            enableDisabledOptions(chartsStateSelect);
        }

        // Helper function to allow clicking on disabled options (for greyed-out styling)
        function enableDisabledOptions(selectElement) {
            selectElement.addEventListener('mousedown', function(e) {
                // Temporarily enable all disabled options
                const disabledOptions = this.querySelectorAll('option[disabled]');
                disabledOptions.forEach(opt => opt.removeAttribute('disabled'));
            });
            selectElement.addEventListener('change', function() {
                // Re-disable options after selection (will be reset on next populateStateDropdowns call)
            });
        }

        // Update district dropdowns based on selected state
        function updateCurrentDistricts() {
            const stateSelect = document.getElementById('current-state-select');
            const districtSelect = document.getElementById('current-district-select');
            const selectedState = stateSelect.value;

            if (selectedState === 'all') {
                districtSelect.innerHTML = '<option value="all" class="available">All Districts</option>';
                return;
            }

            // First try to get districts from current alerts
            let districts = [];
            let isHistorical = false;

            if (allAlertsData) {
                districts = [...new Set(
                    allAlertsData.alerts
                        .filter(a => a.STATE === selectedState)
                        .map(a => a.DISTRICT)
                )].sort();
            }

            // If no current districts, try to find from 24h historical data
            if (districts.length === 0 && all24HourData && all24HourData.hourly_alerts) {
                const normalizedState = normalizeLocationName(selectedState);
                const allHistoricalDistricts = new Set();

                all24HourData.hourly_alerts.forEach(entry => {
                    const stations = entry.alerts || entry.stations || [];
                    stations.forEach(s => {
                        if (normalizeLocationName(s.STATE) === normalizedState) {
                            allHistoricalDistricts.add(s.DISTRICT);
                        }
                    });
                });

                districts = [...allHistoricalDistricts].sort();
                isHistorical = districts.length > 0;
            }

            // Use disabled attribute for grey styling on historical data
            const headerText = isHistorical ? 'All Districts (last available)' : 'All Districts';
            const headerDisabled = isHistorical ? 'disabled' : '';
            districtSelect.innerHTML = `<option value="all" ${headerDisabled}>${headerText}</option>`;
            districts.forEach(district => {
                const label = district.replace(/_/g, ' ');
                const disabled = isHistorical ? 'disabled' : '';
                districtSelect.innerHTML += `<option value="${district}" ${disabled}>${label}${isHistorical ? ' (last available)' : ''}</option>`;
            });
            // Enable selection of disabled options
            enableDisabledOptions(districtSelect);
        }

        function updateForecastDistricts() {
            const stateSelect = document.getElementById('forecast-state-select');
            const districtSelect = document.getElementById('forecast-district-select');
            const selectedState = stateSelect.value;

            console.log('updateForecastDistricts called, selectedState:', selectedState);
            console.log('window.indiaDistrictsData available:', !!window.indiaDistrictsData);

            // Use window.indiaDistrictsData for forecast districts
            if (!window.indiaDistrictsData || selectedState === 'all') {
                districtSelect.innerHTML = '<option value="all" class="available">All Districts (Capital)</option>';
                return;
            }

            const stateData = window.indiaDistrictsData.states[selectedState];
            console.log('stateData for', selectedState, ':', stateData ? 'found' : 'NOT FOUND');

            if (!stateData) {
                districtSelect.innerHTML = '<option value="all" class="available">All Districts</option>';
                return;
            }

            const districts = Object.keys(stateData.districts).sort();
            console.log('Found', districts.length, 'districts for', selectedState);

            districtSelect.innerHTML = `<option value="all" class="available">All Districts (${stateData.capital.name})</option>`;
            districts.forEach(district => {
                districtSelect.innerHTML += `<option value="${district}" class="available">${district.replace(/_/g, ' ')}</option>`;
            });
        }

        // State name mapping for GeoJSON files
        function getGeoJSONStateName(stateName) {
            // Map from india_districts.json names to geojson file names
            const mapping = {
                'Andhra_Pradesh': 'andhra_pradesh',
                'Arunachal_Pradesh': 'arunachal_pradesh',
                'Assam': 'assam',
                'Bihar': 'bihar',
                'Chhattisgarh': 'chhattisgarh',
                'Goa': 'goa',
                'Gujarat': 'gujarat',
                'Haryana': 'haryana',
                'Himachal_Pradesh': 'himachal_pradesh',
                'Jharkhand': 'jharkhand',
                'Karnataka': 'karnataka',
                'Kerala': 'kerala',
                'Madhya_Pradesh': 'madhya_pradesh',
                'Maharashtra': 'maharashtra',
                'Manipur': 'manipur',
                'Meghalaya': 'meghalaya',
                'Mizoram': 'mizoram',
                'Nagaland': 'nagaland',
                'Odisha': 'odisha',
                'Punjab': 'punjab',
                'Rajasthan': 'rajasthan',
                'Sikkim': 'sikkim',
                'Tamil_Nadu': 'tamil_nadu',
                'Telangana': 'telangana',
                'Tripura': 'tripura',
                'Uttar_Pradesh': 'uttar_pradesh',
                'Uttarakhand': 'uttarakhand',
                'West_Bengal': 'west_bengal',
                'Andaman_and_Nicobar': 'andaman_and_nicobar_islands',
                'Chandigarh': 'chandigarh',
                'Dadra_and_Nagar_Haveli': 'dadra_and_nagar_haveli_and_daman_and_diu',
                'Delhi': 'delhi',
                'Jammu_and_Kashmir': 'jammu_and_kashmir',
                'Ladakh': 'ladakh',
                'Lakshadweep': 'lakshadweep',
                'Puducherry': 'puducherry'
            };
            return mapping[stateName] || stateName.toLowerCase();
        }

        // Initialize the forecast map with all states
        async function initForecastMap() {
            const instruction = document.getElementById('map-instruction');
            const label = document.getElementById('selected-location-label');

            // Initialize map
            forecastMap = L.map('forecast-map', {
                zoomControl: true,
                attributionControl: false
            }).setView([22.5, 82], 4);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(forecastMap);

            // Add IECC logo marker at Berkeley office location
            const ieccIcon = L.divIcon({
                className: 'iecc-marker',
                html: '<img src="iecc-logo.svg" style="height: 18px;">',
                iconSize: [60, 18],
                iconAnchor: [30, 9]
            });
            L.marker([37.8755, -122.2618], { icon: ieccIcon })
                .bindTooltip(`
                    <div style="text-align: center; min-width: 150px;">
                        <div style="font-weight: 600; color: #2d637f; margin-bottom: 0.5rem;">
                            <i class="fas fa-users"></i> Heat Resilience Team
                        </div>
                        <div style="font-size: 0.8rem; line-height: 1.5;">
                            <div style="font-weight: 600;">Elif Kilic <span style="font-weight: 400; color: #666; font-size: 0.7rem;">(Lead)</span></div>
                            <div>Rohini Tamarana</div>
                            <div>Piyush Narang</div>
                            <div>Fernando Augusto</div>
                            <div>Shruti Deorah</div>
                            <div>Prof. Ashok Gadgil</div>
                        </div>
                        <div style="font-size: 0.7rem; color: #666; margin-top: 0.5rem; border-top: 1px solid #eee; padding-top: 0.5rem;">
                            India Energy & Climate Center<br>UC Berkeley
                        </div>
                        <div style="font-size: 0.65rem; color: #2d637f; margin-top: 0.3rem;">
                            <i class="fas fa-mouse-pointer"></i> Click to visit team page
                        </div>
                    </div>
                `, { direction: 'top', offset: [0, -5] })
                .on('click', function() {
                    window.open('https://iecc.gspp.berkeley.edu/about/team/', '_blank');
                })
                .addTo(forecastMap);

            // Load states GeoJSON
            try {
                const response = await fetch('geojson/india_states.geojson');
                if (!response.ok) throw new Error('Could not load states GeoJSON');
                statesGeoJSON = await response.json();
                showAllStates();
            } catch (error) {
                console.error('Error loading states GeoJSON:', error);
                instruction.textContent = 'Error loading map data';
            }
        }

        // Show all states on the map
        function showAllStates() {
            const instruction = document.getElementById('map-instruction');
            const label = document.getElementById('selected-location-label');

            // Reset state
            currentSelectedState = null;
            selectedDistrictCoords = null;
            document.getElementById('forecast-state-select').value = 'all';

            instruction.innerHTML = '<i class="fas fa-hand-pointer"></i> Click on a state to select it:';
            label.textContent = '';

            // Remove district layer if exists
            if (districtLayer) {
                forecastMap.removeLayer(districtLayer);
                districtLayer = null;
            }

            // Remove states layer if exists
            if (statesLayer) {
                forecastMap.removeLayer(statesLayer);
            }

            // Add states layer
            if (statesGeoJSON) {
                statesLayer = L.geoJSON(statesGeoJSON, {
                    style: {
                        fillColor: '#2d637f',
                        fillOpacity: 0.4,
                        color: '#2d637f',
                        weight: 2
                    },
                    onEachFeature: function(feature, layer) {
                        const stateName = feature.properties.name;

                        layer.bindTooltip(stateName.replace(/_/g, ' '), {
                            permanent: false,
                            direction: 'center',
                            className: 'district-tooltip'
                        });

                        layer.on('click', function() {
                            zoomToState(stateName);
                        });

                        layer.on('mouseover', function() {
                            layer.setStyle({ fillOpacity: 0.7 });
                        });

                        layer.on('mouseout', function() {
                            layer.setStyle({ fillOpacity: 0.4 });
                        });
                    }
                }).addTo(forecastMap);

                // Fit to India bounds
                forecastMap.fitBounds(statesLayer.getBounds(), { padding: [10, 10] });
            }

            // Show "select a state" in forecast
            loadForecast();
        }

        // Zoom to a specific state and show its districts
        async function zoomToState(stateName) {
            const instruction = document.getElementById('map-instruction');
            const label = document.getElementById('selected-location-label');

            currentSelectedState = stateName;
            document.getElementById('forecast-state-select').value = stateName;

            instruction.innerHTML = `<i class="fas fa-map-marker-alt"></i> Click on a district in <strong>${stateName.replace(/_/g, ' ')}</strong>:`;
            label.textContent = 'Loading districts...';

            // Update states layer to show shaded (other states clickable)
            if (statesLayer) {
                forecastMap.removeLayer(statesLayer);
            }

            // Re-add states layer with shaded style (other states visible and clickable)
            if (statesGeoJSON) {
                statesLayer = L.geoJSON(statesGeoJSON, {
                    style: function(feature) {
                        const isCurrentState = feature.properties.name === stateName;
                        return {
                            fillColor: '#2d637f',
                            fillOpacity: isCurrentState ? 0 : 0.2,  // Hide fill for current state (districts will show)
                            color: '#2d637f',
                            weight: isCurrentState ? 0 : 1
                        };
                    },
                    onEachFeature: function(feature, layer) {
                        const featureStateName = feature.properties.name;
                        if (featureStateName !== stateName) {
                            layer.bindTooltip(featureStateName.replace(/_/g, ' '), {
                                permanent: false,
                                direction: 'center',
                                className: 'district-tooltip'
                            });

                            layer.on('click', function() {
                                zoomToState(featureStateName);
                            });

                            layer.on('mouseover', function() {
                                layer.setStyle({ fillOpacity: 0.5 });
                            });

                            layer.on('mouseout', function() {
                                layer.setStyle({ fillOpacity: 0.2 });
                            });
                        }
                    }
                }).addTo(forecastMap);
            }

            // Load district GeoJSON for this state
            try {
                const geoJSONName = getGeoJSONStateName(stateName);
                const response = await fetch(`geojson/${geoJSONName}_districts.geojson`);

                if (!response.ok) {
                    throw new Error(`GeoJSON not found for ${stateName}`);
                }

                const geojsonData = await response.json();

                // Remove old district layer
                if (districtLayer) {
                    forecastMap.removeLayer(districtLayer);
                }

                // Add district layer with IECC blue
                districtLayer = L.geoJSON(geojsonData, {
                    style: {
                        fillColor: '#2d637f',
                        fillOpacity: 0.3,
                        color: '#2d637f',
                        weight: 2
                    },
                    onEachFeature: function(feature, layer) {
                        const districtName = feature.properties.name;
                        const centroid = feature.properties.centroid;

                        layer.bindTooltip(districtName.replace(/_/g, ' '), {
                            permanent: false,
                            direction: 'center',
                            className: 'district-tooltip'
                        });

                        layer.on('click', function() {
                            // Highlight selected district - reset others to IECC blue
                            districtLayer.eachLayer(l => {
                                l.setStyle({ fillColor: '#2d637f', fillOpacity: 0.3 });
                            });
                            // Set selected district to IECC brown
                            layer.setStyle({ fillColor: '#8B5A2B', fillOpacity: 0.6 });

                            // Store coordinates
                            selectedDistrictCoords = {
                                name: districtName,
                                lat: centroid[1],
                                lon: centroid[0]
                            };

                            label.textContent = `Selected: ${districtName.replace(/_/g, ' ')}`;
                            document.getElementById('forecast-district-select').value = districtName;
                            loadForecast();
                        });

                        layer.on('mouseover', function() {
                            if (!selectedDistrictCoords || selectedDistrictCoords.name !== districtName) {
                                layer.setStyle({ fillOpacity: 0.5 });
                            }
                        });

                        layer.on('mouseout', function() {
                            if (!selectedDistrictCoords || selectedDistrictCoords.name !== districtName) {
                                layer.setStyle({ fillOpacity: 0.3 });
                            }
                        });
                    }
                }).addTo(forecastMap);

                // Fit to state bounds
                forecastMap.fitBounds(districtLayer.getBounds(), { padding: [20, 20] });

                // Use state capital for initial forecast
                if (window.indiaDistrictsData && window.indiaDistrictsData.states[stateName]) {
                    const capital = window.indiaDistrictsData.states[stateName].capital;
                    selectedDistrictCoords = {
                        name: capital.name,
                        lat: capital.lat,
                        lon: capital.lon
                    };
                    label.textContent = `State capital: ${capital.name} (click a district to change)`;
                    loadForecast();
                } else {
                    label.textContent = 'Click on a district';
                }

            } catch (error) {
                console.error('Error loading district GeoJSON:', error);
                label.textContent = `Districts not available - using state capital`;

                // Fall back to state capital
                if (window.indiaDistrictsData && window.indiaDistrictsData.states[stateName]) {
                    const capital = window.indiaDistrictsData.states[stateName].capital;
                    selectedDistrictCoords = {
                        name: capital.name,
                        lat: capital.lat,
                        lon: capital.lon
                    };
                    loadForecast();
                }
            }
        }

        // Keep onStateSelected for compatibility but redirect to map
        function onStateSelected() {
            const selectedState = document.getElementById('forecast-state-select').value;
            if (selectedState === 'all') {
                showAllStates();
            } else {
                zoomToState(selectedState);
            }
        }

        function updateChartsDistricts() {
            const stateSelect = document.getElementById('charts-state-select');
            const districtSelect = document.getElementById('charts-district-select');
            const selectedState = stateSelect.value;

            if (selectedState === 'all') {
                districtSelect.innerHTML = '<option value="all" class="available">All Districts</option>';
                return;
            }

            // First try to get districts from current alerts
            let districts = [];
            let isHistorical = false;

            if (allAlertsData) {
                districts = [...new Set(
                    allAlertsData.alerts
                        .filter(a => a.STATE === selectedState)
                        .map(a => a.DISTRICT)
                )].sort();
            }

            // If no current districts, try to find from 24h historical data
            if (districts.length === 0 && all24HourData && all24HourData.hourly_alerts) {
                const normalizedState = normalizeLocationName(selectedState);
                const allHistoricalDistricts = new Set();

                all24HourData.hourly_alerts.forEach(entry => {
                    const stations = entry.alerts || entry.stations || [];
                    stations.forEach(s => {
                        if (normalizeLocationName(s.STATE) === normalizedState) {
                            allHistoricalDistricts.add(s.DISTRICT);
                        }
                    });
                });

                districts = [...allHistoricalDistricts].sort();
                isHistorical = districts.length > 0;
            }

            // Use disabled attribute for grey styling on historical data
            const headerText = isHistorical ? 'All Districts (last available)' : 'All Districts';
            const headerDisabled = isHistorical ? 'disabled' : '';
            districtSelect.innerHTML = `<option value="all" ${headerDisabled}>${headerText}</option>`;
            districts.forEach(district => {
                const label = district.replace(/_/g, ' ');
                const disabled = isHistorical ? 'disabled' : '';
                districtSelect.innerHTML += `<option value="${district}" ${disabled}>${label}${isHistorical ? ' (last available)' : ''}</option>`;
            });
            // Enable selection of disabled options
            enableDisabledOptions(districtSelect);
        }

        // Helper to normalize state/district names for comparison
        function normalizeLocationName(str) {
            return str ? str.toLowerCase().replace(/_/g, ' ').trim() : '';
        }

        // Find last available data from 24h history for a state/district
        function findLastAvailableData(selectedState, selectedDistrict) {
            if (!all24HourData || !all24HourData.hourly_alerts) return null;

            const hourlySource = all24HourData.hourly_alerts;
            const normalizedState = normalizeLocationName(selectedState);
            const normalizedDistrict = selectedDistrict !== 'all' ? normalizeLocationName(selectedDistrict) : null;

            // Search from most recent to oldest
            for (let i = hourlySource.length - 1; i >= 0; i--) {
                const entry = hourlySource[i];
                const stations = entry.alerts || entry.stations || [];

                let matchingStations = stations.filter(s =>
                    normalizeLocationName(s.STATE) === normalizedState
                );

                if (normalizedDistrict) {
                    matchingStations = matchingStations.filter(s =>
                        normalizeLocationName(s.DISTRICT) === normalizedDistrict
                    );
                }

                if (matchingStations.length > 0) {
                    return {
                        timestamp: entry.timestamp,
                        alerts: matchingStations
                    };
                }
            }
            return null;
        }

        // Filter current status based on selected state/district
        function filterCurrentStatus() {
            if (!allAlertsData) return;

            const selectedState = document.getElementById('current-state-select').value;
            const selectedDistrict = document.getElementById('current-district-select').value;

            let filteredAlerts = allAlertsData.alerts;
            let isHistoricalData = false;
            let dataTimestamp = allAlertsData.timestamp;

            if (selectedState !== 'all') {
                filteredAlerts = filteredAlerts.filter(a => a.STATE === selectedState);
            }
            if (selectedDistrict !== 'all') {
                filteredAlerts = filteredAlerts.filter(a => a.DISTRICT === selectedDistrict);
            }

            // If no current data found, try to get last available from 24h history
            if (filteredAlerts.length === 0 && selectedState !== 'all') {
                const historicalData = findLastAvailableData(selectedState, selectedDistrict);
                if (historicalData) {
                    filteredAlerts = historicalData.alerts;
                    dataTimestamp = historicalData.timestamp;
                    isHistoricalData = true;
                }
            }

            // Recalculate zone counts using the correct column names
            const zone6Count = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 6").length;
            const zone5Count = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 5").length;
            const zone4Count = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 4").length;
            const totalDistricts = countUniqueDistricts(filteredAlerts);

            // Update display
            const locationText = selectedState === 'all' ? 'All India' :
                (selectedDistrict === 'all' ? selectedState.replace(/_/g, ' ') :
                selectedDistrict.replace(/_/g, ' ') + ', ' + selectedState.replace(/_/g, ' '));

            const formattedTimestamp = new Date(dataTimestamp).toLocaleString('en-IN', {
                timeZone: 'Asia/Calcutta',
                dateStyle: 'medium',
                timeStyle: 'short'
            });

            // Show warning and red timestamp if using historical data
            const timestampLabel = isHistoricalData ? 'Last Data Available' : 'Last Updated';
            const timestampStyle = isHistoricalData
                ? 'background: #ffebee; color: #c62828; padding: 0.5rem 1rem; border-radius: 6px; border: 1px solid #ef9a9a;'
                : '';

            document.getElementById('live-status-summary').innerHTML = `
                <p style="text-align: center; font-size: 1.1rem; margin-bottom: 1rem; ${timestampStyle}">
                    ${isHistoricalData ? '<i class="fas fa-history"></i> ' : ''}<strong>${timestampLabel}: ${formattedTimestamp} IST</strong>
                    ${isHistoricalData ? '<br><small style="font-weight: normal;">No current IMD data for this location</small>' : ''}
                </p>
                <p style="text-align: center; font-size: 1.2rem; color: #333;">
                    <strong>${filteredAlerts.length}</strong> stations in <strong>${locationText}</strong> across <strong>${totalDistricts}</strong> districts
                </p>
            `;

            // Get zone-specific districts for tooltips
            const zone6 = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 6");
            const zone5 = filteredAlerts.filter(a => a["Hard Labor Heat Stress Zone"] === "Zone 5");

            const noAlertsMessage = isHistoricalData ?
                '<p style="margin-top: 0.5rem; font-style: italic;">No alerts in last available data</p>' :
                '<p style="margin-top: 0.5rem; font-style: italic;">No alerts currently</p>';

            const zone6DistrictsList = zone6.length > 0 ?
                `<div class="districts-list">${zone6.map(a => `${a.DISTRICT.replace(/_/g, ' ')}, ${a.STATE.replace(/_/g, ' ')}`).join('<br>')}</div>` :
                noAlertsMessage;

            const zone5DistrictsList = zone5.length > 0 ?
                `<div class="districts-list">${zone5.map(a => `${a.DISTRICT.replace(/_/g, ' ')}, ${a.STATE.replace(/_/g, ' ')}`).join('<br>')}</div>` :
                noAlertsMessage;

            document.getElementById('status-grid').innerHTML = `
                <div class="stat-box">
                    <div class="stat-number">${filteredAlerts.length}</div>
                    <div class="stat-label">Total Alerts</div>
                </div>
                <div class="stat-box">
                    <div class="stat-number">${totalDistricts}</div>
                    <div class="stat-label">Districts Affected</div>
                </div>
                <div class="stat-box hoverable" style="background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%); padding: 1rem; cursor: pointer; border-color: #d32f2f;">
                    <div class="stat-number" style="font-size: 1.8rem;">${zone6Count}</div>
                    <div class="stat-label" style="font-size: 0.85rem;">Zone 6 (Hazardous)</div>
                    <div class="zone-tooltip" style="border-color: #d32f2f;">
                        <h4 style="color: #d32f2f;"><i class="fas fa-exclamation-triangle"></i> Zone 6: Hyperthermia (HAZARDOUS)</h4>
                        <p><strong>Action Required:</strong> Core temperature rising - cease work immediately. Move to cool environment. Seek medical attention.</p>
                        ${zone6DistrictsList}
                    </div>
                </div>
                <div class="stat-box hoverable" style="background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%); padding: 1rem; cursor: pointer; border-color: #f57c00;">
                    <div class="stat-number" style="font-size: 1.8rem;">${zone5Count}</div>
                    <div class="stat-label" style="font-size: 0.85rem;">Zone 5 (High)</div>
                    <div class="zone-tooltip" style="border-color: #f57c00;">
                        <h4 style="color: #f57c00;"><i class="fas fa-heartbeat"></i> Zone 5: Very Hot (Cardiovascular Stress)</h4>
                        <p><strong>Action Required:</strong> Limit heavy work. Increase rest periods. Ensure continuous hydration and access to shade.</p>
                        ${zone5DistrictsList}
                    </div>
                </div>
            `;
            // Note: Zone 6 banner is NOT updated here - it stays global (set in loadLiveData)
        }

        async function loadLiveData() {
            try {
                // Try local file first (for local development), then fall back to GitHub Pages
                let response;
                try {
                    response = await fetch('weather_logs/latest_alerts.json');
                    if (!response.ok) throw new Error('Local file not found');
                } catch (e) {
                    response = await fetch('https://iecc-io.github.io/ehi-n-dashboard/weather_logs/latest_alerts.json');
                }
                const data = await response.json();

                // Store data globally for filtering
                allAlertsData = data;

                // Populate state dropdowns
                populateStateDropdowns(data.alerts);

                // Get current MET level and sun condition for "Current" section
                const met = currentMetStatus || 6;
                const sun = shadeStates.current ? 'shade' : 'sun';
                const zoneCol = `Zone_${met}_${sun}`;
                const ehiCol = `EHI_${met}_${sun}`;

                // Get zone counts for selected MET/sun from zone_counts object
                const zoneCountKey = `met${met}_${sun}`;
                const zone6Count = data.zone_counts ? (data.zone_counts[`${zoneCountKey}_zone6`] || 0) : data.zone_6_count;
                const zone5Count = data.zone_counts ? (data.zone_counts[`${zoneCountKey}_zone5`] || 0) : data.zone_5_count;

                const lastUpdate = new Date(data.timestamp).toLocaleString('en-IN', {
                    timeZone: 'Asia/Calcutta',
                    dateStyle: 'medium',
                    timeStyle: 'short'
                });

                // Update Last 24 Hours timestamp as well
                document.getElementById('last24h-timestamp').innerHTML = `<strong>Last Updated: ${lastUpdate} IST</strong>`;

                // Filter alerts for selected MET/sun (only Zone 5 & 6 are alerts)
                const zone6 = data.alerts.filter(a => a[zoneCol] === "Zone 6");
                const zone5 = data.alerts.filter(a => a[zoneCol] === "Zone 5");
                const alertCount = zone6.length + zone5.length;
                const totalDistricts = countUniqueDistricts([...zone6, ...zone5]);

                document.getElementById('live-status-summary').innerHTML = `
                    <p style="text-align: center; font-size: 1.2rem; margin-bottom: 1rem; font-weight: 700; color: #fff;">
                        Last Updated: ${lastUpdate} IST
                    </p>
                `;

                const zone6DistrictsList = zone6.length > 0 ?
                    `<div class="districts-list">${zone6.map(a => `${a.DISTRICT}, ${a.STATE}`).join('<br>')}</div>` :
                    '<p style="margin-top: 0.5rem; font-style: italic;">No alerts currently</p>';

                const zone5DistrictsList = zone5.length > 0 ?
                    `<div class="districts-list">${zone5.map(a => `${a.DISTRICT}, ${a.STATE}`).join('<br>')}</div>` :
                    '<p style="margin-top: 0.5rem; font-style: italic;">No alerts currently</p>';

                document.getElementById('status-grid').innerHTML = `
                    <div class="stat-box">
                        <div class="stat-number">${alertCount}</div>
                        <div class="stat-label">Total Alerts (Zone 5 & 6)</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${totalDistricts}</div>
                        <div class="stat-label">Districts Affected</div>
                    </div>
                    <div class="stat-box hoverable" style="background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%); padding: 1rem; cursor: pointer; border-color: #d32f2f;">
                        <div class="stat-number" style="font-size: 1.8rem;">${zone6.length}</div>
                        <div class="stat-label" style="font-size: 0.85rem;">Zone 6 (Hazardous)</div>
                        <div class="zone-tooltip" style="border-color: #d32f2f;">
                            <h4 style="color: #d32f2f;"><i class="fas fa-exclamation-triangle"></i> Zone 6: Hyperthermia (HAZARDOUS)</h4>
                            <p><strong>Action Required:</strong> Core temperature rising - cease work immediately. Move to cool environment. Seek medical attention.</p>
                            ${zone6DistrictsList}
                        </div>
                    </div>
                    <div class="stat-box hoverable" style="background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%); padding: 1rem; cursor: pointer; border-color: #f57c00;">
                        <div class="stat-number" style="font-size: 1.8rem;">${zone5.length}</div>
                        <div class="stat-label" style="font-size: 0.85rem;">Zone 5 (High Risk)</div>
                        <div class="zone-tooltip" style="border-color: #f57c00;">
                            <h4 style="color: #f57c00;"><i class="fas fa-heartbeat"></i> Zone 5: High Risk (Cardiovascular Stress)</h4>
                            <p><strong>Action Required:</strong> Limit heavy work. Increase rest periods. Ensure continuous hydration and access to shade.</p>
                            ${zone5DistrictsList}
                        </div>
                    </div>
                `;

                // Update Zone 6 floating banner - use GLOBAL zone 6 data
                // Check for Zone 6 across ALL MET levels and sun conditions
                const globalZone6 = data.alerts.filter(a =>
                    a["Zone_3_shade"] === "Zone 6" || a["Zone_3_sun"] === "Zone 6" ||
                    a["Zone_4_shade"] === "Zone 6" || a["Zone_4_sun"] === "Zone 6" ||
                    a["Zone_5_shade"] === "Zone 6" || a["Zone_5_sun"] === "Zone 6" ||
                    a["Zone_6_shade"] === "Zone 6" || a["Zone_6_sun"] === "Zone 6"
                );
                if (globalZone6.length > 0) {
                    const marqueeItems = globalZone6.map(a => `${a.DISTRICT}, ${a.STATE}`).join(' | ');
                    const districtsList = globalZone6.map(a => `<div class="banner-district-item"><i class="fas fa-map-marker-alt"></i>${a.DISTRICT}, ${a.STATE}</div>`).join('');
                    const bannerHtml = `
                        <strong style="font-size: 1.4rem;"><i class="fas fa-exclamation-triangle"></i> ZONE 6 DETECTED (${globalZone6.length} locations)</strong><br>
                        <span style="font-size: 1.1rem; font-weight: 700;">Severe hyperthermia risk found in these regions:</span>
                        <div class="banner-districts-list">
                            ${districtsList}
                        </div>
                        <span class="banner-static-text">⚠️ ZONE 6 DETECTED</span>
                        <div class="banner-marquee-container">
                            <marquee behavior="scroll" direction="left" scrollamount="5" style="font-size: 1rem;">
                                ${marqueeItems} | ${marqueeItems}
                            </marquee>
                        </div>
                    `;
                    document.getElementById('zone6-banner-content').innerHTML = bannerHtml;
                    document.getElementById('zone6-banner').style.background = 'linear-gradient(135deg, #d32f2f 0%, #c62828 100%)';
                    document.getElementById('zone6-banner').classList.add('show');

                } else {
                    // Show teal IECC advisory banner
                    const bannerHtml = `
                        <strong style="font-size: 1.2rem;"><i class="fas fa-info-circle"></i> Heat Stress Advisory</strong><br>
                        <span style="font-size: 1rem;">No hazardous (Zone 6) heat stress alerts at this time. Learn more about the Extended Heat Index (EHI) methodology:</span><br>
                        <a href="https://iecc.gspp.berkeley.edu/resources/visualizations/national-advisory-on-the-extended-heatindex-350-ehi-350/" target="_blank" style="color: white; font-weight: 700; text-decoration: underline; font-size: 1rem; margin-top: 0.5rem; display: inline-block;">
                            <i class="fas fa-external-link-alt"></i> See EHI Advisory from IECC
                        </a>
                    `;
                    document.getElementById('zone6-banner-content').innerHTML = bannerHtml;
                    document.getElementById('zone6-banner').style.background = 'var(--shram-teal)';
                    document.getElementById('zone6-banner').style.boxShadow = '0 4px 20px rgba(0, 109, 119, 0.4)';
                    document.getElementById('zone6-banner').classList.add('show');
                }
            } catch (error) {
                console.error('Error loading live data:', error);
                document.getElementById('live-status-summary').innerHTML = '<p style="text-align: center; color: #666;">Data will load when available</p>';
            }
        }

        // WeatherAPI.com API key
        const WEATHER_API_KEY = '4753e967970b4abca6b63520261401';

        // India districts data (loaded from JSON) - using window to ensure global scope
        window.indiaDistrictsData = null;
        let forecastChart = null;

        // Forecast map variables
        let forecastMap = null;
        let statesLayer = null;
        let districtLayer = null;
        let selectedDistrictCoords = null;
        let currentSelectedState = null;
        let statesGeoJSON = null;

        // Load districts data on startup
        async function loadIndiaDistrictsData() {
            try {
                console.log('Loading india_districts.json...');
                const response = await fetch('india_districts.json?t=' + Date.now());
                window.indiaDistrictsData = await response.json();
                const numStates = Object.keys(window.indiaDistrictsData.states || {}).length;
                console.log('Districts data loaded:', numStates, 'states');
                console.log('First 5 states:', Object.keys(window.indiaDistrictsData.states).slice(0, 5));

                // Force populate the dropdown immediately
                const stateSelect = document.getElementById('forecast-state-select');
                if (stateSelect && window.indiaDistrictsData && window.indiaDistrictsData.states) {
                    stateSelect.innerHTML = '<option value="all">-- Select a State --</option>';
                    Object.keys(window.indiaDistrictsData.states).sort().forEach(state => {
                        const opt = document.createElement('option');
                        opt.value = state;
                        opt.textContent = state.replace(/_/g, ' ');
                        stateSelect.appendChild(opt);
                    });
                    console.log('Dropdown populated with', stateSelect.options.length, 'options');
                }
            } catch (error) {
                console.error('Error loading districts data:', error);
            }
        }

        // Populate forecast state dropdown from districts data
        function populateForecastStateDropdown() {
            console.log('=== populateForecastStateDropdown called ===');
            if (!window.indiaDistrictsData) {
                console.log('populateForecastStateDropdown: No data yet');
                return;
            }

            const stateSelect = document.getElementById('forecast-state-select');
            console.log('stateSelect element:', stateSelect);
            if (!stateSelect) {
                console.error('forecast-state-select element not found!');
                return;
            }

            const states = Object.keys(window.indiaDistrictsData.states).sort();
            console.log('Populating state dropdown with', states.length, 'states:', states.slice(0, 5));

            // Clear and rebuild
            stateSelect.innerHTML = '';
            const allIndiaOption = document.createElement('option');
            allIndiaOption.value = 'all';
            allIndiaOption.textContent = 'All India';
            stateSelect.appendChild(allIndiaOption);

            states.forEach(state => {
                const option = document.createElement('option');
                option.value = state;
                option.textContent = state.replace(/_/g, ' ');
                stateSelect.appendChild(option);
            });

            console.log('State dropdown now has', stateSelect.options.length, 'options');
            console.log('Options:', Array.from(stateSelect.options).slice(0, 5).map(o => o.value));
        }

        // Simplified EHI zone calculation based on temperature and humidity
        function calculateZone(temp, rh, met, inSun) {
            // MET levels: 3=180W, 4=240W, 5=300W, 6=360W
            const metWatts = met * 60;

            // Simple zone estimation based on conditions
            // Higher temp + higher humidity + higher MET = higher zone
            const heatLoad = temp + (rh * 0.3) + (met * 2) + (inSun ? 3 : 0);

            if (heatLoad > 55 || (temp > 40 && rh > 50)) return 6;
            if (heatLoad > 48 || (temp > 38 && rh > 40)) return 5;
            if (heatLoad > 42 || temp > 35) return 4;
            if (heatLoad > 35) return 3;
            return 2;
        }

        function getZoneColor(zone) {
            const colors = {
                6: '#d32f2f', // Hazardous - red
                5: '#f57c00', // High risk - orange
                4: '#fbc02d', // Caution - yellow
                3: '#4caf50', // Comfortable - green
                2: '#4caf50', // Comfortable - green
                1: '#2196f3'  // Cold stress - blue
            };
            return colors[zone] || '#999';
        }

        function getZoneLabel(zone) {
            const labels = {
                6: 'HAZARDOUS',
                5: 'High Risk',
                4: 'Caution',
                3: 'Comfortable',
                2: 'Comfortable',
                1: 'Cold Stress'
            };
            return labels[zone] || 'Unknown';
        }

        // Get location coordinates from district data
        function getForecastLocation() {
            // First check if we have coordinates from map click
            if (selectedDistrictCoords) {
                console.log('Using map-selected district:', selectedDistrictCoords.name);
                return selectedDistrictCoords;
            }

            const selectedState = document.getElementById('forecast-state-select').value;
            const selectedDistrict = document.getElementById('forecast-district-select').value;

            console.log('getForecastLocation: state=', selectedState, ', district=', selectedDistrict);

            // Default: New Delhi
            let location = { name: 'New Delhi', lat: 28.6139, lon: 77.2090 };

            if (!window.indiaDistrictsData) {
                console.log('No districts data, using default New Delhi');
                return location;
            }

            if (selectedState === 'all') {
                // Will show "select a state" message, not fetch
                return location;
            }

            const stateData = window.indiaDistrictsData.states[selectedState];
            console.log('Looking for state:', selectedState, '- Found:', !!stateData);
            if (!stateData) {
                console.log('State not found in data:', selectedState);
                console.log('Available states:', Object.keys(window.indiaDistrictsData.states).slice(0, 5));
                return location;
            }

            console.log('Using state capital:', stateData.capital.name, 'at', stateData.capital.lat, stateData.capital.lon);

            if (selectedDistrict === 'all') {
                // Use state capital
                return {
                    name: stateData.capital.name,
                    lat: stateData.capital.lat,
                    lon: stateData.capital.lon
                };
            }

            // Use specific district
            const districtData = stateData.districts[selectedDistrict];
            if (districtData) {
                return {
                    name: selectedDistrict.replace(/_/g, ' '),
                    lat: districtData.lat,
                    lon: districtData.lon
                };
            }

            return location;
        }

        // Store pre-computed forecast data globally
        let forecastData = null;

        async function loadForecastData() {
            // Load pre-computed forecast data once
            if (!forecastData) {
                try {
                    // Try local file first, then fall back to GitHub Pages
                    let response;
                    try {
                        response = await fetch('weather_logs/forecast_data.json');
                        if (!response.ok) throw new Error('Local file not found');
                    } catch (e) {
                        response = await fetch('https://iecc-io.github.io/ehi-n-dashboard/weather_logs/forecast_data.json');
                    }
                    forecastData = await response.json();
                    console.log('Loaded pre-computed forecast data:', forecastData.metadata);
                } catch (error) {
                    console.error('Error loading forecast data:', error);
                    forecastData = null;
                }
            }
            return forecastData;
        }

        async function loadForecast() {
            const forecastContent = document.getElementById('forecast-content');
            const chartCanvas = document.getElementById('forecast-chart');

            // Check if All India is selected - show message to select a state
            const selectedState = document.getElementById('forecast-state-select').value;
            if (selectedState === 'all') {
                forecastContent.innerHTML = '<p style="text-align: center; color: var(--shram-teal); font-size: 1.1rem; padding: 2rem;"><i class="fas fa-map-marker-alt"></i> Please select a state to view the forecast</p>';
                // Clear chart
                if (forecastChart) {
                    forecastChart.destroy();
                    forecastChart = null;
                }
                return;
            }

            forecastContent.innerHTML = '<p style="text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i> Loading forecast...</p>';

            try {
                // Load pre-computed forecast data
                const data = await loadForecastData();
                if (!data) {
                    throw new Error('Forecast data not available');
                }

                // Get current MET and shade settings
                const met = currentMetForecast || 6;
                const sunCondition = shadeStates.forecast ? 'shade' : 'sun';
                const days = Math.min(forecastDays, 3);

                // Get selected state and district
                const selectedDistrict = document.getElementById('forecast-district-select').value;

                // Find forecast for the selected location
                let locationForecast = null;
                let locationName = '';

                const stateData = data.states[selectedState];
                if (!stateData) {
                    throw new Error(`No forecast data for ${selectedState}`);
                }

                if (selectedDistrict && selectedDistrict !== '' && stateData.districts[selectedDistrict]) {
                    locationForecast = stateData.districts[selectedDistrict].forecast;
                    locationName = `${selectedDistrict.replace(/_/g, ' ')}, ${selectedState.replace(/_/g, ' ')}`;
                } else if (stateData.capital) {
                    locationForecast = stateData.capital.forecast;
                    locationName = `${stateData.capital.name}, ${selectedState.replace(/_/g, ' ')}`;
                } else {
                    // Use first available district
                    const firstDistrict = Object.keys(stateData.districts)[0];
                    if (firstDistrict) {
                        locationForecast = stateData.districts[firstDistrict].forecast;
                        locationName = `${firstDistrict.replace(/_/g, ' ')}, ${selectedState.replace(/_/g, ' ')}`;
                    }
                }

                if (!locationForecast || locationForecast.length === 0) {
                    throw new Error('No forecast data for this location');
                }

                // Limit to requested number of days
                const forecast = locationForecast.slice(0, days);

                // Build chart data - every hour using pre-computed EHI zones
                const chartLabels = [];
                const chartData = [];
                const chartColors = [];
                const isDayLabel = []; // Track which indices are day labels (for bold styling)

                forecast.forEach((day, dayIndex) => {
                    const dateObj = new Date(day.date);
                    const dayName = dateObj.toLocaleDateString('en-IN', { weekday: 'short' });
                    const dateNum = dateObj.getDate();

                    // Show every hour (0-23)
                    day.hours.forEach((hourData, hour) => {
                        if (hourData && hourData.data) {
                            // Get pre-computed zone for selected MET and sun condition
                            const metData = hourData.data[`met${met}`];
                            const rawZone = metData ? metData[sunCondition].zone : 2;

                            // Map zones to simplified 5-level scale:
                            // Zone 1 -> 1 (Cold Stress), Zone 2,3 -> 2 (Comfortable), Zone 4 -> 3 (Caution), Zone 5 -> 4 (High Risk), Zone 6 -> 5 (Hazardous)
                            const zoneMap = { 1: 1, 2: 2, 3: 2, 4: 3, 5: 4, 6: 5 };
                            const rawZoneInt = Math.round(rawZone);
                            const zone = zoneMap[rawZoneInt] !== undefined ? zoneMap[rawZoneInt] : 2;

                            // Full day + date at midnight, just hours otherwise (every 3 hours)
                            let label;
                            let isDay = false;
                            if (hour === 0) {
                                // Full day name and date at midnight
                                const monthDay = dateObj.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                                label = `${dayName}, ${monthDay}`;
                                isDay = true;
                            } else if (hour % 3 === 0) {
                                // Show hours at 3, 6, 9, 12, 15, 18, 21
                                label = `${hour}:00`;
                            } else {
                                label = '';
                            }
                            chartLabels.push(label);
                            chartData.push(zone);
                            chartColors.push(getZoneColor(rawZoneInt)); // Keep original zone for color
                            isDayLabel.push(isDay);
                        }
                    });
                });

                // Create summary HTML with location and timestamp on same line
                let html = `<p style="margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                    <strong><i class="fas fa-map-marker-alt"></i> ${locationName}</strong>
                    ${data.metadata && data.metadata.generated_at_ist ? `<span style="font-size: 0.85rem; color: #666;"><i class="fas fa-clock"></i> Forecast generated: ${data.metadata.generated_at_ist}</span>` : ''}
                </p>`;

                // Add peak conditions summary
                html += `<div style="padding: 1rem; background: var(--gray-light); border-radius: 8px;">
                    <h4 style="margin-bottom: 0.5rem; color: var(--shram-teal);"><i class="fas fa-sun"></i> Peak Conditions</h4>`;

                forecast.forEach(day => {
                    const dateStr = new Date(day.date).toLocaleDateString('en-IN', {
                        weekday: 'short',
                        day: 'numeric',
                        month: 'short'
                    });
                    const maxTemp = day.day.maxtemp_c;
                    const minTemp = day.day.mintemp_c;
                    const avgHumidity = day.day.avghumidity;

                    // Find peak zone for the day using pre-computed data
                    let peakZone = 1;
                    day.hours.forEach(h => {
                        if (h && h.data) {
                            const metData = h.data[`met${met}`];
                            const z = metData ? metData[sunCondition].zone : 1;
                            if (z > peakZone) peakZone = z;
                        }
                    });

                    const peakColor = getZoneColor(peakZone);
                    // Display Zone 2/3 together since they can't be distinguished
                    const zoneLabel = (peakZone === 2 || peakZone === 3) ? 'Zone 2/3' : `Zone ${peakZone}`;

                    html += `<p style="margin: 0.5rem 0;">
                        <strong>${dateStr}:</strong> ${minTemp.toFixed(0)}°C - ${maxTemp.toFixed(0)}°C, ${avgHumidity}% RH
                        <span style="background: ${peakColor}; color: white; padding: 2px 8px; border-radius: 4px; margin-left: 0.5rem; font-size: 0.85rem;">Peak: ${zoneLabel}</span>
                    </p>`;
                });

                html += '</div>';

                forecastContent.innerHTML = html;

                // Create/update the chart
                const ctx = document.getElementById('forecast-chart').getContext('2d');

                if (forecastChart) {
                    forecastChart.destroy();
                }

                forecastChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: chartLabels,
                        isDayLabel: isDayLabel, // Custom property for styling
                        datasets: [{
                            label: 'EHI Zone',
                            data: chartData,
                            borderColor: '#2d637f',
                            backgroundColor: 'rgba(45, 99, 127, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            stepped: true,
                            pointRadius: 4,
                            pointBackgroundColor: chartColors,
                            pointBorderColor: chartColors,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const level = context.raw;
                                        const labels = { 1: 'Zone 1: Cold Stress', 2: 'Zone 2/3: Comfortable', 3: 'Zone 4: Caution', 4: 'Zone 5: High Risk', 5: 'Zone 6: HAZARDOUS' };
                                        return labels[level] || '';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: 0.5,
                                max: 5.5,
                                title: {
                                    display: true,
                                    text: 'Heat Stress Level',
                                    font: { weight: 'bold' }
                                },
                                ticks: {
                                    stepSize: 1,
                                    callback: function(value) {
                                        const v = Math.round(value);
                                        const labels = { 1: 'Cold Stress', 2: 'Comfortable', 3: 'Caution', 4: 'High Risk', 5: 'HAZARDOUS' };
                                        return labels[v] || '';
                                    }
                                },
                                grid: {
                                    color: function(context) {
                                        if (context.tick.value === 1) return 'rgba(33, 150, 243, 0.4)';
                                        if (context.tick.value === 3) return 'rgba(251, 192, 45, 0.4)';
                                        if (context.tick.value === 4) return 'rgba(245, 124, 0, 0.4)';
                                        if (context.tick.value === 5) return 'rgba(211, 47, 47, 0.4)';
                                        return 'rgba(0, 0, 0, 0.1)';
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time',
                                    font: { weight: 'bold' }
                                },
                                ticks: {
                                    maxRotation: 45,
                                    autoSkip: false,
                                    callback: function(value, index, ticks) {
                                        const label = this.getLabelForValue(value);
                                        return label || null;
                                    },
                                    font: function(context) {
                                        // Bold font for day labels (contain comma like "Sun, 26 Jan")
                                        // In Chart.js 4.x, context.tick.label contains the tick label
                                        const tickLabel = context.tick && context.tick.label;
                                        if (tickLabel && typeof tickLabel === 'string' && tickLabel.includes(',')) {
                                            return { size: 11, weight: 'bold' };
                                        }
                                        return { size: 9 };
                                    }
                                },
                                grid: {
                                    color: function(context) {
                                        // Bold line at midnight (day labels contain comma)
                                        const tickLabel = context.tick && context.tick.label;
                                        if (tickLabel && typeof tickLabel === 'string' && tickLabel.includes(',')) {
                                            return 'rgba(0, 0, 0, 0.5)';
                                        }
                                        return 'rgba(0, 0, 0, 0.05)';
                                    },
                                    lineWidth: function(context) {
                                        // Thicker line at midnight (day labels contain comma)
                                        const tickLabel = context.tick && context.tick.label;
                                        if (tickLabel && typeof tickLabel === 'string' && tickLabel.includes(',')) {
                                            return 2;
                                        }
                                        return 1;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading forecast:', error);
                forecastContent.innerHTML = `<p style="color: #666; text-align: center;">
                    <i class="fas fa-exclamation-triangle" style="color: #f57c00;"></i>
                    Unable to load forecast data.<br>
                    <small>${error.message || 'Please try again later.'}</small>
                </p>`;
            }
        }

        async function load24HourData() {
            try {
                // Try local file first, then fall back to GitHub Pages
                let response;
                try {
                    response = await fetch('weather_logs/alerts_24h.json');
                    if (!response.ok) throw new Error('Local file not found');
                } catch (e) {
                    response = await fetch('https://iecc-io.github.io/ehi-n-dashboard/weather_logs/alerts_24h.json');
                }
                const data = await response.json();

                // Store globally for historical data lookups (used by filterCurrentStatus for unavailable locations)
                all24HourData = data;

                // Get selected state and district
                const selectedState = document.getElementById('charts-state-select').value;
                const selectedDistrict = document.getElementById('charts-district-select').value;

                // Get current MET level and map to actual column names in JSON
                const met = currentMetLast24h || 6;
                // Map MET levels to actual column names in alerts_24h.json
                // Currently data only has: "Light Work Heat Stress Zone" (MET 3) and "Hard Labor Heat Stress Zone" (MET 6)
                const zoneColMap = {
                    3: 'Light Work Heat Stress Zone',
                    4: 'Hard Labor Heat Stress Zone',  // fallback to MET 6 for MET 4
                    5: 'Hard Labor Heat Stress Zone',  // fallback to MET 6 for MET 5
                    6: 'Hard Labor Heat Stress Zone'
                };
                const zoneCol = zoneColMap[met] || 'Hard Labor Heat Stress Zone';

                const hourlySource = data.hourly_data || data.hourly_alerts;

                // Update timestamp for Last 24 Hours section (get most recent entry timestamp)
                if (hourlySource && hourlySource.length > 0) {
                    const latestTimestamp = hourlySource[hourlySource.length - 1].timestamp || data.timestamp || data.last_updated;
                    if (latestTimestamp) {
                        const timestamp = new Date(latestTimestamp).toLocaleString('en-IN', {
                            timeZone: 'Asia/Calcutta',
                            dateStyle: 'medium',
                            timeStyle: 'short'
                        });
                        document.getElementById('last24h-timestamp').innerHTML = `<strong>Last Updated: ${timestamp} IST</strong>`;
                    }
                }
                if (!hourlySource || hourlySource.length === 0) {
                    createPlaceholderCharts();
                    return;
                }

                const labels = [];
                const zone6Data = [], zone5Data = [], zone4Data = [], zone23Data = [], zone1Data = [];
                const tempData = [], rhData = [];

                // Helper to normalize state/district names for comparison (handles UPPERCASE_UNDERSCORED vs Title Case)
                const normalizeForComparison = (str) => str ? str.toLowerCase().replace(/_/g, ' ') : '';

                hourlySource.forEach(entry => {
                    // Use stations (all data) instead of alerts (filtered)
                    let stations = entry.stations || entry.alerts || [];

                    // Filter by selected state and district (handle format differences)
                    if (selectedState !== 'all') {
                        const normalizedSelected = normalizeForComparison(selectedState);
                        stations = stations.filter(s => normalizeForComparison(s.STATE) === normalizedSelected);
                    }
                    if (selectedDistrict !== 'all') {
                        const normalizedSelected = normalizeForComparison(selectedDistrict);
                        stations = stations.filter(s => normalizeForComparison(s.DISTRICT) === normalizedSelected);
                    }

                    const time = new Date(entry.timestamp);
                    labels.push(time.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Calcutta' }));

                    // Count zones using dynamic column based on selected MET/sun
                    zone6Data.push(stations.filter(s => s[zoneCol] === "Zone 6").length);
                    zone5Data.push(stations.filter(s => s[zoneCol] === "Zone 5").length);
                    zone4Data.push(stations.filter(s => s[zoneCol] === "Zone 4").length);
                    // Combine Zone 2 and Zone 3 into "Comfortable"
                    zone23Data.push(stations.filter(s => s[zoneCol] === "Zone 3" || s[zoneCol] === "Zone 2").length);
                    zone1Data.push(stations.filter(s => s[zoneCol] === "Zone 1").length);

                    if (stations.length > 0) {
                        tempData.push((stations.reduce((sum, s) => sum + parseFloat(s.TEMP || 0), 0) / stations.length).toFixed(1));
                        rhData.push((stations.reduce((sum, s) => sum + parseFloat(s.RH || 0), 0) / stations.length).toFixed(1));
                    } else {
                        tempData.push(null);
                        rhData.push(null);
                    }
                });

                const ctxAlert = document.getElementById('alertTrendChart').getContext('2d');
                if (alertTrendChart) alertTrendChart.destroy();
                alertTrendChart = new Chart(ctxAlert, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Zone 6 (Hazardous)', data: zone6Data, borderColor: '#d32f2f', backgroundColor: 'rgba(211, 47, 47, 0.1)', fill: true },
                            { label: 'Zone 5 (High Risk)', data: zone5Data, borderColor: '#f57c00', backgroundColor: 'rgba(245, 124, 0, 0.1)', fill: true },
                            { label: 'Zone 4 (Caution)', data: zone4Data, borderColor: '#fbc02d', backgroundColor: 'rgba(251, 192, 45, 0.1)', fill: true },
                            { label: 'Zone 2-3 (Comfortable)', data: zone23Data, borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.1)', fill: true },
                            { label: 'Zone 1 (Cold)', data: zone1Data, borderColor: '#03a9f4', backgroundColor: 'rgba(3, 169, 244, 0.1)', fill: true }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Number of Locations' } },
                            x: { title: { display: true, text: 'Time (IST)' } }
                        }
                    }
                });

                const ctxTemp = document.getElementById('tempHumidityChart').getContext('2d');
                if (tempHumidityChart) tempHumidityChart.destroy();
                tempHumidityChart = new Chart(ctxTemp, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Temperature (°C)', data: tempData, borderColor: '#d32f2f', yAxisID: 'y', fill: false },
                            { label: 'Relative Humidity (%)', data: rhData, borderColor: '#1976d2', yAxisID: 'y1', fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { position: 'top' } },
                        scales: {
                            y: { type: 'linear', position: 'left', title: { display: true, text: 'Temperature (°C)' } },
                            y1: { type: 'linear', position: 'right', title: { display: true, text: 'Humidity (%)' }, grid: { drawOnChartArea: false } },
                            x: { title: { display: true, text: 'Time (IST)' } }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading 24-hour data:', error);
                createPlaceholderCharts();
            }
        }

        function createPlaceholderCharts() {
            // Create sample data for demonstration
            const hours = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
            const sampleZone6 = Array.from({length: 24}, () => Math.floor(Math.random() * 15));
            const sampleZone5 = Array.from({length: 24}, () => Math.floor(Math.random() * 25));
            const sampleZone4 = Array.from({length: 24}, () => Math.floor(Math.random() * 40));
            const sampleZone3 = Array.from({length: 24}, () => Math.floor(Math.random() * 50));
            const sampleZone2 = Array.from({length: 24}, () => Math.floor(Math.random() * 30));
            const sampleZone1 = Array.from({length: 24}, () => Math.floor(Math.random() * 10));
            const sampleTemp = Array.from({length: 24}, (_, i) => 25 + Math.sin(i/24*Math.PI*2) * 10);
            const sampleRH = Array.from({length: 24}, (_, i) => 60 - Math.sin(i/24*Math.PI*2) * 20);

            const ctxAlert = document.getElementById('alertTrendChart').getContext('2d');
            if (alertTrendChart) alertTrendChart.destroy();
            alertTrendChart = new Chart(ctxAlert, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        { label: 'Zone 6 (Hazardous)', data: sampleZone6, borderColor: '#d32f2f', backgroundColor: 'rgba(211, 47, 47, 0.1)', fill: true },
                        { label: 'Zone 5 (High Risk)', data: sampleZone5, borderColor: '#f57c00', backgroundColor: 'rgba(245, 124, 0, 0.1)', fill: true },
                        { label: 'Zone 4 (Caution)', data: sampleZone4, borderColor: '#fbc02d', backgroundColor: 'rgba(251, 192, 45, 0.1)', fill: true },
                        { label: 'Zone 3 (Comfortable)', data: sampleZone3, borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.1)', fill: true },
                        { label: 'Zone 2 (Comfortable)', data: sampleZone2, borderColor: '#8bc34a', backgroundColor: 'rgba(139, 195, 74, 0.1)', fill: true },
                        { label: 'Zone 1 (Cold)', data: sampleZone1, borderColor: '#03a9f4', backgroundColor: 'rgba(3, 169, 244, 0.1)', fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Sample Data - Actual data will load when available' }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Number of Locations' } },
                        x: { title: { display: true, text: 'Time (IST)' } }
                    }
                }
            });

            const ctxTemp = document.getElementById('tempHumidityChart').getContext('2d');
            if (tempHumidityChart) tempHumidityChart.destroy();
            tempHumidityChart = new Chart(ctxTemp, {
                type: 'line',
                data: {
                    labels: hours,
                    datasets: [
                        { label: 'Temperature (°C)', data: sampleTemp, borderColor: '#d32f2f', yAxisID: 'y', fill: false },
                        { label: 'Relative Humidity (%)', data: sampleRH, borderColor: '#1976d2', yAxisID: 'y1', fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Sample Data - Actual data will load when available' }
                    },
                    scales: {
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'Temperature (°C)' } },
                        y1: { type: 'linear', position: 'right', title: { display: true, text: 'Humidity (%)' }, grid: { drawOnChartArea: false } },
                        x: { title: { display: true, text: 'Time (IST)' } }
                    }
                }
            });
        }

        async function loadSummerStats() {
            try {
                // Try local file first, then fall back to GitHub Pages
                let response;
                try {
                    response = await fetch('weather_logs/summer_stats.json');
                    if (!response.ok) throw new Error('Local file not found');
                } catch (e) {
                    response = await fetch('https://iecc-io.github.io/ehi-n-dashboard/weather_logs/summer_stats.json');
                }
                const data = await response.json();

                // Check if summer data is available yet
                if (!data.hottest_location || data.total_alerts === 0) {
                    document.getElementById('summer-stats-content').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-calendar-alt" style="font-size: 2rem; margin-bottom: 1rem; color: #999;"></i>
                            <p style="font-size: 1.1rem;"><strong>Summer ${data.year} Statistics</strong></p>
                            <p>Data collection started: ${new Date(data.data_collection_started).toLocaleDateString('en-IN', { dateStyle: 'medium' })}</p>
                            <p style="margin-top: 0.5rem;">Summer statistics will be available once the season begins (June - September).</p>
                        </div>
                    `;
                    return;
                }

                // Parse dates as IST (data is already in IST, append +05:30 to prevent double conversion)
                const hottestDateIST = data.hottest_location.date.includes('+') ? data.hottest_location.date : data.hottest_location.date + '+05:30';
                const hottestDate = new Date(hottestDateIST).toLocaleString('en-IN', {
                    timeZone: 'Asia/Calcutta',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                }) + ' IST';

                const ehiDateIST = data.peak_ehi350_location.date.includes('+') ? data.peak_ehi350_location.date : data.peak_ehi350_location.date + '+05:30';
                const ehiDate = new Date(ehiDateIST).toLocaleString('en-IN', {
                    timeZone: 'Asia/Calcutta',
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                }) + ' IST';

                // Prepare tooltip content for zones
                const zone6TopState = data.zone_6_top_state || 'N/A';
                const zone6CommonTime = (data.zone_6_common_time || 'Afternoon (12-4 PM)') + ' IST';
                const zone5TopState = data.zone_5_top_state || 'N/A';
                const zone5CommonTime = (data.zone_5_common_time || 'Afternoon (12-4 PM)') + ' IST';

                let html = `
                    <div class="status-grid">
                        <div class="stat-box">
                            <div class="stat-number">${(data.total_alerts || 0).toLocaleString()}</div>
                            <div class="stat-label">Total Alerts (Summer ${data.year})</div>
                        </div>
                        <div class="stat-box hoverable" style="background: linear-gradient(135deg, #d32f2f 0%, #c62828 100%); cursor: pointer; border-color: #d32f2f;">
                            <div class="stat-number">${data.zone_6_events.toLocaleString()}</div>
                            <div class="stat-label">Zone 6 Hours</div>
                            <div class="zone-tooltip" style="border-color: #d32f2f;">
                                <h4 style="color: #d32f2f;"><i class="fas fa-exclamation-triangle"></i> Zone 6 Summer Statistics</h4>
                                <p><strong>Top State:</strong> ${zone6TopState.replace(/_/g, ' ')}</p>
                                <p><strong>Most Common Time:</strong> ${zone6CommonTime}</p>
                            </div>
                        </div>
                        <div class="stat-box hoverable" style="background: linear-gradient(135deg, #f57c00 0%, #ef6c00 100%); cursor: pointer; border-color: #f57c00;">
                            <div class="stat-number">${data.zone_5_events.toLocaleString()}</div>
                            <div class="stat-label">Zone 5 Hours</div>
                            <div class="zone-tooltip" style="border-color: #f57c00;">
                                <h4 style="color: #f57c00;"><i class="fas fa-heartbeat"></i> Zone 5 Summer Statistics</h4>
                                <p><strong>Top State:</strong> ${zone5TopState.replace(/_/g, ' ')}</p>
                                <p><strong>Most Common Time:</strong> ${zone5CommonTime}</p>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 2rem; background: var(--gray-light); padding: 1.5rem; border-radius: 8px;">
                        <h3 style="color: var(--danger-red); margin-bottom: 1rem;"><i class="fas fa-exclamation-circle"></i> Summer ${data.year} Peak Heat Events</h3>

                        <div style="background: white; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid var(--danger-red);">
                            <strong style="color: var(--danger-red); font-size: 1.1rem;">Hottest Location Recorded:</strong><br>
                            <span style="font-size: 1rem;">${data.hottest_location.station}, ${data.hottest_location.district}, ${data.hottest_location.state.replace(/_/g, ' ')}</span><br>
                            <span style="font-size: 1.3rem; font-weight: 700; color: var(--danger-red);">${data.peak_temp}°C</span>${data.hottest_location.rh ? ` at ${data.hottest_location.rh}% RH` : ''} on ${hottestDate}
                        </div>

                        <div style="background: white; padding: 1rem; border-radius: 6px; border-left: 4px solid var(--warning-orange);">
                            <strong style="color: var(--warning-orange); font-size: 1.1rem;">Highest EHI-6 Recorded:</strong><br>
                            <span style="font-size: 1rem;">${data.peak_ehi350_location.station}, ${data.peak_ehi350_location.district}, ${data.peak_ehi350_location.state.replace(/_/g, ' ')}</span><br>
                            <span style="font-size: 1.3rem; font-weight: 700; color: var(--warning-orange);">${data.peak_ehi350.toFixed(1)}°C EHI-6</span>${data.peak_ehi350_location.temp && data.peak_ehi350_location.rh ? ` (${data.peak_ehi350_location.temp}°C, ${data.peak_ehi350_location.rh}% RH)` : ''} on ${ehiDate}
                        </div>
                    </div>
                `;

                document.getElementById('summer-stats-content').innerHTML = html;
            } catch (error) {
                console.error('Error loading summer stats:', error);
                document.getElementById('summer-stats-content').innerHTML = '<p style="text-align: center; color: #666;">Summer statistics not available</p>';
            }
        }

        function showZone(zoneNum) {
            // Hide all zone content
            for (let i = 1; i <= 6; i++) {
                const content = document.getElementById(`zone-content-${i}`);
                const btn = document.getElementById(`zone-btn-${i}`);
                if (content) content.style.display = 'none';
                if (btn) {
                    // Reset button styles based on zone
                    if (i === 1) {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--shram-teal)';
                    } else if (i === 2 || i === 3) {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--iecc-brown)';
                    } else if (i === 4) {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--caution-yellow)';
                    } else if (i === 5) {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--warning-orange)';
                    } else {
                        btn.style.background = 'white';
                        btn.style.color = 'var(--danger-red)';
                    }
                }
            }

            // Show selected zone
            const selectedContent = document.getElementById(`zone-content-${zoneNum}`);
            const selectedBtn = document.getElementById(`zone-btn-${zoneNum}`);
            if (selectedContent) selectedContent.style.display = 'block';
            if (selectedBtn) {
                if (zoneNum === 1) {
                    selectedBtn.style.background = 'var(--shram-teal)';
                    selectedBtn.style.color = 'white';
                } else if (zoneNum === 2 || zoneNum === 3) {
                    selectedBtn.style.background = 'var(--iecc-brown)';
                    selectedBtn.style.color = 'white';
                } else if (zoneNum === 4) {
                    selectedBtn.style.background = 'var(--caution-yellow)';
                    selectedBtn.style.color = 'white';
                } else if (zoneNum === 5) {
                    selectedBtn.style.background = 'var(--warning-orange)';
                    selectedBtn.style.color = 'white';
                } else {
                    selectedBtn.style.background = 'var(--danger-red)';
                    selectedBtn.style.color = 'white';
                }
            }
        }

        // Alert subscription functions
        function updateSubscriberDistricts() {
            const stateSelect = document.getElementById('subscriber-state');
            const districtSelect = document.getElementById('subscriber-district');
            const selectedState = stateSelect.value;

            if (!allAlertsData || selectedState === '') {
                districtSelect.innerHTML = '<option value="">Select District</option>';
                return;
            }

            const districts = [...new Set(
                allAlertsData.alerts
                    .filter(a => a.STATE === selectedState)
                    .map(a => a.DISTRICT)
            )].sort();

            districtSelect.innerHTML = '<option value="">Select District</option>';
            districts.forEach(district => {
                districtSelect.innerHTML += `<option value="${district}" class="available">${district.replace(/_/g, ' ')}</option>`;
            });
        }

        function populateSubscriberStates() {
            if (!allAlertsData) return;

            const states = [...new Set(allAlertsData.alerts.map(a => a.STATE))].sort();
            const subscriberStateSelect = document.getElementById('subscriber-state');

            subscriberStateSelect.innerHTML = '<option value="">Select State</option>';
            states.forEach(state => {
                subscriberStateSelect.innerHTML += `<option value="${state}" class="available">${state.replace(/_/g, ' ')}</option>`;
            });
        }

        // Handle form submission
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for messages from Live Map iframe (click-to-forecast)
            window.addEventListener('message', async function(event) {
                if (event.data && event.data.type === 'navigateToForecast') {
                    const stateName = event.data.state;
                    const clickLat = event.data.lat;
                    const clickLon = event.data.lon;

                    // Switch to Dashboard tab
                    const dashboardTab = document.querySelector('.tab[onclick*="dashboard"]');
                    if (dashboardTab) {
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.getElementById('dashboard-tab').classList.add('active');
                        dashboardTab.classList.add('active');
                    }
                    // Switch to Forecast section within Dashboard
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    const forecastBtn = document.querySelector('.nav-btn[onclick*="forecast"]');
                    if (forecastBtn) forecastBtn.classList.add('active');
                    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
                    const forecastSection = document.getElementById('forecast-section');
                    if (forecastSection) forecastSection.classList.add('active');

                    // Select the state and find nearest district
                    if (window.indiaDistrictsData && window.indiaDistrictsData.states[stateName]) {
                        // Call zoomToState and wait for it to complete
                        await zoomToState(stateName);

                        // If we have lat/lon, find and select the nearest district
                        if (clickLat && clickLon) {
                            const stateData = window.indiaDistrictsData.states[stateName];
                            let nearestDistrict = null;
                            let minDistance = Infinity;

                            // Check all districts in the state
                            for (const [districtName, districtData] of Object.entries(stateData.districts || {})) {
                                if (districtData.lat && districtData.lon) {
                                    // Simple Euclidean distance (good enough for nearby points)
                                    const dist = Math.sqrt(
                                        Math.pow(districtData.lat - clickLat, 2) +
                                        Math.pow(districtData.lon - clickLon, 2)
                                    );
                                    if (dist < minDistance) {
                                        minDistance = dist;
                                        nearestDistrict = districtName;
                                    }
                                }
                            }

                            // Select the nearest district if found
                            if (nearestDistrict && stateData.districts[nearestDistrict]) {
                                const districtData = stateData.districts[nearestDistrict];
                                // Update selectedDistrictCoords to override the capital
                                selectedDistrictCoords = {
                                    name: nearestDistrict,
                                    lat: districtData.lat,
                                    lon: districtData.lon
                                };
                                // Update UI label
                                const label = document.getElementById('selected-location-label');
                                if (label) {
                                    label.textContent = `Selected: ${nearestDistrict.replace(/_/g, ' ')}`;
                                }
                                // Highlight the district on the map if layer exists
                                if (districtLayer) {
                                    districtLayer.eachLayer(layer => {
                                        if (layer.feature && layer.feature.properties.name === nearestDistrict) {
                                            layer.setStyle({ fillColor: '#8B5A2B', fillOpacity: 0.6 });
                                        } else {
                                            layer.setStyle({ fillColor: '#2d637f', fillOpacity: 0.3 });
                                        }
                                    });
                                }
                                // Load forecast for the nearest district
                                loadForecast();
                            }
                        }
                    }
                }
            });

            // Load 24h historical data first (needed for fallback when current data unavailable)
            load24HourData().then(() => {
                // Then load live data - it will use historical data for unavailable locations
                loadLiveData().then(() => {
                    // Populate subscriber dropdowns after data loads
                    populateSubscriberStates();
                });
            });
            // Load districts data and initialize forecast map
            loadIndiaDistrictsData().then(() => {
                initForecastMap();  // Initialize map with all states
            });
            loadSummerStats();

            // Handle subscription form
            const subscriptionForm = document.getElementById('alert-subscription-form');
            if (subscriptionForm) {
                subscriptionForm.addEventListener('submit', async function(e) {
                    e.preventDefault();

                    const messageDiv = document.getElementById('subscription-message');
                    const submitBtn = this.querySelector('button[type="submit"]');

                    // Collect form data
                    const formData = {
                        name: document.getElementById('subscriber-name').value,
                        email: document.getElementById('subscriber-email').value,
                        phone: document.getElementById('subscriber-phone').value,
                        state: document.getElementById('subscriber-state').value,
                        district: document.getElementById('subscriber-district').value,
                        zones: {
                            zone4: document.getElementById('alert-zone-4').checked,
                            zone5: document.getElementById('alert-zone-5').checked,
                            zone6: document.getElementById('alert-zone-6').checked
                        },
                        timestamp: new Date().toISOString()
                    };

                    // Validate at least one zone is selected
                    if (!formData.zones.zone4 && !formData.zones.zone5 && !formData.zones.zone6) {
                        messageDiv.style.display = 'block';
                        messageDiv.style.background = '#ffebee';
                        messageDiv.style.color = '#d32f2f';
                        messageDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> Please select at least one zone for alerts';
                        return;
                    }

                    // Disable submit button
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Subscribing...';

                    try {
                        // TODO: Replace with your actual backend endpoint
                        // For now, we'll show a success message and log the data
                        console.log('Subscription data:', formData);

                        // Simulate API call
                        await new Promise(resolve => setTimeout(resolve, 1000));

                        // Show success message
                        messageDiv.style.display = 'block';
                        messageDiv.style.background = '#e8f5e9';
                        messageDiv.style.color = '#2e7d32';
                        messageDiv.innerHTML = `
                            <i class="fas fa-check-circle"></i> Successfully subscribed!<br>
                            <small style="font-weight: 400;">You will receive alerts for ${document.getElementById('subscriber-state').options[document.getElementById('subscriber-state').selectedIndex].text}, ${document.getElementById('subscriber-district').options[document.getElementById('subscriber-district').selectedIndex].text}</small>
                        `;

                        // Reset form
                        subscriptionForm.reset();

                        // TODO: Send data to your backend
                        // Example with Google Forms or your API:
                        /*
                        const response = await fetch('YOUR_API_ENDPOINT', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formData)
                        });
                        */

                    } catch (error) {
                        console.error('Subscription error:', error);
                        messageDiv.style.display = 'block';
                        messageDiv.style.background = '#ffebee';
                        messageDiv.style.color = '#d32f2f';
                        messageDiv.innerHTML = '<i class="fas fa-exclamation-circle"></i> An error occurred. Please try again or contact us directly.';
                    } finally {
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-bell"></i> Subscribe to Alerts';
                    }
                });
            }
        });
    </script>
</body>
</html>
